<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sylvia Harmening">

<title>2&nbsp; The Univariate Fay-Herriot (UFH) model – EUPM: Poland</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./50-mfh.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-be286771588e14c8ad07271603d9d425.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./40-fh.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot (UFH) model</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">EUPM: Poland</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40-fh.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot (UFH) model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50-mfh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">2.1</span> Introduction</a></li>
  <li><a href="#data-and-preparation" id="toc-data-and-preparation" class="nav-link" data-scroll-target="#data-and-preparation"><span class="header-section-number">2.2</span> Data and preparation</a>
  <ul class="collapse">
  <li><a href="#load-the-dataset" id="toc-load-the-dataset" class="nav-link" data-scroll-target="#load-the-dataset"><span class="header-section-number">2.2.1</span> Load the dataset</a></li>
  <li><a href="#direct-estimation" id="toc-direct-estimation" class="nav-link" data-scroll-target="#direct-estimation"><span class="header-section-number">2.2.2</span> Direct estimation</a></li>
  <li><a href="#variance-smoothing" id="toc-variance-smoothing" class="nav-link" data-scroll-target="#variance-smoothing"><span class="header-section-number">2.2.3</span> Variance smoothing</a></li>
  </ul></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection"><span class="header-section-number">2.3</span> Model selection</a>
  <ul class="collapse">
  <li><a href="#model-preparation" id="toc-model-preparation" class="nav-link" data-scroll-target="#model-preparation"><span class="header-section-number">2.3.1</span> Model preparation</a></li>
  <li><a href="#check-multicollinearity" id="toc-check-multicollinearity" class="nav-link" data-scroll-target="#check-multicollinearity"><span class="header-section-number">2.3.2</span> Check multicollinearity</a></li>
  </ul></li>
  <li><a href="#model-estimation-of-fh-point-and-their-mse-estimates." id="toc-model-estimation-of-fh-point-and-their-mse-estimates." class="nav-link" data-scroll-target="#model-estimation-of-fh-point-and-their-mse-estimates."><span class="header-section-number">2.4</span> Model estimation of FH point and their MSE estimates.</a></li>
  <li><a href="#assessment-of-the-estimated-model." id="toc-assessment-of-the-estimated-model." class="nav-link" data-scroll-target="#assessment-of-the-estimated-model."><span class="header-section-number">2.5</span> Assessment of the estimated model.</a>
  <ul class="collapse">
  <li><a href="#diagnostic-plots" id="toc-diagnostic-plots" class="nav-link" data-scroll-target="#diagnostic-plots"><span class="header-section-number">2.5.1</span> Diagnostic plots</a></li>
  </ul></li>
  <li><a href="#comparison-of-the-fh-results-with-the-direct-estimates." id="toc-comparison-of-the-fh-results-with-the-direct-estimates." class="nav-link" data-scroll-target="#comparison-of-the-fh-results-with-the-direct-estimates."><span class="header-section-number">2.6</span> Comparison of the FH results with the direct estimates.</a></li>
  <li><a href="#benchmark-the-fh-point-estimates-for-consistency-with-higher-results." id="toc-benchmark-the-fh-point-estimates-for-consistency-with-higher-results." class="nav-link" data-scroll-target="#benchmark-the-fh-point-estimates-for-consistency-with-higher-results."><span class="header-section-number">2.7</span> Benchmark the FH point estimates for consistency with higher results.</a></li>
  <li><a href="#preparation-of-the-results." id="toc-preparation-of-the-results." class="nav-link" data-scroll-target="#preparation-of-the-results."><span class="header-section-number">2.8</span> Preparation of the results.</a>
  <ul class="collapse">
  <li><a href="#poverty-map" id="toc-poverty-map" class="nav-link" data-scroll-target="#poverty-map"><span class="header-section-number">2.8.1</span> Poverty map</a></li>
  </ul></li>
  <li><a href="#saving-the-results." id="toc-saving-the-results." class="nav-link" data-scroll-target="#saving-the-results."><span class="header-section-number">2.9</span> Saving the results.</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">2.10</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot (UFH) model</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sylvia Harmening </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">2.1</span> Introduction</h2>
<p>In this section, we will present a whole estimation procedure of the univariate area-level model introduced by <span class="citation" data-cites="Fay1979">Fay and Herriot (<a href="#ref-Fay1979" role="doc-biblioref">1979</a>)</span> in R. As with the disclaimer in the preceding section, this practical manual is not intended to serve as a theoretical introduction to area-level models. Instead, it offers a set of straightforward and practical R scripts, accompanied by clear explanations, to demonstrate how these tasks can be carried out in R. For a theoretical foundation please refer to <span class="citation" data-cites="Fay1979">Fay and Herriot (<a href="#ref-Fay1979" role="doc-biblioref">1979</a>)</span> and <span class="citation" data-cites="RaoMolina2015">Rao and Molina (<a href="#ref-RaoMolina2015" role="doc-biblioref">2015</a>)</span>. In addition to theoretical information, the vignette “A framework for producing small area estimates based on area-level models in R” of the R package <code>emdi</code> <span class="citation" data-cites="Harmening2023">(<a href="#ref-Harmening2023" role="doc-biblioref">Harmening et al. 2023</a>)</span> provides further code examples for the FH model.</p>
<p>In this chapter, we will describe how to run the univariate Fay-Herriot (FH) using simulated income data from Spain. The estimation procedure is explained step by step.</p>
<p>Step 1: Data preparation. Compute the direct estimates and their corresponding variances on the area-level and eventually perform variance smoothing. Aggregate the available auxiliary variables to the same area level and combine both input data.</p>
<p>Step 2: Model selection. Select the aggregated auxiliary variables at the area level for the FH model using a stepwise selection based on information criteria like the Akaike, Bayesian or Kullback information criteria.</p>
<p>Step 3: Model estimation of FH point estimates and their mean squared error (MSE) estimates as uncertainty measure. Eventually apply a transformation.</p>
<p>Step 4: Assessment of the estimated model. Check the FH model assumptions, including linearity, normality of predicted area effects and standardized model residuals. When violations of the model assumptions are detected, the application of a transformation might help. Repeat Step 3 including a transformation and check again the model assumptions.</p>
<p>Step 5: Comparison of the FH results with the direct estimates.</p>
<p>Step 6: Benchmark the FH point estimates for consistency with higher results.</p>
<p>Step 7: Preparation of the results. Create tables and maps of results.</p>
<p>Step 8: Saving the results. One option is to export the results to known formats like Excel or OpenDocument Spreadsheets.</p>
<p>We will show below the use of the <code>fh()</code> function of the R package <code>emdi</code> <span class="citation" data-cites="Harmening2023">(<a href="#ref-Harmening2023" role="doc-biblioref">Harmening et al. 2023</a>)</span> which computes the EBLUPs and their MSE estimates of the standard FH model and several extensions of it, among others it allows for the application of transformations. Because the poverty rate is a ratio, it might be helpful to apply the arcsin transformation to guarantee that the results lie between 0 and 1. The function call is:</p>
<p><code>fh(fixed, vardir, combined_data, domains = NULL, method = "reml", interval = NULL,   k = 1.345, mult_constant = 1, transformation = "no", backtransformation = NULL,   eff_smpsize = NULL, correlation = "no", corMatrix = NULL, Ci = NULL, tol = 1e-04,   maxit = 100, MSE = FALSE, mse_type = "analytical", B = c(50, 0), seed = 123)</code></p>
</section>
<section id="data-and-preparation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="data-and-preparation"><span class="header-section-number">2.2</span> Data and preparation</h2>
<section id="load-the-dataset" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="load-the-dataset"><span class="header-section-number">2.2.1</span> Load the dataset</h3>
<p>Usually, SAE combines multiple data sources: a survey data set and a census or administrative/register dataset. For the estimation of area-level models, we need area-level aggregates of the same area-level (e.g.&nbsp;NUTS3) of both datasets. The target variable (typically household welfare/income for poverty mapping) is available in the survey but not in the census data.</p>
<p>In this example, we use a synthetic data set adapted from R package <code>sae</code> called <code>incomedata</code>. The original data contains information for <span class="math inline">\(n = 17,119\)</span> fictitious individuals residing across <span class="math inline">\(D = 52\)</span> Spanish provinces. The variables include the name of the province of residence (<code>provlab</code>), province code (<code>prov</code>), as well as several correlates of income.</p>
<p>For this exercise, we use a random 10% sample of the <code>incomedata</code> to estimate the poverty rates. For the univariate case, we use the income variable from 2012.</p>
<p>The FH estimation process relies on 3 types of data:</p>
<ol type="1">
<li><p>The data containing the outcome variable from which direct estimates will be computed. This is a usually a survey dataset for each year of data including outcome variable (such as income or welfare aggregates), weights, cluster identifiers (i.e.&nbsp;if available, psu or enumeration areas) at the unit level i.e.&nbsp;individual or household. In this example, we call this: <code>survey_dt</code>.</p></li>
<li><p>A dataset containing for the right hand side (RHS) variables i.e.&nbsp;indicator estimates representative at the level of the target area. This is often obtained from administrative data sources or geospatial data such as remotely sensed high resolution data. The final RHS dataset ought to include an area id and variables of interest. In this example, we call this <code>rhs_dt</code>.</p></li>
<li><p>Finally, a shapefile which spatially links each target area to their boundaries on a map. This will contain the area id as well as the geometry object which when visualized will show the shape of the areas in which poverty rates will be estimated. In this example, we call this <code>shp_dt</code>.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">### lets read in our 3 aforementioned datasets </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  bd_clean <span class="sc">|&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_read</span>(<span class="st">"pov_direct"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="ot">&lt;-</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  bd_clean <span class="sc">|&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_read</span>(<span class="st">"sae_data"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="ot">&lt;-</span> </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  bd_clean <span class="sc">|&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_read</span>(<span class="st">"geometries"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is what our datasets look like. These are generally the variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 12,894
Columns: 7
$ provlab &lt;fct&gt; Alava, Alava, Alava, Alava, Alava, Alava, Alava, Alava, Alava,…
$ prov    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ weight  &lt;dbl&gt; 25977.699, 25977.699, 25977.699, 19471.566, 19471.566, 19471.5…
$ ea_id   &lt;int&gt; 101, 101, 101, 102, 102, 102, 103, 103, 103, 103, 103, 103, 10…
$ year    &lt;int&gt; 2012, 2013, 2014, 2012, 2013, 2014, 2012, 2012, 2012, 2012, 20…
$ income  &lt;dbl&gt; 5150.399, 5204.872, 5480.116, 27920.737, 28508.978, 31512.153,…
$ povline &lt;dbl&gt; 6477.484, 6515.865, 6515.865, 6477.484, 6515.865, 6515.865, 64…</code></pre>
</div>
</div>
<p><code>survey_dt</code> contains our target area identifiers (<code>provlab</code>, <code>prov</code>), the weight variable <code>weight</code>, the cluster id i.e.&nbsp;enumeration area or psu, <code>ea_id</code>, the year, <code>year</code>, the income variable <code>income</code> and the poverty line <code>poverty</code>. In this example, <code>survey_dt</code> of class <code>data.frame</code> is at the level of the individual. It could also be at the level of the household if poverty lines are evaluated at that level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 156
Columns: 39
Groups: prov [52]
$ prov           &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, …
$ provlab        &lt;fct&gt; Alava, Albacete, Alicante, Almeria, Avila, Badajoz, Bal…
$ gen            &lt;dbl&gt; 1.591661, 1.512574, 1.531217, 1.379440, 1.469752, 1.412…
$ age2           &lt;dbl&gt; 0.10662920, 0.15809756, 0.09547348, 0.16773730, 0.00000…
$ age3           &lt;dbl&gt; 0.3874807, 0.4944282, 0.3547117, 0.4673372, 0.4989752, …
$ age4           &lt;dbl&gt; 0.245845529, 0.059850454, 0.174966688, 0.005694235, 0.1…
$ age5           &lt;dbl&gt; 0.19980439, 0.18429053, 0.23276281, 0.18630876, 0.27121…
$ educ1          &lt;dbl&gt; 0.21756579, 0.22430208, 0.38687301, 0.34254113, 0.40534…
$ educ2          &lt;dbl&gt; 0.2353839, 0.4386757, 0.3915053, 0.3840035, 0.3181650, …
$ educ3          &lt;dbl&gt; 0.32395951, 0.10794670, 0.07260912, 0.10053284, 0.20833…
$ nat1           &lt;dbl&gt; 0.9653883, 0.9837955, 0.9436051, 0.8789277, 1.0000000, …
$ labor1         &lt;dbl&gt; 0.3692168, 0.4513452, 0.4054253, 0.5191851, 0.4992434, …
$ labor2         &lt;dbl&gt; 0.000000000, 0.036094381, 0.047285012, 0.040264017, 0.0…
$ labor3         &lt;dbl&gt; 0.4076923, 0.2834849, 0.3982771, 0.2676284, 0.4326099, …
$ abs            &lt;dbl&gt; 0.84933922, -0.97816135, 0.98863150, 0.31350535, -1.419…
$ ntl            &lt;dbl&gt; 0.2091905, 1.1589425, -0.4210840, 1.5472493, -2.1440414…
$ aec            &lt;dbl&gt; 1.16518757, -0.55990121, -0.66408247, -0.70557145, 4.99…
$ schyrs         &lt;dbl&gt; 1.70993214, -0.96018920, -0.18004563, 0.22504016, -1.64…
$ mkt            &lt;dbl&gt; 2.5782541, -1.0468569, -0.2044435, -0.9811182, -1.08118…
$ age2_X_gen     &lt;dbl&gt; 0.15555592, 0.26628138, 0.15033171, 0.21079949, 0.00000…
$ age3_X_gen     &lt;dbl&gt; 0.6647560, 0.7222008, 0.5516074, 0.6262462, 0.7645003, …
$ age4_X_gen     &lt;dbl&gt; 0.36008687, 0.10298379, 0.26866795, 0.01138847, 0.26583…
$ age5_X_gen     &lt;dbl&gt; 0.35102165, 0.30664168, 0.35115346, 0.28723752, 0.37126…
$ educ1_X_gen    &lt;dbl&gt; 0.3687830, 0.3682332, 0.5879137, 0.5256249, 0.6863470, …
$ educ2_X_gen    &lt;dbl&gt; 0.4130652, 0.7220561, 0.6010236, 0.4517964, 0.4494350, …
$ educ3_X_gen    &lt;dbl&gt; 0.53779476, 0.16167700, 0.12157537, 0.15825036, 0.26582…
$ nat1_X_gen     &lt;dbl&gt; 1.557049, 1.480165, 1.453477, 1.206699, 1.469752, 1.376…
$ labor1_X_gen   &lt;dbl&gt; 0.6529375, 0.6858805, 0.5812196, 0.6455309, 0.7541068, …
$ labor2_X_gen   &lt;dbl&gt; 0.000000000, 0.072188761, 0.086971286, 0.040264017, 0.0…
$ labor3_X_gen   &lt;dbl&gt; 0.6667055, 0.4938971, 0.6423218, 0.4498768, 0.6474986, …
$ age2_X_educ3   &lt;dbl&gt; 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.0…
$ age3_X_educ3   &lt;dbl&gt; 0.18883381, 0.05231836, 0.02345535, 0.10053284, 0.00000…
$ age4_X_educ3   &lt;dbl&gt; 0.110497526, 0.036933029, 0.025056921, 0.000000000, 0.1…
$ age5_X_educ3   &lt;dbl&gt; 0.024628173, 0.018695319, 0.024096847, 0.000000000, 0.0…
$ nat1_X_educ3   &lt;dbl&gt; 0.32395951, 0.10794670, 0.06702616, 0.06418623, 0.20833…
$ labor1_X_educ3 &lt;dbl&gt; 0.274032897, 0.052318355, 0.036012387, 0.100532844, 0.1…
$ labor2_X_educ3 &lt;dbl&gt; 0.000000000, 0.000000000, 0.006859625, 0.000000000, 0.0…
$ labor3_X_educ3 &lt;dbl&gt; 0.049926612, 0.055628348, 0.029737105, 0.000000000, 0.0…
$ year           &lt;int&gt; 2012, 2012, 2012, 2012, 2012, 2012, 2012, 2012, 2012, 2…</code></pre>
</div>
</div>
<p>`<code>rhs_dt</code> is an object of class <code>data.frame</code> created at the level of the target area. It should contain the same target area identifiers as in <code>survey_dt</code> and the year variable <code>year</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 52
Columns: 3
$ prov     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…
$ provlab  &lt;fct&gt; Alava, Albacete, Alicante, Almeria, Avila, Badajoz, Baleares,…
$ geometry &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-2.858067 4..., MULTIPOLYGON (((…</code></pre>
</div>
</div>
<p><code>shp_dt</code> is an object of class <code>sf</code>, <code>data.frame</code> created at the level of the target area. This is the shapefile for the area of interest for which the poverty map will be estimated. It should contain the same target area ID found in <code>survey_dt</code> as well as <code>rhs_dt</code>.</p>
<p>A quick summary table on the data needs for the UFH model:</p>
<div class="cell">
<div class="cell-output-display">
<div id="aieutorhxq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#aieutorhxq table {
  font-family: Arial;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#aieutorhxq thead, #aieutorhxq tbody, #aieutorhxq tfoot, #aieutorhxq tr, #aieutorhxq td, #aieutorhxq th {
  border-style: none;
}

#aieutorhxq p {
  margin: 0;
  padding: 0;
}

#aieutorhxq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 12px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#aieutorhxq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#aieutorhxq .gt_title {
  color: #333333;
  font-size: 16px;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#aieutorhxq .gt_subtitle {
  color: #333333;
  font-size: 12px;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#aieutorhxq .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#aieutorhxq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#aieutorhxq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#aieutorhxq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#aieutorhxq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#aieutorhxq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#aieutorhxq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#aieutorhxq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#aieutorhxq .gt_spanner_row {
  border-bottom-style: hidden;
}

#aieutorhxq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#aieutorhxq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#aieutorhxq .gt_from_md > :first-child {
  margin-top: 0;
}

#aieutorhxq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#aieutorhxq .gt_row {
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#aieutorhxq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#aieutorhxq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#aieutorhxq .gt_row_group_first td {
  border-top-width: 2px;
}

#aieutorhxq .gt_row_group_first th {
  border-top-width: 2px;
}

#aieutorhxq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#aieutorhxq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#aieutorhxq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#aieutorhxq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#aieutorhxq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#aieutorhxq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#aieutorhxq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#aieutorhxq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#aieutorhxq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#aieutorhxq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#aieutorhxq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#aieutorhxq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#aieutorhxq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#aieutorhxq .gt_left {
  text-align: left;
}

#aieutorhxq .gt_center {
  text-align: center;
}

#aieutorhxq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#aieutorhxq .gt_font_normal {
  font-weight: normal;
}

#aieutorhxq .gt_font_bold {
  font-weight: bold;
}

#aieutorhxq .gt_font_italic {
  font-style: italic;
}

#aieutorhxq .gt_super {
  font-size: 65%;
}

#aieutorhxq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#aieutorhxq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#aieutorhxq .gt_indent_1 {
  text-indent: 5px;
}

#aieutorhxq .gt_indent_2 {
  text-indent: 10px;
}

#aieutorhxq .gt_indent_3 {
  text-indent: 15px;
}

#aieutorhxq .gt_indent_4 {
  text-indent: 20px;
}

#aieutorhxq .gt_indent_5 {
  text-indent: 25px;
}

#aieutorhxq .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#aieutorhxq div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_heading header">
<th colspan="3" class="gt_heading gt_title gt_font_normal"><strong>Data Input Checklist for the Univariate Fay-Herriot Model</strong></th>
</tr>
<tr class="gt_heading even">
<th colspan="3" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border"><em>Datasets, levels, and Required variables</em></th>
</tr>
<tr class="gt_col_headings header">
<th id="Dataset" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Dataset Name</th>
<th id="Unit-of-Observation" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Unit of Observation</th>
<th id="Required-Variables" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Required Variables</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Dataset"><code>survey_dt</code></td>
<td class="gt_row gt_left" headers="Unit of Observation">Individual (or Household)</td>
<td class="gt_row gt_left" headers="Required Variables"><code>target area identifiers</code>, <code>weights</code>, <code>cluster identifier</code>, <code>income/welfare variable</code>, <code>poverty line</code></td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Dataset"><code>rhs_dt</code></td>
<td class="gt_row gt_left" headers="Unit of Observation">Target Area (e.g.&nbsp;Province)</td>
<td class="gt_row gt_left" headers="Required Variables"><code>target area identifiers</code>, <code>covariates</code> (e.g.&nbsp;<code>gen</code>, <code>educ1</code>, <code>schyrs</code>, etc.)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Dataset"><code>shp_dt</code></td>
<td class="gt_row gt_left" headers="Unit of Observation">Target Area (Spatial)</td>
<td class="gt_row gt_left" headers="Required Variables"><code>target area identifiers</code>, <code>geometries</code> (e.g.&nbsp;<code>geometry</code> column from <code>sf</code>)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="direct-estimation" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="direct-estimation"><span class="header-section-number">2.2.2</span> Direct estimation</h3>
<p>We will use the direct Horvitz-Thompons estimators that use the survey weights in <code>weight</code> variable. We calculate the sample sizes for each provinces and compute the direct estimates and their variances. We use the <code>direct</code> function of the <code>emdi</code> package here. Other options are e.g.&nbsp;the <code>direct</code> function of package <code>sae</code> <span class="citation" data-cites="molina2015r">(<a href="#ref-molina2015r" role="doc-biblioref">Molina and Marhuenda 2015</a>)</span> or the <code>svyby</code> command of package <code>survey</code> <span class="citation" data-cites="Lumley2024">(<a href="#ref-Lumley2024" role="doc-biblioref">Lumley 2024</a>)</span>. Then, we create a dataframe containing the direct estimate, the standard errors, the variances, the coefficient of variation and the design effects, that are needed for the arcsin transformation. The design effect is the ratio of the variance considering the sampling design to the variance estimated under simple random sampling. For detailled information about the arcsin transformation please refer to <span class="citation" data-cites="Casas2016">Casas-Cordero, Encina, and Lahiri (<a href="#ref-Casas2016" role="doc-biblioref">2016</a>)</span> and <span class="citation" data-cites="Schmid2017">Schmid et al. (<a href="#ref-Schmid2017" role="doc-biblioref">2017</a>)</span>. In some areas with a very small sample size, it may occur, that the individual data only consists of zeros and ones, resulting in a direct estimate of zero or one and a direct variance of zero. We set those areas to out-of-sample and for the final estimation results only the synthetic part of the FH model is used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">### a little bit of housekeeping to ensure ease of access </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>area_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"prov"</span>, <span class="st">"provlab"</span>) <span class="do">### both variables are at the same level. If the levels vary, you would need to combine both variables for effect use</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>cluster_var <span class="ot">&lt;-</span> <span class="st">"ea_id"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>weight_var <span class="ot">&lt;-</span> <span class="st">"weight"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>year_var <span class="ot">&lt;-</span> <span class="st">"year"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>outcome_var <span class="ot">&lt;-</span> <span class="st">"income"</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>povline_var <span class="ot">&lt;-</span> <span class="st">"povline"</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(rhs_dt)[<span class="sc">!</span><span class="fu">colnames</span>(rhs_dt) <span class="sc">%in%</span> <span class="fu">c</span>(area_vars, year_var)]</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="do">## For the univariate model, we only use a single year (here 2012)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>singleyear <span class="ot">&lt;-</span> <span class="st">"2012"</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> singleyear)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="ot">&lt;-</span> rhs_dt <span class="sc">|&gt;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> singleyear)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate sample size for each province</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>sampsize_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="sc">|&gt;</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars[<span class="dv">1</span>])) <span class="sc">|&gt;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">N =</span> <span class="fu">n</span>())</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="do">## computation of direct estimates and their variances (the poverty line is already included within the data)</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="do">## creating the poverty indicator</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pov_indicator =</span> <span class="fu">ifelse</span>(income <span class="sc">&lt;</span> povline, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="do">### creating a survey object</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>design_obj <span class="ot">&lt;-</span> survey<span class="sc">::</span><span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="fu">eval</span>(<span class="fu">expr</span>(<span class="sc">~!!</span><span class="fu">sym</span>(cluster_var))), </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weights =</span> <span class="fu">eval</span>(<span class="fu">expr</span>(<span class="sc">~!!</span><span class="fu">sym</span>(weight_var))), </span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> survey_dt)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span> survey<span class="sc">::</span><span class="fu">svyby</span>(<span class="sc">~</span>pov_indicator, <span class="at">by=</span><span class="fu">eval</span>(<span class="fu">expr</span>(<span class="sc">~!!</span><span class="fu">sym</span>(area_vars[<span class="dv">1</span>]))), <span class="at">design =</span> design_obj, <span class="at">FUN =</span> survey<span class="sc">::</span>svymean)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  var_dt <span class="sc">|&gt;</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">direct_povrate =</span> <span class="st">"pov_indicator"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">SD =</span> <span class="st">"se"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">vardir =</span> SD<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CV =</span> SD <span class="sc">/</span> direct_povrate) <span class="sc">|&gt;</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(sampsize_dt, </span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_SRS =</span> direct_povrate <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> direct_povrate) <span class="sc">/</span> N) <span class="sc">|&gt;</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deff =</span> vardir <span class="sc">/</span> var_SRS) <span class="sc">|&gt;</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_eff =</span> N<span class="sc">/</span>deff)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="do">## set zero variance to OOS</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> direct_dt[<span class="fu">complete.cases</span>(direct_dt), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the results look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(direct_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  prov direct_povrate         SD       vardir        CV   N     var_SRS
1    1     0.24394059 0.09047786 0.0081862422 0.3709012  24 0.007684732
2    2     0.15913215 0.08113377 0.0065826888 0.5098515  43 0.003111840
3    3     0.16294054 0.02727481 0.0007439151 0.1673912 135 0.001010303
4    4     0.29656922 0.04988701 0.0024887140 0.1682137  50 0.004172318
5    5     0.09564252 0.05928951 0.0035152460 0.6199074  14 0.006178217
6    6     0.22733200 0.03849937 0.0014822014 0.1693531 124 0.001416550
       deff     n_eff
1 1.0652605  22.52970
2 2.1153688  20.32742
3 0.7363286 183.34206
4 0.5964823  83.82478
5 0.5689742  24.60568
6 1.0463462 118.50762</code></pre>
</div>
</div>
</section>
<section id="variance-smoothing" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="variance-smoothing"><span class="header-section-number">2.2.3</span> Variance smoothing</h3>
<p>A quick inspection of the preceding results will show some provinces contain low sample sizes which sometimes result in extreme value poverty rates and hence 0 variance. To avoid this, we will show you how to apply the variance smoothing method suggested by <span class="citation" data-cites="you2023application">You and Hidiroglou (<a href="#ref-you2023application" role="doc-biblioref">2023</a>)</span>. Please see the code and Roxygen comments below explaining the use of the <code>varsmoothie_king()</code> function which computes smoothed variances. In case, the arcsin transformation will be applied, the variance smoothing described here is not necessary, since the arcsin transformation works variance stabilizing itself. When applying the arcsin transformation, the direct variances are automatically set to 1/(4*effective sampling size) when using the <code>fh</code> function of package <code>emdi</code>. The effective sample size equals the sample size of each area divided by the design effect. If the variance stabilizing effect is not enough, the design effect of a higher area level could also be used here (in this example the regions <code>ac</code>).</p>
<p>The goal now is to use the <code>varsmoothie_king()</code> function to add an additional column of smoothed variances into our <code>direct_dt</code> dataframe. Required inputs: a vector of unique domains, the raw variances estimated from sample data and the sample size for each domain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>var_smooth <span class="ot">&lt;-</span> <span class="fu">varsmoothie_king</span>(<span class="at">domain =</span> direct_dt[[area_vars[<span class="dv">1</span>]]],</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">direct_var =</span> direct_dt<span class="sc">$</span>vardir,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sampsize =</span> direct_dt<span class="sc">$</span>N)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> var_smooth <span class="sc">|&gt;</span> <span class="fu">merge</span>(direct_dt, <span class="at">by.x =</span> <span class="st">"Domain"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.y =</span> area_vars[<span class="dv">1</span>])</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the variances that are zero with their smoothed counterparts</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  direct_dt <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"v_"</span>),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">abs</span>(.x) <span class="sc">&lt;=</span> <span class="fl">1e-4</span>, <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"vsv"</span>, <span class="fu">str_remove</span>(<span class="fu">cur_column</span>(), <span class="st">"^v"</span>))), .x),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.names =</span> <span class="st">"{.col}"</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thus far, we have careful set up the types of data we require for the FH model. We only need to combine the dataframe containing the direct estimates and their variances with the auxiliary variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fh_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(direct_dt, rhs_dt,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">"Domain"</span>, <span class="at">by.y =</span> area_vars[[<span class="dv">1</span>]],</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">all =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model-selection" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="model-selection"><span class="header-section-number">2.3</span> Model selection</h2>
<section id="model-preparation" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="model-preparation"><span class="header-section-number">2.3.1</span> Model preparation</h3>
<p>FH does not run if there is any missing value in the auxiliary variables, and therefore, any variable with missing value should be removed in advance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>rowsNAcovariates <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">sapply</span>(fh_dt[,..candidate_vars], is.na))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fh_dt <span class="ot">&lt;-</span> fh_dt[rowsNAcovariates <span class="sc">==</span> <span class="dv">0</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-multicollinearity" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="check-multicollinearity"><span class="header-section-number">2.3.2</span> Check multicollinearity</h3>
<p>With the help of the <code>step()</code> function of package <code>emdi</code>, we perform a variable selection based on the chosen variable selection criterion and directly get the model with fewer variables. The function <code>step_wrapper()</code> implemented below is a wrapper to the <code>emdi::step()</code> function and performs all the perfunctory cleaning necessary to use <code>step()</code>. This includes dropping columns that are entirely missing (<code>NA</code>) and keep only complete cases/observations (for the model selection only the in-sample domains are used) and remove perfectly or near collinear variables and combinations.</p>
<p>We apply the function to select the variables. Required inputs: data set, character vector containing the set of auxiliary variables, name of y variable, a correlation threshold between 0 and 1, name of information criterion and name of direct variance variable. In case, a transformation should be applied, “arcsin” as transformation and name of variable that contains the effective sample size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fh_step <span class="ot">&lt;-</span> <span class="fu">step_wrapper_fh</span>(<span class="at">dt =</span> fh_dt,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">xvars =</span> candidate_vars,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> <span class="st">"direct_povrate"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cor_thresh =</span> <span class="fl">0.7</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">criteria =</span> <span class="st">"BIC"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">vardir =</span> <span class="st">"vardir"</span>, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">transformation =</span> <span class="st">"arcsin"</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">eff_smpsize =</span> <span class="st">"n_eff"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Resulting model formula</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fh_step<span class="sc">$</span>fixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>direct_povrate ~ gen + age5 + educ1 + mkt
&lt;environment: 0x000002cd146067e8&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="model-estimation-of-fh-point-and-their-mse-estimates." class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="model-estimation-of-fh-point-and-their-mse-estimates."><span class="header-section-number">2.4</span> Model estimation of FH point and their MSE estimates.</h2>
<p>In this example, we use the function <code>fh</code> to calculate the FH estimates. Because we want to estimate a ratio, we need to apply the arcsin transformation to guarantee that the results lie between 0 and 1. For that, we choose “arcsin” as <code>transformation</code>, and a bias-corrected <code>backtransformation</code> (“bc”). Additionally, the effective sample size, which equals the sample size of each area divided by the design effect, is needed for the arcsin transformation. We set the <code>MSE</code> estimation to <code>TRUE</code>, the <code>mse_type</code> to “boot” (necessary for the type of transformation) and determine the number of bootstrap iterations. For practical applications, values larger than 200 are recommended. In case, no transformation is desired, the <code>transformation</code> argument must be set to “no” and the inputs <code>backtransformation</code> and <code>eff_smpsize</code> are no longer needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>fh_model <span class="ot">&lt;-</span> <span class="fu">fh</span>(<span class="at">fixed =</span> <span class="fu">formula</span>(fh_step<span class="sc">$</span>fixed),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">vardir =</span> <span class="st">"vardir"</span>, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">combined_data =</span> fh_dt, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">domains =</span> <span class="st">"Domain"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"ml"</span>, </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">transformation =</span> <span class="st">"arcsin"</span>, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">backtransformation =</span> <span class="st">"bc"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">eff_smpsize =</span> <span class="st">"n_eff"</span>, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">MSE =</span> <span class="cn">TRUE</span>, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">mse_type =</span> <span class="st">"boot"</span>, <span class="at">B =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">0</span>)) </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="do">## In case, no transformation is desired, the call would like this:</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># fh_model &lt;- fh(</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   fixed = Direct ~ age2 + age3 + age4 + age5 + educ1 + ntl + schyrs, #formula(fh_step$fixed),</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   vardir = "vardir", combined_data = comb_Data, domains = "Domain",</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "ml", MSE = TRUE) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assessment-of-the-estimated-model." class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="assessment-of-the-estimated-model."><span class="header-section-number">2.5</span> Assessment of the estimated model.</h2>
<p>With the help of the <code>summary</code> method of <code>emdi</code>, we gain detailed insights into the data and model components. It includes information on the estimation methods used, the number of domains, the log-likelihood, and information criteria as proposed by <span class="citation" data-cites="Marhuenda2014">Marhuenda, Morales, and Camen Pardo (<a href="#ref-Marhuenda2014" role="doc-biblioref">2014</a>)</span>. It also reports the adjusted <span class="math inline">\(R^2\)</span> from a standard linear model and the adjusted <span class="math inline">\(R^2\)</span> specific to FH models, as introduced by <span class="citation" data-cites="Lahiri2015">Lahiri and Suntornchost (<a href="#ref-Lahiri2015" role="doc-biblioref">2015</a>)</span>. It also offers diagnostic measures to assess model assumptions regarding the standardized realized residuals and random effects. These include skewness and kurtosis (based on the <code>moments</code> package by <span class="citation" data-cites="Komsta2015">Komsta and Novomestky (<a href="#ref-Komsta2015" role="doc-biblioref">2015</a>)</span>), as well as Shapiro-Wilk test statistics and corresponding p-values to evaluate the normality of both error components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fh_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
 fh(fixed = formula(fh_step$fixed), vardir = "vardir", combined_data = fh_dt, 
    domains = "Domain", method = "ml", transformation = "arcsin", 
    backtransformation = "bc", eff_smpsize = "n_eff", MSE = TRUE, 
    mse_type = "boot", B = c(200, 0))

Out-of-sample domains:  1 
In-sample domains:  51 

Variance and MSE estimation:
Variance estimation method:  ml 
Estimated variance component(s):  0.002254948 
MSE method:  bootstrap 

Coefficients:
            coefficients std.error t.value   p.value    
(Intercept)     1.248326  0.311379  4.0090 6.097e-05 ***
gen            -0.525756  0.206284 -2.5487  0.010813 *  
age5            0.560927  0.208204  2.6941  0.007057 ** 
educ1          -0.271896  0.132949 -2.0451  0.040843 *  
mkt             0.052423  0.011775  4.4518 8.513e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Explanatory measures:
   loglike       AIC      BIC     AdjR2     FH_R2
1 59.21822 -106.4364 -94.8455 0.4606883 0.7681853

Residual diagnostics:
                         Skewness Kurtosis Shapiro_W Shapiro_p
Standardized_Residuals -0.0704399 2.085588 0.9773667 0.4338271
Random_effects         -0.2587831 3.422467 0.9896043 0.9324833

Transformation:
 Transformation Back_transformation
         arcsin                  bc</code></pre>
</div>
</div>
<p>We can see, that 49 domains are in-sample domains. The 3 out-of-sample domains belong to the domains with 0 direct and variance estimates that we set to <code>NA</code> in the beginning. The variance of the random effects equals 0.001516632. All of the included auxiliary variables are significant on a 0.05 significance level and their explanatory power is large with an adjusted <span class="math inline">\(R^2\)</span> (for FH models) of around 0.74. The results of the Shapiro-Wilk-test indicate that normality is not rejected for the standardized residuals.</p>
<section id="diagnostic-plots" class="level3" data-number="2.5.1">
<h3 data-number="2.5.1" class="anchored" data-anchor-id="diagnostic-plots"><span class="header-section-number">2.5.1</span> Diagnostic plots</h3>
<p>We produce normal quantile-quantile (Q-Q) plots of the standardized realized residuals and random effects and plots of the kernel densities of the distribution of both error terms by the <code>plot</code> method of <code>emdi</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fh_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/plot-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/plot-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plots show slight deviations of the distributions from normality. The normality assumption is not required for the computation of the FH estimates, but at the obtained MSE estimates we have to look with some care when the normality assumption does not hold.</p>
</section>
</section>
<section id="comparison-of-the-fh-results-with-the-direct-estimates." class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="comparison-of-the-fh-results-with-the-direct-estimates."><span class="header-section-number">2.6</span> Comparison of the FH results with the direct estimates.</h2>
<p>The FH estimates are expected to align closely with the direct estimates in domains with small direct MSEs and/or large sample sizes. Moreover, incorporating auxiliary information should enhance the precision of the direct estimates. We produce a scatter plot proposed by <span class="citation" data-cites="Brown2001">Brown et al. (<a href="#ref-Brown2001" role="doc-biblioref">2001</a>)</span> and a line plot. The fitted regression and the identity line of the scatter plot should not differ too much. The FH estimates should track the direct estimates within the line plot especially for domains with a large sample size/small MSE of the direct estimator. Furthermore, we compare the MSE and CV estimates for the direct and FH estimators using boxplots and ordered scatter plots (by setting the input arguments <code>MSE</code> and <code>CV</code> to <code>TRUE</code>).</p>
<p>Additionally, we compute a correlation coefficient of the direct estimates and the estimates of the regression-synthetic part of the FH model <span class="citation" data-cites="Chandra2015">(<a href="#ref-Chandra2015" role="doc-biblioref">Chandra, Salvati, and Chambers 2015</a>)</span> and a goodness of fit diagnostic <span class="citation" data-cites="Brown2001">(<a href="#ref-Brown2001" role="doc-biblioref">Brown et al. 2001</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_plot</span>(fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/compare-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/compare-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/compare-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/compare-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/compare-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="40-fh_files/figure-html/compare-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fh_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Brown test 

Null hypothesis: EBLUP estimates do not differ significantly from the
      direct estimates 

  W.value Df   p.value
 15.08585 51 0.9999998

Correlation between synthetic part and direct estimator:  0.72 </code></pre>
</div>
</div>
<p>The direct estimates are tracked by most of the FH estimates within the line plot. The precision of the direct estimates could be improved by the usage of the FH model in terms of MSEs and CVs. The null hypothesis of the Brown test is not rejected and the correlation coefficient indicates a positive correlation (0.66) between the direct and FH estimates.</p>
<p>If the result of the model assessment is not satisfactory, the following should be checked again: Can the direct estimation including variance estimation be improved? Are there further auxiliary variables and/or must possible interaction effects be taken into account? Does a (different) transformation need to be used?</p>
</section>
<section id="benchmark-the-fh-point-estimates-for-consistency-with-higher-results." class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="benchmark-the-fh-point-estimates-for-consistency-with-higher-results."><span class="header-section-number">2.7</span> Benchmark the FH point estimates for consistency with higher results.</h2>
<p>Benchmarking is based on the principle that aggregated FH estimates should sum up to the estimates at a higher regional level. For the benchmark function, a benchmark value and a vector containing the shares of the population size per area (<span class="math inline">\(N_d/N\)</span>) is required. Please note, that only the FH estimates are benchmarked and not their MSE estimates. As benchmark types “raking”, “ratio” and “MSE_adj” can be chosen. For further details about using the function, please refer to the <code>emdi</code> vignette and for general information about the benchmarking options to <span class="citation" data-cites="Datta2011">Datta et al. (<a href="#ref-Datta2011" role="doc-biblioref">2011</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">## compute the benchmark value (mean of poverty indicator for the whole country)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>benchmark_value <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(survey_dt<span class="sc">$</span>pov_indicator, survey_dt[[weight_var]])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="do">## compute the share of population size in the total population size (N_d/N) per area</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"sizeprov"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>fh_dt <span class="ot">&lt;-</span> fh_dt <span class="sc">|&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sizeprov <span class="sc">|&gt;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio_n =</span> Nd<span class="sc">/</span><span class="fu">sum</span>(Nd)), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Domain"</span> <span class="ot">=</span> area_vars[<span class="dv">1</span>]))</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>fh_bench <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(fh_model,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">benchmark =</span> benchmark_value,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">share =</span> fh_dt<span class="sc">$</span>ratio_n, </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type =</span> <span class="st">"ratio"</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                      <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fh_bench<span class="sc">$</span>ind)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Domain     Direct        FH  FH_Bench Out
1      1 0.24394059 0.3061689 0.3140667   0
2      2 0.15913215 0.1794998 0.1841301   0
3      3 0.16294054 0.1754708 0.1799972   0
4      4 0.29656922 0.2501263 0.2565784   0
5      5 0.09564252 0.1781981 0.1827949   0
6      6 0.22733200 0.2485626 0.2549744   0</code></pre>
</div>
</div>
</section>
<section id="preparation-of-the-results." class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="preparation-of-the-results."><span class="header-section-number">2.8</span> Preparation of the results.</h2>
<p>Create one dataframe that contains the direct and FH estimation results including MSE and CV results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>pov_fh <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">estimators</span>(fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pov_fh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Domain     Direct   Direct_MSE Direct_CV        FH       FH_MSE     FH_CV
1      1 0.24394059 0.0081862422 0.3709012 0.3061689 0.0026749083 0.1689248
2      2 0.15913215 0.0065826888 0.5098515 0.1794998 0.0015381875 0.2184946
3      3 0.16294054 0.0007439151 0.1673912 0.1754708 0.0007341814 0.1544176
4      4 0.29656922 0.0024887140 0.1682137 0.2501263 0.0009681514 0.1243977
5      5 0.09564252 0.0035152460 0.6199074 0.1781981 0.0017924112 0.2375832
6      6 0.22733200 0.0014822014 0.1693531 0.2485626 0.0010867894 0.1326285</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pov_fh <span class="ot">&lt;-</span> pov_fh <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="sc">!!</span>area_vars[<span class="dv">1</span>] <span class="sc">:</span><span class="er">=</span> <span class="st">"Domain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> singleyear)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_write</span>(<span class="at">x =</span> pov_fh,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">name =</span> <span class="st">"pov_fh"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(pov_fh, <span class="st">"data/clean-example/pov_fh.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="poverty-map" class="level3" data-number="2.8.1">
<h3 data-number="2.8.1" class="anchored" data-anchor-id="poverty-map"><span class="header-section-number">2.8.1</span> Poverty map</h3>
<p>With the help of geographical maps, the results can be presented in a user-friendly way and differences among the areas can be detected more easily. For the map, a shape file is reqired. The domain identifiers in the results object (<code>fh_model</code>) need to match to the respective identifiers of the shape file. Therefore, we create a mapping table first and then produce the map by <code>emdi::map_plot</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Create a suitable mapping table</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Find the right order</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>domain_ord <span class="ot">&lt;-</span> <span class="fu">match</span>(shp_dt[[area_vars[<span class="dv">1</span>]]], fh_model<span class="sc">$</span>ind<span class="sc">$</span>Domain)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Create the mapping table based on the order obtained above</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>map_tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pop_data_id =</span> fh_model<span class="sc">$</span>ind<span class="sc">$</span>Domain[domain_ord],</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">shape_id =</span> shp_dt[[area_vars[<span class="dv">1</span>]]])</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Create map</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">map_plot</span>(<span class="at">object =</span> fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">map_obj =</span> shp_dt,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a> <span class="at">map_dom_id =</span> area_vars[<span class="dv">1</span>], <span class="at">map_tab =</span> map_tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-povmap-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="40-fh_files/figure-html/fig-povmap-1.png" id="fig-povmap-1" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-povmap-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="40-fh_files/figure-html/fig-povmap-2.png" id="fig-povmap-2" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.2
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-povmap-3" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="40-fh_files/figure-html/fig-povmap-3.png" id="fig-povmap-3" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.3
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-povmap-4" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="40-fh_files/figure-html/fig-povmap-4.png" id="fig-povmap-4" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.4
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="saving-the-results." class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="saving-the-results."><span class="header-section-number">2.9</span> Saving the results.</h2>
<p>Either by using <code>save.image("fh_estimation.RData")</code> or export of the model output and estimation results to Excel or OpenDocument spreadsheet (ODS) <code>write.excel(fh_model, file = "fh_model_output.xlsx", MSE = TRUE, CV = TRUE</code>.</p>
</section>
<section id="references" class="level2" data-number="2.10">
<h2 data-number="2.10" class="anchored" data-anchor-id="references"><span class="header-section-number">2.10</span> References</h2>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Brown2001" class="csl-entry" role="listitem">
Brown, G., R. Chambers, P. Heady, and D. Heasman. 2001. <span>“Evaluation of Small Area Estimation Methods - an Application to Unemployment Estimates from the <span>UK</span> <span>LFS</span>.”</span> In <em>Proceedings of Statistics Canada Symposium</em>.
</div>
<div id="ref-Casas2016" class="csl-entry" role="listitem">
Casas-Cordero, C., J. Encina, and P. Lahiri. 2016. <span>“Poverty Mapping for the Chilean Comunas.”</span> In <em>Analysis of Poverty by Small Area Estimation</em>, by M. Pratesi, 379–403. John Wiley &amp; Sons. <a href="https://doi.org/10.1002/9781118814963.ch20">https://doi.org/10.1002/9781118814963.ch20</a>.
</div>
<div id="ref-Chandra2015" class="csl-entry" role="listitem">
Chandra, H., N. Salvati, and R. Chambers. 2015. <span>“A Spatially Nonstationary <span>Fay-Herriot</span> Model for Small Area Estimation.”</span> <em>Journal of the Survey Statistics and Methodology</em> 3 (2): 109–35. <a href="https://doi.org/10.1093/jssam/smu026">https://doi.org/10.1093/jssam/smu026</a>.
</div>
<div id="ref-Datta2011" class="csl-entry" role="listitem">
Datta, G. S., M. Ghosh, R. Steorts, and J. Maples. 2011. <span>“Bayesian Benchmarking with Applications to Small Area Estimation.”</span> <em>TEST</em> 20 (3): 574–88. <a href="https://doi.org/10.1007/s11749-010-0218-y">https://doi.org/10.1007/s11749-010-0218-y</a>.
</div>
<div id="ref-Fay1979" class="csl-entry" role="listitem">
Fay, Robert E., and Roger A. Herriot. 1979. <span>“Estimates of Income for Small Places: An Application of <span>J</span>ames-<span>S</span>tein Procedures to Census Data.”</span> <em>Journal of the American Statistical Association</em> 74: 269–77.
</div>
<div id="ref-Harmening2023" class="csl-entry" role="listitem">
Harmening, Sylvia, Ann-Kristin Kreutzmann, Sören Schmidt, Nicola Salvati, and Timo Schmid. 2023. <span>“A Framework for Producing Small Area Estimates Based on Area-Level Models in r.”</span> <em>The R Journal</em> 15 (1): 316–41. <a href="https://doi.org/10.32614/RJ-2023-039">https://doi.org/10.32614/RJ-2023-039</a>.
</div>
<div id="ref-Komsta2015" class="csl-entry" role="listitem">
Komsta, Lukasz, and Frederick Novomestky. 2015. <em>Moments: Moments, Cumulants, Skewness, Kurtosis and Related Tests</em>. <a href="https://CRAN.R-project.org/package=moments">https://CRAN.R-project.org/package=moments</a>.
</div>
<div id="ref-Lahiri2015" class="csl-entry" role="listitem">
Lahiri, P., and J. Suntornchost. 2015. <span>“Variable Selection for Linear Mixed Models with Applications in Small Area Estimation.”</span> <em>The Indian Journal of Statistics</em> 77-B (2): 312–20. <a href="https://www.jstor.org/stable/43694416">https://www.jstor.org/stable/43694416</a>.
</div>
<div id="ref-Lumley2024" class="csl-entry" role="listitem">
Lumley, Thomas. 2024. <span>“Survey: Analysis of Complex Survey Samples.”</span>
</div>
<div id="ref-Marhuenda2014" class="csl-entry" role="listitem">
Marhuenda, Y., D. Morales, and M. del Camen Pardo. 2014. <span>“Information Criteria for <span>Fay-Herriot</span> Model Selection.”</span> <em>Computational Statistics and Data Analysis</em> 70: 268–80. <a href="https://doi.org/10.1016/j.csda.2013.09.016">https://doi.org/10.1016/j.csda.2013.09.016</a>.
</div>
<div id="ref-molina2015r" class="csl-entry" role="listitem">
Molina, Isabel, and Yolanda Marhuenda. 2015. <span>“<span class="nocase">sae</span>: An <span>R</span> Package for Small Area Estimation.”</span> <em>The R Journal</em> 7 (1): 81–98. <a href="https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf">https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf</a>.
</div>
<div id="ref-RaoMolina2015" class="csl-entry" role="listitem">
Rao, J. N. K., and Isabel Molina. 2015. <em>Small Area Estimation</em>. John Wiley; Sons, Inc, Hoboken, NJ, USA.
</div>
<div id="ref-Schmid2017" class="csl-entry" role="listitem">
Schmid, T., F. Bruckschen, N. Salvati, and T. Zbiranski. 2017. <span>“Constructing Sociodemographic Indicators for National Statistical Institutes Using Mobile Phone Data: Estimating Literacy Rates in <span>Senegal</span>.”</span> <em>Journal of the Royal Statistical Society A</em> 180 (4): 1163–90. <a href="https://doi.org/10.1111/rssa.12305">https://doi.org/10.1111/rssa.12305</a>.
</div>
<div id="ref-you2023application" class="csl-entry" role="listitem">
You, Yong, and Mike Hidiroglou. 2023. <span>“Application of Sampling Variance Smoothing Methods for Small Area Proportion Estimation.”</span> <em>Journal of Official Statistics</em> 39 (4): 571–90.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Overview">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./50-mfh.html" class="pagination-link" aria-label="Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb40" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "The Univariate Fay-Herriot (UFH) model"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Sylvia Harmening"</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE, include = FALSE, warning = FALSE, message=FALSE, error =  FALSE}</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: false</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Chunk setup</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">echo =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cn">FALSE</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>pak_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sf"</span>, <span class="st">"data.table"</span>, <span class="st">"tidyverse"</span>, <span class="st">"car"</span>, </span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>              <span class="st">"sae"</span>, <span class="st">"survey"</span>, <span class="st">"spdep"</span>, <span class="st">"knitr"</span>, <span class="st">"MASS"</span>, <span class="st">"caret"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>              <span class="st">"caret"</span>, <span class="st">"purrr"</span>, <span class="st">"pins"</span>, <span class="st">"gt"</span>,  <span class="st">"scales"</span>,</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>              <span class="st">"viridis"</span>, <span class="st">"emdi"</span>, <span class="st">"rlang"</span>)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(pak_list,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>       library,</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading locally-developed</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"R"</span>, <span class="at">pattern=</span><span class="st">"*.R$"</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>, <span class="at">ignore.case=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">walk</span>(source)</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Raw data root</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>root_raw <span class="ot">&lt;-</span> <span class="st">"./data/raw"</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>root_temp <span class="ot">&lt;-</span> <span class="st">"./data/temp"</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>root_clean <span class="ot">&lt;-</span> <span class="st">"./data/clean-example"</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Data-storage boards</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>bd_raw <span class="ot">&lt;-</span> root_raw <span class="sc">|&gt;</span> <span class="fu">file.path</span>(<span class="st">"api"</span>) <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>bd_aux <span class="ot">&lt;-</span> root_temp <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>bd_clean <span class="ot">&lt;-</span> root_clean <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>bd_out <span class="ot">&lt;-</span> <span class="fu">board_folder</span>(<span class="st">"data/clean-example"</span>, <span class="at">versioned =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>In this section, we will present a whole estimation procedure of the univariate area-level model introduced by @Fay1979 in R. As with the disclaimer in the preceding section, this practical manual is not intended to serve as a theoretical introduction to area-level models. Instead, it offers a set of straightforward and practical R scripts, accompanied by clear explanations, to demonstrate how these tasks can be carried out in R. For a theoretical foundation please refer to @Fay1979 and @RaoMolina2015. In addition to theoretical information, the vignette "A framework for producing small area estimates based on area-level models in R" of the R package <span class="in">`emdi`</span> <span class="co">[</span><span class="ot">@Harmening2023</span><span class="co">]</span> provides further code examples for the FH model.</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>In this chapter, we will describe how to run the univariate Fay-Herriot (FH) using simulated income data from Spain. The estimation procedure is explained step by step.</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>Step 1: Data preparation. Compute the direct estimates and their corresponding variances on the area-level and eventually perform variance smoothing. Aggregate the available auxiliary variables to the same area level and combine both input data.</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>Step 2: Model selection. Select the aggregated auxiliary variables at the area level for the FH model using a stepwise selection based on information criteria like the Akaike, Bayesian or Kullback information criteria.</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>Step 3: Model estimation of FH point estimates and their mean squared error (MSE) estimates as uncertainty measure. Eventually apply a transformation.</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>Step 4: Assessment of the estimated model. Check the FH model assumptions, including linearity, normality of predicted area effects and standardized model residuals. When violations of the model assumptions are detected, the application of a transformation might help. Repeat Step 3 including a transformation and check again the model assumptions.</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>Step 5: Comparison of the FH results with the direct estimates.</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>Step 6: Benchmark the FH point estimates for consistency with higher results.</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>Step 7: Preparation of the results. Create tables and maps of results.</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>Step 8: Saving the results. One option is to export the results to known formats like Excel or OpenDocument Spreadsheets.</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>We will show below the use of the <span class="in">`fh()`</span> function of the R package <span class="in">`emdi`</span> <span class="co">[</span><span class="ot">@Harmening2023</span><span class="co">]</span> which computes the EBLUPs and their MSE estimates of the standard FH model and several extensions of it, among others it allows for the application of transformations. Because the poverty rate is a ratio, it might be helpful to apply the arcsin transformation to guarantee that the results lie between 0 and 1. The function call is:</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a><span class="in">`fh(fixed, vardir, combined_data, domains = NULL, method = "reml", interval = NULL,   k = 1.345, mult_constant = 1, transformation = "no", backtransformation = NULL,   eff_smpsize = NULL, correlation = "no", corMatrix = NULL, Ci = NULL, tol = 1e-04,   maxit = 100, MSE = FALSE, mse_type = "analytical", B = c(50, 0), seed = 123)`</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data and preparation</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load the dataset</span></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>Usually, SAE combines multiple data sources: a survey data set and a census or administrative/register dataset. For the estimation of area-level models, we need area-level aggregates of the same area-level (e.g. NUTS3) of both datasets. The target variable (typically household welfare/income for poverty mapping) is available in the survey but not in the census data.</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>In this example, we use a synthetic data set adapted from R package <span class="in">`sae`</span> called <span class="in">`incomedata`</span>. The original data contains information for $n = 17,119$ fictitious individuals residing across $D = 52$ Spanish provinces. The variables include the name of the province of residence (<span class="in">`provlab`</span>), province code (<span class="in">`prov`</span>), as well as several correlates of income.</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>For this exercise, we use a random 10% sample of the <span class="in">`incomedata`</span> to estimate the poverty rates. For the univariate case, we use the income variable from 2012.</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>The FH estimation process relies on 3 types of data:</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>(1) The data containing the outcome variable from which direct estimates will be computed. This is a usually a survey dataset for each year of data including outcome variable (such as income or welfare aggregates), weights, cluster identifiers (i.e. if available, psu or enumeration areas) at the unit level i.e. individual or household. In this example, we call this: <span class="in">`survey_dt`</span>.</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>(2) A dataset containing for the right hand side (RHS) variables i.e. indicator estimates representative at the level of the target area. This is often obtained from administrative data sources or geospatial data such as remotely sensed high resolution data. The final RHS dataset ought to include an area id and variables of interest. In this example, we call this <span class="in">`rhs_dt`</span>.</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>(3) Finally, a shapefile which spatially links each target area to their boundaries on a map. This will contain the area id as well as the geometry object which when visualized will show the shape of the areas in which poverty rates will be estimated. In this example, we call this <span class="in">`shp_dt`</span>.</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a><span class="do">### lets read in our 3 aforementioned datasets </span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>  bd_clean <span class="sc">|&gt;</span></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_read</span>(<span class="st">"pov_direct"</span>)</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>  bd_clean <span class="sc">|&gt;</span></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_read</span>(<span class="st">"sae_data"</span>)</span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>  bd_clean <span class="sc">|&gt;</span></span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_read</span>(<span class="st">"geometries"</span>)</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>Below is what our datasets look like. These are generally the variables</span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="sc">|&gt;</span></span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a><span class="in">`survey_dt`</span> contains our target area identifiers (<span class="in">`provlab`</span>, <span class="in">`prov`</span>), the weight variable <span class="in">`weight`</span>, the cluster id i.e. enumeration area or psu, <span class="in">`ea_id`</span>, the year, <span class="in">`year`</span>, the income variable <span class="in">`income`</span> and the poverty line <span class="in">`poverty`</span>. In this example, <span class="in">`survey_dt`</span> of class <span class="in">`data.frame`</span> is at the level of the individual. It could also be at the level of the household if poverty lines are evaluated at that level.</span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="sc">|&gt;</span></span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a><span class="sc">\`</span><span class="in">`rhs_dt`</span> is an object of class <span class="in">`data.frame`</span> created at the level of the target area. It should contain the same target area identifiers as in <span class="in">`survey_dt`</span> and the year variable <span class="in">`year`</span>.</span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="sc">|&gt;</span></span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-144"><a href="#cb40-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-145"><a href="#cb40-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a><span class="in">`shp_dt`</span> is an object of class <span class="in">`sf`</span>, <span class="in">`data.frame`</span> created at the level of the target area. This is the shapefile for the area of interest for which the poverty map will be estimated. It should contain the same target area ID found in <span class="in">`survey_dt`</span> as well as <span class="in">`rhs_dt`</span>.</span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a>A quick summary table on the data needs for the UFH model:</span>
<span id="cb40-149"><a href="#cb40-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-150"><a href="#cb40-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE}</span></span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table content</span></span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a>fh_table <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"`survey_dt`"</span>, <span class="st">"`rhs_dt`"</span>, <span class="st">"`shp_dt`"</span>),</span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Unit of Observation</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Individual (or Household)"</span>,</span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Target Area (e.g. Province)"</span>,</span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Target Area (Spatial)"</span></span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Required Variables</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a>    <span class="st">"`target area identifiers`, `weights`, `cluster identifier`, `income/welfare variable`, `poverty line`"</span>,</span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a>    <span class="st">"`target area identifiers`, `covariates` (e.g. `gen`, `educ1`, `schyrs`, etc.)"</span>,</span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a>    <span class="st">"`target area identifiers`, `geometries` (e.g. `geometry` column from `sf`)"</span></span>
<span id="cb40-164"><a href="#cb40-164" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-165"><a href="#cb40-165" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-166"><a href="#cb40-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-167"><a href="#cb40-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-168"><a href="#cb40-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the gt table</span></span>
<span id="cb40-169"><a href="#cb40-169" aria-hidden="true" tabindex="-1"></a>fh_table <span class="sc">%&gt;%</span></span>
<span id="cb40-170"><a href="#cb40-170" aria-hidden="true" tabindex="-1"></a> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb40-171"><a href="#cb40-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb40-172"><a href="#cb40-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Data Input Checklist for the Univariate Fay-Herriot Model**"</span>),</span>
<span id="cb40-173"><a href="#cb40-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"*Datasets, levels, and Required variables*"</span>)</span>
<span id="cb40-174"><a href="#cb40-174" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb40-175"><a href="#cb40-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb40-176"><a href="#cb40-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">Dataset =</span> <span class="st">"Dataset Name"</span>,</span>
<span id="cb40-177"><a href="#cb40-177" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Unit of Observation</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Unit of Observation"</span>,</span>
<span id="cb40-178"><a href="#cb40-178" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Required Variables</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Required Variables"</span></span>
<span id="cb40-179"><a href="#cb40-179" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb40-180"><a href="#cb40-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb40-181"><a href="#cb40-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.names =</span> <span class="st">"Arial"</span>,</span>
<span id="cb40-182"><a href="#cb40-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="dv">16</span>,</span>
<span id="cb40-183"><a href="#cb40-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb40-184"><a href="#cb40-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb40-185"><a href="#cb40-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">column_labels.font.weight =</span> <span class="st">"bold"</span>,</span>
<span id="cb40-186"><a href="#cb40-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_row.padding =</span> <span class="fu">px</span>(<span class="dv">4</span>),</span>
<span id="cb40-187"><a href="#cb40-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.border.top.width =</span> <span class="fu">px</span>(<span class="dv">2</span>),</span>
<span id="cb40-188"><a href="#cb40-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.border.bottom.width =</span> <span class="fu">px</span>(<span class="dv">2</span>),</span>
<span id="cb40-189"><a href="#cb40-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.align =</span> <span class="st">"left"</span></span>
<span id="cb40-190"><a href="#cb40-190" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb40-191"><a href="#cb40-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_markdown</span>(<span class="at">columns =</span> <span class="fu">everything</span>())</span>
<span id="cb40-192"><a href="#cb40-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-193"><a href="#cb40-193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-194"><a href="#cb40-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-195"><a href="#cb40-195" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direct estimation</span></span>
<span id="cb40-196"><a href="#cb40-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-197"><a href="#cb40-197" aria-hidden="true" tabindex="-1"></a>We will use the direct Horvitz-Thompons estimators that use the survey weights in <span class="in">`weight`</span> variable. We calculate the sample sizes for each provinces and compute the direct estimates and their variances. We use the <span class="in">`direct`</span> function of the <span class="in">`emdi`</span> package here. Other options are e.g. the <span class="in">`direct`</span> function of package <span class="in">`sae`</span> <span class="co">[</span><span class="ot">@molina2015r</span><span class="co">]</span> or the <span class="in">`svyby`</span> command of package <span class="in">`survey`</span> <span class="co">[</span><span class="ot">@Lumley2024</span><span class="co">]</span>. Then, we create a dataframe containing the direct estimate, the standard errors, the variances, the coefficient of variation and the design effects, that are needed for the arcsin transformation. The design effect is the ratio of the variance considering the sampling design to the variance estimated under simple random sampling. For detailled information about the arcsin transformation please refer to @Casas2016 and @Schmid2017. In some areas with a very small sample size, it may occur, that the individual data only consists of zeros and ones, resulting in a direct estimate of zero or one and a direct variance of zero. We set those areas to out-of-sample and for the final estimation results only the synthetic part of the FH model is used.</span>
<span id="cb40-198"><a href="#cb40-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-199"><a href="#cb40-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r direct, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-200"><a href="#cb40-200" aria-hidden="true" tabindex="-1"></a><span class="do">### a little bit of housekeeping to ensure ease of access </span></span>
<span id="cb40-201"><a href="#cb40-201" aria-hidden="true" tabindex="-1"></a>area_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"prov"</span>, <span class="st">"provlab"</span>) <span class="do">### both variables are at the same level. If the levels vary, you would need to combine both variables for effect use</span></span>
<span id="cb40-202"><a href="#cb40-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-203"><a href="#cb40-203" aria-hidden="true" tabindex="-1"></a>cluster_var <span class="ot">&lt;-</span> <span class="st">"ea_id"</span></span>
<span id="cb40-204"><a href="#cb40-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-205"><a href="#cb40-205" aria-hidden="true" tabindex="-1"></a>weight_var <span class="ot">&lt;-</span> <span class="st">"weight"</span></span>
<span id="cb40-206"><a href="#cb40-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-207"><a href="#cb40-207" aria-hidden="true" tabindex="-1"></a>year_var <span class="ot">&lt;-</span> <span class="st">"year"</span></span>
<span id="cb40-208"><a href="#cb40-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-209"><a href="#cb40-209" aria-hidden="true" tabindex="-1"></a>outcome_var <span class="ot">&lt;-</span> <span class="st">"income"</span></span>
<span id="cb40-210"><a href="#cb40-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-211"><a href="#cb40-211" aria-hidden="true" tabindex="-1"></a>povline_var <span class="ot">&lt;-</span> <span class="st">"povline"</span></span>
<span id="cb40-212"><a href="#cb40-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-213"><a href="#cb40-213" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(rhs_dt)[<span class="sc">!</span><span class="fu">colnames</span>(rhs_dt) <span class="sc">%in%</span> <span class="fu">c</span>(area_vars, year_var)]</span>
<span id="cb40-214"><a href="#cb40-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-215"><a href="#cb40-215" aria-hidden="true" tabindex="-1"></a><span class="do">## For the univariate model, we only use a single year (here 2012)</span></span>
<span id="cb40-216"><a href="#cb40-216" aria-hidden="true" tabindex="-1"></a>singleyear <span class="ot">&lt;-</span> <span class="st">"2012"</span></span>
<span id="cb40-217"><a href="#cb40-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-218"><a href="#cb40-218" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span></span>
<span id="cb40-219"><a href="#cb40-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> singleyear)</span>
<span id="cb40-220"><a href="#cb40-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-221"><a href="#cb40-221" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="ot">&lt;-</span> rhs_dt <span class="sc">|&gt;</span></span>
<span id="cb40-222"><a href="#cb40-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> singleyear)</span>
<span id="cb40-223"><a href="#cb40-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-224"><a href="#cb40-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-225"><a href="#cb40-225" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate sample size for each province</span></span>
<span id="cb40-226"><a href="#cb40-226" aria-hidden="true" tabindex="-1"></a>sampsize_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-227"><a href="#cb40-227" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="sc">|&gt;</span></span>
<span id="cb40-228"><a href="#cb40-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars[<span class="dv">1</span>])) <span class="sc">|&gt;</span></span>
<span id="cb40-229"><a href="#cb40-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">N =</span> <span class="fu">n</span>())</span>
<span id="cb40-230"><a href="#cb40-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-231"><a href="#cb40-231" aria-hidden="true" tabindex="-1"></a><span class="do">## computation of direct estimates and their variances (the poverty line is already included within the data)</span></span>
<span id="cb40-232"><a href="#cb40-232" aria-hidden="true" tabindex="-1"></a><span class="do">## creating the poverty indicator</span></span>
<span id="cb40-233"><a href="#cb40-233" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-234"><a href="#cb40-234" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb40-235"><a href="#cb40-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pov_indicator =</span> <span class="fu">ifelse</span>(income <span class="sc">&lt;</span> povline, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb40-236"><a href="#cb40-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-237"><a href="#cb40-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-238"><a href="#cb40-238" aria-hidden="true" tabindex="-1"></a><span class="do">### creating a survey object</span></span>
<span id="cb40-239"><a href="#cb40-239" aria-hidden="true" tabindex="-1"></a>design_obj <span class="ot">&lt;-</span> survey<span class="sc">::</span><span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="fu">eval</span>(<span class="fu">expr</span>(<span class="sc">~!!</span><span class="fu">sym</span>(cluster_var))), </span>
<span id="cb40-240"><a href="#cb40-240" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weights =</span> <span class="fu">eval</span>(<span class="fu">expr</span>(<span class="sc">~!!</span><span class="fu">sym</span>(weight_var))), </span>
<span id="cb40-241"><a href="#cb40-241" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> survey_dt)</span>
<span id="cb40-242"><a href="#cb40-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-243"><a href="#cb40-243" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span> survey<span class="sc">::</span><span class="fu">svyby</span>(<span class="sc">~</span>pov_indicator, <span class="at">by=</span><span class="fu">eval</span>(<span class="fu">expr</span>(<span class="sc">~!!</span><span class="fu">sym</span>(area_vars[<span class="dv">1</span>]))), <span class="at">design =</span> design_obj, <span class="at">FUN =</span> survey<span class="sc">::</span>svymean)</span>
<span id="cb40-244"><a href="#cb40-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-245"><a href="#cb40-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-246"><a href="#cb40-246" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-247"><a href="#cb40-247" aria-hidden="true" tabindex="-1"></a>  var_dt <span class="sc">|&gt;</span></span>
<span id="cb40-248"><a href="#cb40-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">direct_povrate =</span> <span class="st">"pov_indicator"</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-249"><a href="#cb40-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">SD =</span> <span class="st">"se"</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-250"><a href="#cb40-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">vardir =</span> SD<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-251"><a href="#cb40-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CV =</span> SD <span class="sc">/</span> direct_povrate) <span class="sc">|&gt;</span></span>
<span id="cb40-252"><a href="#cb40-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(sampsize_dt, </span>
<span id="cb40-253"><a href="#cb40-253" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb40-254"><a href="#cb40-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_SRS =</span> direct_povrate <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> direct_povrate) <span class="sc">/</span> N) <span class="sc">|&gt;</span></span>
<span id="cb40-255"><a href="#cb40-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deff =</span> vardir <span class="sc">/</span> var_SRS) <span class="sc">|&gt;</span></span>
<span id="cb40-256"><a href="#cb40-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_eff =</span> N<span class="sc">/</span>deff)</span>
<span id="cb40-257"><a href="#cb40-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-258"><a href="#cb40-258" aria-hidden="true" tabindex="-1"></a><span class="do">## set zero variance to OOS</span></span>
<span id="cb40-259"><a href="#cb40-259" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> direct_dt[<span class="fu">complete.cases</span>(direct_dt), ]</span>
<span id="cb40-260"><a href="#cb40-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-261"><a href="#cb40-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-262"><a href="#cb40-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-263"><a href="#cb40-263" aria-hidden="true" tabindex="-1"></a>Here is what the results look like:</span>
<span id="cb40-264"><a href="#cb40-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-267"><a href="#cb40-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-268"><a href="#cb40-268" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(direct_dt)</span>
<span id="cb40-269"><a href="#cb40-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-270"><a href="#cb40-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-271"><a href="#cb40-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-272"><a href="#cb40-272" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variance smoothing</span></span>
<span id="cb40-273"><a href="#cb40-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-274"><a href="#cb40-274" aria-hidden="true" tabindex="-1"></a>A quick inspection of the preceding results will show some provinces contain low sample sizes which sometimes result in extreme value poverty rates and hence 0 variance. To avoid this, we will show you how to apply the variance smoothing method suggested by @you2023application. Please see the code and Roxygen comments below explaining the use of the <span class="in">`varsmoothie_king()`</span> function which computes smoothed variances. In case, the arcsin transformation will be applied, the variance smoothing described here is not necessary, since the arcsin transformation works variance stabilizing itself. When applying the arcsin transformation, the direct variances are automatically set to 1/(4<span class="sc">\*</span>effective sampling size) when using the <span class="in">`fh`</span> function of package <span class="in">`emdi`</span>. The effective sample size equals the sample size of each area divided by the design effect. If the variance stabilizing effect is not enough, the design effect of a higher area level could also be used here (in this example the regions <span class="in">`ac`</span>).</span>
<span id="cb40-275"><a href="#cb40-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-276"><a href="#cb40-276" aria-hidden="true" tabindex="-1"></a>The goal now is to use the <span class="in">`varsmoothie_king()`</span> function to add an additional column of smoothed variances into our <span class="in">`direct_dt`</span> dataframe. Required inputs: a vector of unique domains, the raw variances estimated from sample data and the sample size for each domain.</span>
<span id="cb40-277"><a href="#cb40-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-280"><a href="#cb40-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-281"><a href="#cb40-281" aria-hidden="true" tabindex="-1"></a>var_smooth <span class="ot">&lt;-</span> <span class="fu">varsmoothie_king</span>(<span class="at">domain =</span> direct_dt[[area_vars[<span class="dv">1</span>]]],</span>
<span id="cb40-282"><a href="#cb40-282" aria-hidden="true" tabindex="-1"></a>                               <span class="at">direct_var =</span> direct_dt<span class="sc">$</span>vardir,</span>
<span id="cb40-283"><a href="#cb40-283" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sampsize =</span> direct_dt<span class="sc">$</span>N)</span>
<span id="cb40-284"><a href="#cb40-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-285"><a href="#cb40-285" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> var_smooth <span class="sc">|&gt;</span> <span class="fu">merge</span>(direct_dt, <span class="at">by.x =</span> <span class="st">"Domain"</span>,</span>
<span id="cb40-286"><a href="#cb40-286" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.y =</span> area_vars[<span class="dv">1</span>])</span>
<span id="cb40-287"><a href="#cb40-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-288"><a href="#cb40-288" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the variances that are zero with their smoothed counterparts</span></span>
<span id="cb40-289"><a href="#cb40-289" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb40-290"><a href="#cb40-290" aria-hidden="true" tabindex="-1"></a>  direct_dt <span class="sc">|&gt;</span></span>
<span id="cb40-291"><a href="#cb40-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb40-292"><a href="#cb40-292" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"v_"</span>),</span>
<span id="cb40-293"><a href="#cb40-293" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">abs</span>(.x) <span class="sc">&lt;=</span> <span class="fl">1e-4</span>, <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"vsv"</span>, <span class="fu">str_remove</span>(<span class="fu">cur_column</span>(), <span class="st">"^v"</span>))), .x),</span>
<span id="cb40-294"><a href="#cb40-294" aria-hidden="true" tabindex="-1"></a>    <span class="at">.names =</span> <span class="st">"{.col}"</span></span>
<span id="cb40-295"><a href="#cb40-295" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb40-296"><a href="#cb40-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-297"><a href="#cb40-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-298"><a href="#cb40-298" aria-hidden="true" tabindex="-1"></a>Thus far, we have careful set up the types of data we require for the FH model. We only need to combine the dataframe containing the direct estimates and their variances with the auxiliary variables.</span>
<span id="cb40-299"><a href="#cb40-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-302"><a href="#cb40-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-303"><a href="#cb40-303" aria-hidden="true" tabindex="-1"></a>fh_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(direct_dt, rhs_dt,</span>
<span id="cb40-304"><a href="#cb40-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">"Domain"</span>, <span class="at">by.y =</span> area_vars[[<span class="dv">1</span>]],</span>
<span id="cb40-305"><a href="#cb40-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-306"><a href="#cb40-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-307"><a href="#cb40-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-308"><a href="#cb40-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-309"><a href="#cb40-309" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model selection</span></span>
<span id="cb40-310"><a href="#cb40-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-311"><a href="#cb40-311" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model preparation</span></span>
<span id="cb40-312"><a href="#cb40-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-313"><a href="#cb40-313" aria-hidden="true" tabindex="-1"></a>FH does not run if there is any missing value in the auxiliary variables, and therefore, any variable with missing value should be removed in advance.</span>
<span id="cb40-314"><a href="#cb40-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-315"><a href="#cb40-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fh_model, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-316"><a href="#cb40-316" aria-hidden="true" tabindex="-1"></a>rowsNAcovariates <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">sapply</span>(fh_dt[,..candidate_vars], is.na))</span>
<span id="cb40-317"><a href="#cb40-317" aria-hidden="true" tabindex="-1"></a>fh_dt <span class="ot">&lt;-</span> fh_dt[rowsNAcovariates <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb40-318"><a href="#cb40-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-319"><a href="#cb40-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-320"><a href="#cb40-320" aria-hidden="true" tabindex="-1"></a><span class="fu">### Check multicollinearity</span></span>
<span id="cb40-321"><a href="#cb40-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-322"><a href="#cb40-322" aria-hidden="true" tabindex="-1"></a>With the help of the <span class="in">`step()`</span> function of package <span class="in">`emdi`</span>, we perform a variable selection based on the chosen variable selection criterion and directly get the model with fewer variables. The function <span class="in">`step_wrapper()`</span> implemented below is a wrapper to the <span class="in">`emdi::step()`</span> function and performs all the perfunctory cleaning necessary to use <span class="in">`step()`</span>. This includes dropping columns that are entirely missing (<span class="in">`NA`</span>) and keep only complete cases/observations (for the model selection only the in-sample domains are used) and remove perfectly or near collinear variables and combinations.</span>
<span id="cb40-323"><a href="#cb40-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-324"><a href="#cb40-324" aria-hidden="true" tabindex="-1"></a>We apply the function to select the variables. Required inputs: data set, character vector containing the set of auxiliary variables, name of y variable, a correlation threshold between 0 and 1, name of information criterion and name of direct variance variable. In case, a transformation should be applied, "arcsin" as transformation and name of variable that contains the effective sample size.</span>
<span id="cb40-325"><a href="#cb40-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-326"><a href="#cb40-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove_multicol, message = FALSE, warning = FALSE, results = "hide"}</span></span>
<span id="cb40-327"><a href="#cb40-327" aria-hidden="true" tabindex="-1"></a>fh_step <span class="ot">&lt;-</span> <span class="fu">step_wrapper_fh</span>(<span class="at">dt =</span> fh_dt,</span>
<span id="cb40-328"><a href="#cb40-328" aria-hidden="true" tabindex="-1"></a>                           <span class="at">xvars =</span> candidate_vars,</span>
<span id="cb40-329"><a href="#cb40-329" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> <span class="st">"direct_povrate"</span>,</span>
<span id="cb40-330"><a href="#cb40-330" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cor_thresh =</span> <span class="fl">0.7</span>,</span>
<span id="cb40-331"><a href="#cb40-331" aria-hidden="true" tabindex="-1"></a>                           <span class="at">criteria =</span> <span class="st">"BIC"</span>,</span>
<span id="cb40-332"><a href="#cb40-332" aria-hidden="true" tabindex="-1"></a>                           <span class="at">vardir =</span> <span class="st">"vardir"</span>, </span>
<span id="cb40-333"><a href="#cb40-333" aria-hidden="true" tabindex="-1"></a>                           <span class="at">transformation =</span> <span class="st">"arcsin"</span>, </span>
<span id="cb40-334"><a href="#cb40-334" aria-hidden="true" tabindex="-1"></a>                           <span class="at">eff_smpsize =</span> <span class="st">"n_eff"</span>)</span>
<span id="cb40-335"><a href="#cb40-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-336"><a href="#cb40-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-337"><a href="#cb40-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-338"><a href="#cb40-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove_multicol1, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-339"><a href="#cb40-339" aria-hidden="true" tabindex="-1"></a><span class="co"># Resulting model formula</span></span>
<span id="cb40-340"><a href="#cb40-340" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fh_step<span class="sc">$</span>fixed)</span>
<span id="cb40-341"><a href="#cb40-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-342"><a href="#cb40-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-343"><a href="#cb40-343" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model estimation of FH point and their MSE estimates.</span></span>
<span id="cb40-344"><a href="#cb40-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-345"><a href="#cb40-345" aria-hidden="true" tabindex="-1"></a>In this example, we use the function <span class="in">`fh`</span> to calculate the FH estimates. Because we want to estimate a ratio, we need to apply the arcsin transformation to guarantee that the results lie between 0 and 1. For that, we choose "arcsin" as <span class="in">`transformation`</span>, and a bias-corrected <span class="in">`backtransformation`</span> ("bc"). Additionally, the effective sample size, which equals the sample size of each area divided by the design effect, is needed for the arcsin transformation. We set the <span class="in">`MSE`</span> estimation to <span class="in">`TRUE`</span>, the <span class="in">`mse_type`</span> to "boot" (necessary for the type of transformation) and determine the number of bootstrap iterations. For practical applications, values larger than 200 are recommended. In case, no transformation is desired, the <span class="in">`transformation`</span> argument must be set to "no" and the inputs <span class="in">`backtransformation`</span> and <span class="in">`eff_smpsize`</span> are no longer needed.</span>
<span id="cb40-346"><a href="#cb40-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-347"><a href="#cb40-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model_est, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-348"><a href="#cb40-348" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb40-349"><a href="#cb40-349" aria-hidden="true" tabindex="-1"></a>fh_model <span class="ot">&lt;-</span> <span class="fu">fh</span>(<span class="at">fixed =</span> <span class="fu">formula</span>(fh_step<span class="sc">$</span>fixed),</span>
<span id="cb40-350"><a href="#cb40-350" aria-hidden="true" tabindex="-1"></a>               <span class="at">vardir =</span> <span class="st">"vardir"</span>, </span>
<span id="cb40-351"><a href="#cb40-351" aria-hidden="true" tabindex="-1"></a>               <span class="at">combined_data =</span> fh_dt, </span>
<span id="cb40-352"><a href="#cb40-352" aria-hidden="true" tabindex="-1"></a>               <span class="at">domains =</span> <span class="st">"Domain"</span>,</span>
<span id="cb40-353"><a href="#cb40-353" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"ml"</span>, </span>
<span id="cb40-354"><a href="#cb40-354" aria-hidden="true" tabindex="-1"></a>               <span class="at">transformation =</span> <span class="st">"arcsin"</span>, </span>
<span id="cb40-355"><a href="#cb40-355" aria-hidden="true" tabindex="-1"></a>               <span class="at">backtransformation =</span> <span class="st">"bc"</span>,</span>
<span id="cb40-356"><a href="#cb40-356" aria-hidden="true" tabindex="-1"></a>               <span class="at">eff_smpsize =</span> <span class="st">"n_eff"</span>, </span>
<span id="cb40-357"><a href="#cb40-357" aria-hidden="true" tabindex="-1"></a>               <span class="at">MSE =</span> <span class="cn">TRUE</span>, </span>
<span id="cb40-358"><a href="#cb40-358" aria-hidden="true" tabindex="-1"></a>               <span class="at">mse_type =</span> <span class="st">"boot"</span>, <span class="at">B =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">0</span>)) </span>
<span id="cb40-359"><a href="#cb40-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-360"><a href="#cb40-360" aria-hidden="true" tabindex="-1"></a><span class="do">## In case, no transformation is desired, the call would like this:</span></span>
<span id="cb40-361"><a href="#cb40-361" aria-hidden="true" tabindex="-1"></a><span class="co"># fh_model &lt;- fh(</span></span>
<span id="cb40-362"><a href="#cb40-362" aria-hidden="true" tabindex="-1"></a><span class="co">#   fixed = Direct ~ age2 + age3 + age4 + age5 + educ1 + ntl + schyrs, #formula(fh_step$fixed),</span></span>
<span id="cb40-363"><a href="#cb40-363" aria-hidden="true" tabindex="-1"></a><span class="co">#   vardir = "vardir", combined_data = comb_Data, domains = "Domain",</span></span>
<span id="cb40-364"><a href="#cb40-364" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "ml", MSE = TRUE) </span></span>
<span id="cb40-365"><a href="#cb40-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-366"><a href="#cb40-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-367"><a href="#cb40-367" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assessment of the estimated model.</span></span>
<span id="cb40-368"><a href="#cb40-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-369"><a href="#cb40-369" aria-hidden="true" tabindex="-1"></a>With the help of the <span class="in">`summary`</span> method of <span class="in">`emdi`</span>, we gain detailed insights into the data and model components. It includes information on the estimation methods used, the number of domains, the log-likelihood, and information criteria as proposed by @Marhuenda2014. It also reports the adjusted $R^2$ from a standard linear model and the adjusted $R^2$ specific to FH models, as introduced by @Lahiri2015. It also offers diagnostic measures to assess model assumptions regarding the standardized realized residuals and random effects. These include skewness and kurtosis (based on the <span class="in">`moments`</span> package by @Komsta2015), as well as Shapiro-Wilk test statistics and corresponding p-values to evaluate the normality of both error components.</span>
<span id="cb40-370"><a href="#cb40-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-371"><a href="#cb40-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summary, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-372"><a href="#cb40-372" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fh_model)</span>
<span id="cb40-373"><a href="#cb40-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-374"><a href="#cb40-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-375"><a href="#cb40-375" aria-hidden="true" tabindex="-1"></a>We can see, that 49 domains are in-sample domains. The 3 out-of-sample domains belong to the domains with 0 direct and variance estimates that we set to <span class="in">`NA`</span> in the beginning. The variance of the random effects equals 0.001516632. All of the included auxiliary variables are significant on a 0.05 significance level and their explanatory power is large with an adjusted $R^2$ (for FH models) of around 0.74. The results of the Shapiro-Wilk-test indicate that normality is not rejected for the standardized residuals.</span>
<span id="cb40-376"><a href="#cb40-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-377"><a href="#cb40-377" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostic plots</span></span>
<span id="cb40-378"><a href="#cb40-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-379"><a href="#cb40-379" aria-hidden="true" tabindex="-1"></a>We produce normal quantile-quantile (Q-Q) plots of the standardized realized residuals and random effects and plots of the kernel densities of the distribution of both error terms by the <span class="in">`plot`</span> method of <span class="in">`emdi`</span>.</span>
<span id="cb40-380"><a href="#cb40-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-381"><a href="#cb40-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot, warning = FALSE}</span></span>
<span id="cb40-382"><a href="#cb40-382" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fh_model)</span>
<span id="cb40-383"><a href="#cb40-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-384"><a href="#cb40-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-385"><a href="#cb40-385" aria-hidden="true" tabindex="-1"></a>The plots show slight deviations of the distributions from normality. The normality assumption is not required for the computation of the FH estimates, but at the obtained MSE estimates we have to look with some care when the normality assumption does not hold.</span>
<span id="cb40-386"><a href="#cb40-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-387"><a href="#cb40-387" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of the FH results with the direct estimates.</span></span>
<span id="cb40-388"><a href="#cb40-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-389"><a href="#cb40-389" aria-hidden="true" tabindex="-1"></a>The FH estimates are expected to align closely with the direct estimates in domains with small direct MSEs and/or large sample sizes. Moreover, incorporating auxiliary information should enhance the precision of the direct estimates. We produce a scatter plot proposed by @Brown2001 and a line plot. The fitted regression and the identity line of the scatter plot should not differ too much. The FH estimates should track the direct estimates within the line plot especially for domains with a large sample size/small MSE of the direct estimator. Furthermore, we compare the MSE and CV estimates for the direct and FH estimators using boxplots and ordered scatter plots (by setting the input arguments <span class="in">`MSE`</span> and <span class="in">`CV`</span> to <span class="in">`TRUE`</span>).</span>
<span id="cb40-390"><a href="#cb40-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-391"><a href="#cb40-391" aria-hidden="true" tabindex="-1"></a>Additionally, we compute a correlation coefficient of the direct estimates and the estimates of the regression-synthetic part of the FH model <span class="co">[</span><span class="ot">@Chandra2015</span><span class="co">]</span> and a goodness of fit diagnostic <span class="co">[</span><span class="ot">@Brown2001</span><span class="co">]</span>.</span>
<span id="cb40-392"><a href="#cb40-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-393"><a href="#cb40-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare, warning = FALSE}</span></span>
<span id="cb40-394"><a href="#cb40-394" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_plot</span>(fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-395"><a href="#cb40-395" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fh_model)</span>
<span id="cb40-396"><a href="#cb40-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-397"><a href="#cb40-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-398"><a href="#cb40-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-399"><a href="#cb40-399" aria-hidden="true" tabindex="-1"></a>The direct estimates are tracked by most of the FH estimates within the line plot. The precision of the direct estimates could be improved by the usage of the FH model in terms of MSEs and CVs. The null hypothesis of the Brown test is not rejected and the correlation coefficient indicates a positive correlation (0.66) between the direct and FH estimates.</span>
<span id="cb40-400"><a href="#cb40-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-401"><a href="#cb40-401" aria-hidden="true" tabindex="-1"></a>If the result of the model assessment is not satisfactory, the following should be checked again: Can the direct estimation including variance estimation be improved? Are there further auxiliary variables and/or must possible interaction effects be taken into account? Does a (different) transformation need to be used?</span>
<span id="cb40-402"><a href="#cb40-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-403"><a href="#cb40-403" aria-hidden="true" tabindex="-1"></a><span class="fu">## Benchmark the FH point estimates for consistency with higher results.</span></span>
<span id="cb40-404"><a href="#cb40-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-405"><a href="#cb40-405" aria-hidden="true" tabindex="-1"></a>Benchmarking is based on the principle that aggregated FH estimates should sum up to the estimates at a higher regional level. For the benchmark function, a benchmark value and a vector containing the shares of the population size per area ($N_d/N$) is required. Please note, that only the FH estimates are benchmarked and not their MSE estimates. As benchmark types "raking", "ratio" and "MSE_adj" can be chosen. For further details about using the function, please refer to the <span class="in">`emdi`</span> vignette and for general information about the benchmarking options to @Datta2011.</span>
<span id="cb40-406"><a href="#cb40-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-407"><a href="#cb40-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r benchmarking, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-408"><a href="#cb40-408" aria-hidden="true" tabindex="-1"></a><span class="do">## compute the benchmark value (mean of poverty indicator for the whole country)</span></span>
<span id="cb40-409"><a href="#cb40-409" aria-hidden="true" tabindex="-1"></a>benchmark_value <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(survey_dt<span class="sc">$</span>pov_indicator, survey_dt[[weight_var]])</span>
<span id="cb40-410"><a href="#cb40-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-411"><a href="#cb40-411" aria-hidden="true" tabindex="-1"></a><span class="do">## compute the share of population size in the total population size (N_d/N) per area</span></span>
<span id="cb40-412"><a href="#cb40-412" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"sizeprov"</span>)</span>
<span id="cb40-413"><a href="#cb40-413" aria-hidden="true" tabindex="-1"></a>fh_dt <span class="ot">&lt;-</span> fh_dt <span class="sc">|&gt;</span></span>
<span id="cb40-414"><a href="#cb40-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sizeprov <span class="sc">|&gt;</span></span>
<span id="cb40-415"><a href="#cb40-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio_n =</span> Nd<span class="sc">/</span><span class="fu">sum</span>(Nd)), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Domain"</span> <span class="ot">=</span> area_vars[<span class="dv">1</span>]))</span>
<span id="cb40-416"><a href="#cb40-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-417"><a href="#cb40-417" aria-hidden="true" tabindex="-1"></a>fh_bench <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(fh_model,</span>
<span id="cb40-418"><a href="#cb40-418" aria-hidden="true" tabindex="-1"></a>                      <span class="at">benchmark =</span> benchmark_value,</span>
<span id="cb40-419"><a href="#cb40-419" aria-hidden="true" tabindex="-1"></a>                      <span class="at">share =</span> fh_dt<span class="sc">$</span>ratio_n, </span>
<span id="cb40-420"><a href="#cb40-420" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type =</span> <span class="st">"ratio"</span>,</span>
<span id="cb40-421"><a href="#cb40-421" aria-hidden="true" tabindex="-1"></a>                      <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-422"><a href="#cb40-422" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fh_bench<span class="sc">$</span>ind)</span>
<span id="cb40-423"><a href="#cb40-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-424"><a href="#cb40-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-425"><a href="#cb40-425" aria-hidden="true" tabindex="-1"></a><span class="fu">## Preparation of the results.</span></span>
<span id="cb40-426"><a href="#cb40-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-427"><a href="#cb40-427" aria-hidden="true" tabindex="-1"></a>Create one dataframe that contains the direct and FH estimation results including MSE and CV results.</span>
<span id="cb40-428"><a href="#cb40-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-429"><a href="#cb40-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r res_prep, message = FALSE, warning = FALSE}</span></span>
<span id="cb40-430"><a href="#cb40-430" aria-hidden="true" tabindex="-1"></a>pov_fh <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">estimators</span>(fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span>))</span>
<span id="cb40-431"><a href="#cb40-431" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pov_fh)</span>
<span id="cb40-432"><a href="#cb40-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-433"><a href="#cb40-433" aria-hidden="true" tabindex="-1"></a>pov_fh <span class="ot">&lt;-</span> pov_fh <span class="sc">|&gt;</span></span>
<span id="cb40-434"><a href="#cb40-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="sc">!!</span>area_vars[<span class="dv">1</span>] <span class="sc">:</span><span class="er">=</span> <span class="st">"Domain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-435"><a href="#cb40-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> singleyear)</span>
<span id="cb40-436"><a href="#cb40-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-437"><a href="#cb40-437" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span></span>
<span id="cb40-438"><a href="#cb40-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_write</span>(<span class="at">x =</span> pov_fh,</span>
<span id="cb40-439"><a href="#cb40-439" aria-hidden="true" tabindex="-1"></a>            <span class="at">name =</span> <span class="st">"pov_fh"</span>,</span>
<span id="cb40-440"><a href="#cb40-440" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb40-441"><a href="#cb40-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-442"><a href="#cb40-442" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(pov_fh, <span class="st">"data/clean-example/pov_fh.csv"</span>)</span>
<span id="cb40-443"><a href="#cb40-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-444"><a href="#cb40-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-445"><a href="#cb40-445" aria-hidden="true" tabindex="-1"></a><span class="fu">### Poverty map</span></span>
<span id="cb40-446"><a href="#cb40-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-447"><a href="#cb40-447" aria-hidden="true" tabindex="-1"></a>With the help of geographical maps, the results can be presented in a user-friendly way and differences among the areas can be detected more easily. For the map, a shape file is reqired. The domain identifiers in the results object (<span class="in">`fh_model`</span>) need to match to the respective identifiers of the shape file. Therefore, we create a mapping table first and then produce the map by <span class="in">`emdi::map_plot`</span>.</span>
<span id="cb40-448"><a href="#cb40-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-449"><a href="#cb40-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-povmap, message = FALSE}</span></span>
<span id="cb40-450"><a href="#cb40-450" aria-hidden="true" tabindex="-1"></a><span class="do">## Create a suitable mapping table</span></span>
<span id="cb40-451"><a href="#cb40-451" aria-hidden="true" tabindex="-1"></a><span class="do">## Find the right order</span></span>
<span id="cb40-452"><a href="#cb40-452" aria-hidden="true" tabindex="-1"></a>domain_ord <span class="ot">&lt;-</span> <span class="fu">match</span>(shp_dt[[area_vars[<span class="dv">1</span>]]], fh_model<span class="sc">$</span>ind<span class="sc">$</span>Domain)</span>
<span id="cb40-453"><a href="#cb40-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-454"><a href="#cb40-454" aria-hidden="true" tabindex="-1"></a><span class="do">## Create the mapping table based on the order obtained above</span></span>
<span id="cb40-455"><a href="#cb40-455" aria-hidden="true" tabindex="-1"></a>map_tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pop_data_id =</span> fh_model<span class="sc">$</span>ind<span class="sc">$</span>Domain[domain_ord],</span>
<span id="cb40-456"><a href="#cb40-456" aria-hidden="true" tabindex="-1"></a>                      <span class="at">shape_id =</span> shp_dt[[area_vars[<span class="dv">1</span>]]])</span>
<span id="cb40-457"><a href="#cb40-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-458"><a href="#cb40-458" aria-hidden="true" tabindex="-1"></a><span class="do">## Create map</span></span>
<span id="cb40-459"><a href="#cb40-459" aria-hidden="true" tabindex="-1"></a><span class="fu">map_plot</span>(<span class="at">object =</span> fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">map_obj =</span> shp_dt,</span>
<span id="cb40-460"><a href="#cb40-460" aria-hidden="true" tabindex="-1"></a> <span class="at">map_dom_id =</span> area_vars[<span class="dv">1</span>], <span class="at">map_tab =</span> map_tab)</span>
<span id="cb40-461"><a href="#cb40-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-462"><a href="#cb40-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-463"><a href="#cb40-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-464"><a href="#cb40-464" aria-hidden="true" tabindex="-1"></a><span class="fu">## Saving the results.</span></span>
<span id="cb40-465"><a href="#cb40-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-466"><a href="#cb40-466" aria-hidden="true" tabindex="-1"></a>Either by using <span class="in">`save.image("fh_estimation.RData")`</span> or export of the model output and estimation results to Excel or OpenDocument spreadsheet (ODS) <span class="in">`write.excel(fh_model, file = "fh_model_output.xlsx", MSE = TRUE, CV = TRUE`</span>.</span>
<span id="cb40-467"><a href="#cb40-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-468"><a href="#cb40-468" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>