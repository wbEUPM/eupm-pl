<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ifeanyi Edochie">

<title>3&nbsp; Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach – EUPM: Poland</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./40-fh.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-be286771588e14c8ad07271603d9d425.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50-mfh.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">EUPM: Poland</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40-fh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot (UFH) model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50-mfh.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#stable-fh-estimators-over-t-time-periods-the-multivariate-fay-herriot-modelling-approach" id="toc-stable-fh-estimators-over-t-time-periods-the-multivariate-fay-herriot-modelling-approach" class="nav-link active" data-scroll-target="#stable-fh-estimators-over-t-time-periods-the-multivariate-fay-herriot-modelling-approach"><span class="header-section-number">4</span> Stable FH Estimators over T time periods: The Multivariate Fay Herriot Modelling Approach</a>
  <ul class="collapse">
  <li><a href="#mfh-estimation-of-poverty-rates-for-t-time-periods" id="toc-mfh-estimation-of-poverty-rates-for-t-time-periods" class="nav-link" data-scroll-target="#mfh-estimation-of-poverty-rates-for-t-time-periods"><span class="header-section-number">4.1</span> MFH Estimation of Poverty Rates for T time periods</a></li>
  <li><a href="#step-0-the-data-preparation-phase" id="toc-step-0-the-data-preparation-phase" class="nav-link" data-scroll-target="#step-0-the-data-preparation-phase"><span class="header-section-number">4.2</span> Step 0: The Data Preparation Phase</a></li>
  <li><a href="#step-1-direct-estimation-of-poverty-variance-covarance-matrix" id="toc-step-1-direct-estimation-of-poverty-variance-covarance-matrix" class="nav-link" data-scroll-target="#step-1-direct-estimation-of-poverty-variance-covarance-matrix"><span class="header-section-number">4.3</span> Step 1: Direct Estimation of Poverty &amp; Variance-Covarance Matrix</a>
  <ul class="collapse">
  <li><a href="#simple-direct-estimation" id="toc-simple-direct-estimation" class="nav-link" data-scroll-target="#simple-direct-estimation"><span class="header-section-number">4.3.1</span> Simple Direct Estimation</a></li>
  <li><a href="#computing-the-variance-covariance-matrix-for-the-sampling-error-of-the-direct-estimate" id="toc-computing-the-variance-covariance-matrix-for-the-sampling-error-of-the-direct-estimate" class="nav-link" data-scroll-target="#computing-the-variance-covariance-matrix-for-the-sampling-error-of-the-direct-estimate"><span class="header-section-number">4.3.2</span> Computing the Variance-Covariance Matrix for the Sampling Error of the Direct Estimate</a></li>
  </ul></li>
  <li><a href="#step-2-variable-preparation-and-model-selection" id="toc-step-2-variable-preparation-and-model-selection" class="nav-link" data-scroll-target="#step-2-variable-preparation-and-model-selection"><span class="header-section-number">4.4</span> Step 2: Variable Preparation and Model Selection</a>
  <ul class="collapse">
  <li><a href="#data-preparation-for-model-selection-mfh-estimation" id="toc-data-preparation-for-model-selection-mfh-estimation" class="nav-link" data-scroll-target="#data-preparation-for-model-selection-mfh-estimation"><span class="header-section-number">4.4.1</span> Data Preparation for Model Selection &amp; MFH estimation</a></li>
  <li><a href="#variable-selection-process" id="toc-variable-selection-process" class="nav-link" data-scroll-target="#variable-selection-process"><span class="header-section-number">4.4.2</span> Variable Selection Process</a></li>
  </ul></li>
  <li><a href="#step-3-fitting-the-multivariate-fay-herriot-model" id="toc-step-3-fitting-the-multivariate-fay-herriot-model" class="nav-link" data-scroll-target="#step-3-fitting-the-multivariate-fay-herriot-model"><span class="header-section-number">4.5</span> Step 3: Fitting the Multivariate Fay Herriot Model</a></li>
  <li><a href="#step-4-post-estimation-diagnostics-model-assumption-checks-for-linearity-normality-and-outliers" id="toc-step-4-post-estimation-diagnostics-model-assumption-checks-for-linearity-normality-and-outliers" class="nav-link" data-scroll-target="#step-4-post-estimation-diagnostics-model-assumption-checks-for-linearity-normality-and-outliers"><span class="header-section-number">4.6</span> Step 4: Post Estimation Diagnostics: Model Assumption Checks for Linearity, Normality and Outliers</a>
  <ul class="collapse">
  <li><a href="#linearity-test" id="toc-linearity-test" class="nav-link" data-scroll-target="#linearity-test"><span class="header-section-number">4.6.1</span> Linearity Test</a></li>
  <li><a href="#evaluating-the-normality-assumption" id="toc-evaluating-the-normality-assumption" class="nav-link" data-scroll-target="#evaluating-the-normality-assumption"><span class="header-section-number">4.6.2</span> Evaluating the Normality Assumption</a></li>
  <li><a href="#comparing-direct-estimation-to-multivariate-model-outputs" id="toc-comparing-direct-estimation-to-multivariate-model-outputs" class="nav-link" data-scroll-target="#comparing-direct-estimation-to-multivariate-model-outputs"><span class="header-section-number">4.6.3</span> Comparing Direct Estimation to Multivariate Model Outputs</a></li>
  <li><a href="#did-the-poverty-rates-change-over-time" id="toc-did-the-poverty-rates-change-over-time" class="nav-link" data-scroll-target="#did-the-poverty-rates-change-over-time"><span class="header-section-number">4.6.4</span> Did the poverty rates change over time?</a></li>
  <li><a href="#presenting-results" id="toc-presenting-results" class="nav-link" data-scroll-target="#presenting-results"><span class="header-section-number">4.6.5</span> Presenting Results</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ifeanyi Edochie </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="stable-fh-estimators-over-t-time-periods-the-multivariate-fay-herriot-modelling-approach" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Stable FH Estimators over T time periods: The Multivariate Fay Herriot Modelling Approach</h1>
<p>This section describes procedures that yield stable small area estimators for each of <span class="math inline">\(D\)</span> areas over <span class="math inline">\(T\)</span> subsequent time instants. Area populations, the samples and the data might change between time periods. Accordingly, we denote <span class="math inline">\(U_t\)</span> the overall population at time <span class="math inline">\(t\)</span>, which is partitioned into <span class="math inline">\(D\)</span> areas <span class="math inline">\(U_{1t}, ... ,U_{Dt}\)</span>, of respective population sizes <span class="math inline">\(N_{1t}\)</span></p>
<p>An overview of the MFH model estimation process is as follows:</p>
<ul>
<li><p>Step 0: The data preparation phase in which we prepare the 3 data objects needed for the small area estimation under the Multivariate Fay Herriot Model</p></li>
<li><p>Step 1: Compute the selected direct area estimators for each target area <span class="math inline">\(d = 1, ..., D\)</span> for each time <span class="math inline">\(t = 1, ..., T\)</span> and estimators of their corresponding sampling variances and covariances.</p></li>
<li><p>Step 2: Prepare variables (from administrative data or other sources of data representative at the target area level) at the level of the target area for each time instant in the MFH model. We present a simple approach which performs model selection in a pooled linear regression model without time effects.</p></li>
<li><p>Step 3: Fit the MFH models to test for homoskedastic area-time effects <span class="math inline">\(({\mu_d}_1, ... , {\mu_d}_T)\)</span> are homoskedastic or not. If we reject the homoskedasticity of variances, implement the MFH3 model. Otherwise, we proceed with the MFH2 model. For the purposes of this training, we assume a homoskedastic model for simplicity.</p></li>
<li><p>Step 4: Check the selected model assumptions, including linearity, normality of predicted area effects and standardized model residuals, and the presence of the outlying areas.</p></li>
<li><p>Step 5: In case of systematic model departures such as isolated departures because of outlying areas, some adjustments might need to be implemented before returning to Step 2 to recompute the MFH model.</p></li>
<li><p>Step 6: If model assumptions hold, using the above direct estimates and estimated sampling variances and covariances, and the selected auxiliary variables, compute MFH estimators <span class="math inline">\(\hat{\delta}_{dt}^{MFH},\quad d = 1,...,D\)</span> and <span class="math inline">\(t = 1, ..., T\)</span> and their corresponding estimated MSEs.</p></li>
</ul>
<p>We will show below the use of the <code>eblupMFH2()</code> and <code>eblupMFH3()</code> from the R package msae <span class="citation" data-cites="permatasari2022package">(<a href="#ref-permatasari2022package" role="doc-biblioref">Permatasari, Ubaidillah, and Permatasari 2022</a>)</span> compute the EBLUPs and their MSE estimates under the MFH models 2 and 3, respectively. The calls to these functions are:</p>
<p><code>eblupMFH2(formula, vardir, MAXITER = 100, PRECISION = 1e-04, data)</code></p>
<p><code>eblupMFH3(formula, vardir, MAXITER = 100, PRECISION = 1e-04, data)</code></p>
<section id="mfh-estimation-of-poverty-rates-for-t-time-periods" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="mfh-estimation-of-poverty-rates-for-t-time-periods"><span class="header-section-number">4.1</span> MFH Estimation of Poverty Rates for T time periods</h2>
<p>In this example, we use a synthetic data set adapted from R package <code>sae</code> called <code>incomedata</code>. The original data contains information for <span class="math inline">\(n = 17,119\)</span> fictitious individuals residing across <span class="math inline">\(D = 52\)</span> Spanish provinces. The variables include the name of the province of residence (<code>provlab</code>), province code (<code>prov</code>), as well as several correlates of income. We have added two additional income vectors corresponding to two additional years of data.</p>
<p>We will show how to estimate a poverty map for each year by using the Multivariate Fay Herriot modelling approach. This approach allows us to take advantage of the temporal correlation between poverty rates i.e.&nbsp;an individuals income in year <span class="math inline">\(t\)</span> is likely correlated with their income in year <span class="math inline">\(t+1\)</span>.</p>
<p>The rest of this tutorial shows how to prepare MFH models using a random 10% sample of the <code>incomedata</code> to estimate the poverty rates.</p>
</section>
<section id="step-0-the-data-preparation-phase" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="step-0-the-data-preparation-phase"><span class="header-section-number">4.2</span> Step 0: The Data Preparation Phase</h2>
<p>The MFH estimation process relies on 3 types of data:</p>
<ol type="1">
<li><p>The data containing the outcome variable from which direct estimates will be computed. This is a usually a survey dataset for each year of data including outcome variable (such as income or welfare aggregates), weights, cluster identifiers (i.e.&nbsp;if available, psu or enumeration areas) at the unit level i.e.&nbsp;individual or household. In this example, we call this: <code>survey_dt</code></p></li>
<li><p>A dataset containing for the right hand side (RHS) variables i.e.&nbsp;indicator estimates representative at the level of the target area for each year. This is often obtained from administrative data sources or geospatial data such as remotely sensed high resolution data. The final RHS dataset ought to include an area id, year and variables of interest. In this example, we call this <code>rhs_dt</code></p></li>
<li><p>Finally, a shapefile which spatially links each target area to their boundaries on a map. This will contain the area id as well as the geometry object which when visualized will show the shape of the areas in which poverty rates will be estimated. In this example, we call this <code>shp_dt</code></p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"pov_direct"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"sae_data"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"geometries"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is what our datasets look like. These are generally the variables</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 12,894
Columns: 7
$ provlab &lt;fct&gt; Alava, Alava, Alava, Alava, Alava, Alava, Alava, Alava, Alava,…
$ prov    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ weight  &lt;dbl&gt; 25977.699, 25977.699, 25977.699, 19471.566, 19471.566, 19471.5…
$ ea_id   &lt;int&gt; 101, 101, 101, 102, 102, 102, 103, 103, 103, 103, 103, 103, 10…
$ year    &lt;int&gt; 2012, 2013, 2014, 2012, 2013, 2014, 2012, 2012, 2012, 2012, 20…
$ income  &lt;dbl&gt; 5150.399, 5204.872, 5480.116, 27920.737, 28508.978, 31512.153,…
$ povline &lt;dbl&gt; 6477.484, 6515.865, 6515.865, 6477.484, 6515.865, 6515.865, 64…</code></pre>
</div>
</div>
<p><code>survey_dt</code> contains our target area identifiers (<code>provlab</code>, <code>prov</code>), the weight variable <code>weight</code>, the cluster id i.e.&nbsp;enumeration area or psu, <code>ea_id</code>, the year, <code>year</code>, the income variable <code>income</code> and the poverty line <code>poverty</code>. In this example, <code>survey_dt</code> of class <code>data.frame</code> is at the level of the individual. It could also be at the level of the household if poverty lines are evaluated at that level.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 156
Columns: 39
Groups: prov [52]
$ prov           &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, …
$ provlab        &lt;fct&gt; Alava, Albacete, Alicante, Almeria, Avila, Badajoz, Bal…
$ gen            &lt;dbl&gt; 1.591661, 1.512574, 1.531217, 1.379440, 1.469752, 1.412…
$ age2           &lt;dbl&gt; 0.10662920, 0.15809756, 0.09547348, 0.16773730, 0.00000…
$ age3           &lt;dbl&gt; 0.3874807, 0.4944282, 0.3547117, 0.4673372, 0.4989752, …
$ age4           &lt;dbl&gt; 0.245845529, 0.059850454, 0.174966688, 0.005694235, 0.1…
$ age5           &lt;dbl&gt; 0.19980439, 0.18429053, 0.23276281, 0.18630876, 0.27121…
$ educ1          &lt;dbl&gt; 0.21756579, 0.22430208, 0.38687301, 0.34254113, 0.40534…
$ educ2          &lt;dbl&gt; 0.2353839, 0.4386757, 0.3915053, 0.3840035, 0.3181650, …
$ educ3          &lt;dbl&gt; 0.32395951, 0.10794670, 0.07260912, 0.10053284, 0.20833…
$ nat1           &lt;dbl&gt; 0.9653883, 0.9837955, 0.9436051, 0.8789277, 1.0000000, …
$ labor1         &lt;dbl&gt; 0.3692168, 0.4513452, 0.4054253, 0.5191851, 0.4992434, …
$ labor2         &lt;dbl&gt; 0.000000000, 0.036094381, 0.047285012, 0.040264017, 0.0…
$ labor3         &lt;dbl&gt; 0.4076923, 0.2834849, 0.3982771, 0.2676284, 0.4326099, …
$ abs            &lt;dbl&gt; 0.84933922, -0.97816135, 0.98863150, 0.31350535, -1.419…
$ ntl            &lt;dbl&gt; 0.2091905, 1.1589425, -0.4210840, 1.5472493, -2.1440414…
$ aec            &lt;dbl&gt; 1.16518757, -0.55990121, -0.66408247, -0.70557145, 4.99…
$ schyrs         &lt;dbl&gt; 1.70993214, -0.96018920, -0.18004563, 0.22504016, -1.64…
$ mkt            &lt;dbl&gt; 2.5782541, -1.0468569, -0.2044435, -0.9811182, -1.08118…
$ age2_X_gen     &lt;dbl&gt; 0.15555592, 0.26628138, 0.15033171, 0.21079949, 0.00000…
$ age3_X_gen     &lt;dbl&gt; 0.6647560, 0.7222008, 0.5516074, 0.6262462, 0.7645003, …
$ age4_X_gen     &lt;dbl&gt; 0.36008687, 0.10298379, 0.26866795, 0.01138847, 0.26583…
$ age5_X_gen     &lt;dbl&gt; 0.35102165, 0.30664168, 0.35115346, 0.28723752, 0.37126…
$ educ1_X_gen    &lt;dbl&gt; 0.3687830, 0.3682332, 0.5879137, 0.5256249, 0.6863470, …
$ educ2_X_gen    &lt;dbl&gt; 0.4130652, 0.7220561, 0.6010236, 0.4517964, 0.4494350, …
$ educ3_X_gen    &lt;dbl&gt; 0.53779476, 0.16167700, 0.12157537, 0.15825036, 0.26582…
$ nat1_X_gen     &lt;dbl&gt; 1.557049, 1.480165, 1.453477, 1.206699, 1.469752, 1.376…
$ labor1_X_gen   &lt;dbl&gt; 0.6529375, 0.6858805, 0.5812196, 0.6455309, 0.7541068, …
$ labor2_X_gen   &lt;dbl&gt; 0.000000000, 0.072188761, 0.086971286, 0.040264017, 0.0…
$ labor3_X_gen   &lt;dbl&gt; 0.6667055, 0.4938971, 0.6423218, 0.4498768, 0.6474986, …
$ age2_X_educ3   &lt;dbl&gt; 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.0…
$ age3_X_educ3   &lt;dbl&gt; 0.18883381, 0.05231836, 0.02345535, 0.10053284, 0.00000…
$ age4_X_educ3   &lt;dbl&gt; 0.110497526, 0.036933029, 0.025056921, 0.000000000, 0.1…
$ age5_X_educ3   &lt;dbl&gt; 0.024628173, 0.018695319, 0.024096847, 0.000000000, 0.0…
$ nat1_X_educ3   &lt;dbl&gt; 0.32395951, 0.10794670, 0.06702616, 0.06418623, 0.20833…
$ labor1_X_educ3 &lt;dbl&gt; 0.274032897, 0.052318355, 0.036012387, 0.100532844, 0.1…
$ labor2_X_educ3 &lt;dbl&gt; 0.000000000, 0.000000000, 0.006859625, 0.000000000, 0.0…
$ labor3_X_educ3 &lt;dbl&gt; 0.049926612, 0.055628348, 0.029737105, 0.000000000, 0.0…
$ year           &lt;int&gt; 2012, 2012, 2012, 2012, 2012, 2012, 2012, 2012, 2012, 2…</code></pre>
</div>
</div>
<p>`<code>rhs_dt</code> is an object of class <code>data.frame</code> created at the level of the target area. It should contain the same target area identifiers as in <code>survey_dt</code> and the year variable <code>year</code>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 52
Columns: 3
$ prov     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…
$ provlab  &lt;fct&gt; Alava, Albacete, Alicante, Almeria, Avila, Badajoz, Baleares,…
$ geometry &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-2.858067 4..., MULTIPOLYGON (((…</code></pre>
</div>
</div>
<p><code>shp_dt</code> is an object of class <code>sf</code>, <code>data.frame</code> created at the level of the target area. This is the shapefile for the area of interest for which the poverty map will be estimated. It should contain the same target area ID found in <code>survey_dt</code> as well as <code>rhs_dt</code>.</p>
<p>A quick summary table on the data needs for the MFH model:</p>
<div class="cell">
<div class="cell-output-display">
<div id="usaacswvdp" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#usaacswvdp table {
  font-family: Arial;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#usaacswvdp thead, #usaacswvdp tbody, #usaacswvdp tfoot, #usaacswvdp tr, #usaacswvdp td, #usaacswvdp th {
  border-style: none;
}

#usaacswvdp p {
  margin: 0;
  padding: 0;
}

#usaacswvdp .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 12px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#usaacswvdp .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#usaacswvdp .gt_title {
  color: #333333;
  font-size: 16px;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#usaacswvdp .gt_subtitle {
  color: #333333;
  font-size: 12px;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#usaacswvdp .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#usaacswvdp .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#usaacswvdp .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#usaacswvdp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#usaacswvdp .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#usaacswvdp .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#usaacswvdp .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#usaacswvdp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#usaacswvdp .gt_spanner_row {
  border-bottom-style: hidden;
}

#usaacswvdp .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#usaacswvdp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#usaacswvdp .gt_from_md > :first-child {
  margin-top: 0;
}

#usaacswvdp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#usaacswvdp .gt_row {
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#usaacswvdp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#usaacswvdp .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#usaacswvdp .gt_row_group_first td {
  border-top-width: 2px;
}

#usaacswvdp .gt_row_group_first th {
  border-top-width: 2px;
}

#usaacswvdp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#usaacswvdp .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#usaacswvdp .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#usaacswvdp .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#usaacswvdp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#usaacswvdp .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#usaacswvdp .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#usaacswvdp .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#usaacswvdp .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#usaacswvdp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#usaacswvdp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#usaacswvdp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#usaacswvdp .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#usaacswvdp .gt_left {
  text-align: left;
}

#usaacswvdp .gt_center {
  text-align: center;
}

#usaacswvdp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#usaacswvdp .gt_font_normal {
  font-weight: normal;
}

#usaacswvdp .gt_font_bold {
  font-weight: bold;
}

#usaacswvdp .gt_font_italic {
  font-style: italic;
}

#usaacswvdp .gt_super {
  font-size: 65%;
}

#usaacswvdp .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#usaacswvdp .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#usaacswvdp .gt_indent_1 {
  text-indent: 5px;
}

#usaacswvdp .gt_indent_2 {
  text-indent: 10px;
}

#usaacswvdp .gt_indent_3 {
  text-indent: 15px;
}

#usaacswvdp .gt_indent_4 {
  text-indent: 20px;
}

#usaacswvdp .gt_indent_5 {
  text-indent: 25px;
}

#usaacswvdp .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#usaacswvdp div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_heading header">
<th colspan="3" class="gt_heading gt_title gt_font_normal"><strong>Data Input Checklist for the Multivariate Fay-Herriot Model</strong></th>
</tr>
<tr class="gt_heading even">
<th colspan="3" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border"><em>Datasets, levels, and Required variables</em></th>
</tr>
<tr class="gt_col_headings header">
<th id="Dataset" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Dataset Name</th>
<th id="Unit-of-Observation" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Unit of Observation</th>
<th id="Required-Variables" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Required Variables</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Dataset"><code>survey_dt</code></td>
<td class="gt_row gt_left" headers="Unit of Observation">Individual (or Household)</td>
<td class="gt_row gt_left" headers="Required Variables"><code>target area identifiers</code>, <code>weights</code>, <code>cluster identifier</code>, year, <code>income/welfare variable</code>, <code>poverty line</code></td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Dataset"><code>rhs_dt</code></td>
<td class="gt_row gt_left" headers="Unit of Observation">Target Area (e.g.&nbsp;Province)</td>
<td class="gt_row gt_left" headers="Required Variables"><code>target area identifiers</code>, <code>year</code>, <code>covariates</code> (e.g.&nbsp;<code>gen</code>, <code>educ1</code>, <code>schyrs</code>, etc.)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Dataset"><code>shp_dt</code></td>
<td class="gt_row gt_left" headers="Unit of Observation">Target Area (Spatial)</td>
<td class="gt_row gt_left" headers="Required Variables"><code>target area identifiers</code>, <code>geometries</code> (e.g.&nbsp;<code>geometry</code> column from <code>sf</code>)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For ease of use of this tutorial, make sure the variable names match as described across the datasets i.e.&nbsp;use the same target area variables and year variable name across all 3 datasets.</p>
</section>
<section id="step-1-direct-estimation-of-poverty-variance-covarance-matrix" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="step-1-direct-estimation-of-poverty-variance-covarance-matrix"><span class="header-section-number">4.3</span> Step 1: Direct Estimation of Poverty &amp; Variance-Covarance Matrix</h2>
<p>We will use the direct HT estimators that use the survey weights in <code>weight</code> variable. First, we calculate the total sample size, the number of provinces, the sample sizes for each province and extract the population sizes for each province/target area from the <code>sizeprov</code> file. For those using the household/individual level survey data, this may be obtained from the sum of the household or individual weights as appropriate.</p>
<section id="simple-direct-estimation" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="simple-direct-estimation"><span class="header-section-number">4.3.1</span> Simple Direct Estimation</h3>
<p>The goal is simply to apply the poverty line to the</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">### a little bit of housekeeping to ensure ease of access </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>area_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"prov"</span>, <span class="st">"provlab"</span>) <span class="do">### both variables are at the same level. if the levels vary, you would need to combine both variables for effect use</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>cluster_var <span class="ot">&lt;-</span> <span class="st">"ea_id"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>weight_var <span class="ot">&lt;-</span> <span class="st">"weight"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>year_var <span class="ot">&lt;-</span> <span class="st">"year"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>outcome_var <span class="ot">&lt;-</span> <span class="st">"income"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>povline_var <span class="ot">&lt;-</span> <span class="st">"povline"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(rhs_dt)[<span class="sc">!</span><span class="fu">colnames</span>(rhs_dt) <span class="sc">%in%</span> <span class="fu">c</span>(area_vars, year_var)]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="do">### quickly compute the sample size for each province</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>sampsize_dt <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars), <span class="sc">!!</span><span class="fu">sym</span>(year_var)) <span class="sc">|&gt;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">N =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="do">## the poverty line for each is already included within the data. </span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Lets compute the direct estimates for each year of data and create a list of data.frames (equal in length to the number of years) </span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="do">## containing the direct estimate, the standard errors and the coefficient of variation. </span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pov_indicator =</span> <span class="fu">ifelse</span>(income <span class="sc">&lt;</span> povline, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars), <span class="sc">!!</span><span class="fu">sym</span>(year_var)) <span class="sc">|&gt;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">direct_povrate =</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> pov_indicator, </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> <span class="sc">!!</span><span class="fu">sym</span>(weight_var),</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the results look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>direct_dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 156 × 4
    prov provlab   year direct_povrate
   &lt;int&gt; &lt;fct&gt;    &lt;int&gt;          &lt;dbl&gt;
 1     1 Alava     2012          0.244
 2     1 Alava     2013          0.312
 3     1 Alava     2014          0.414
 4     2 Albacete  2012          0.159
 5     2 Albacete  2013          0.173
 6     2 Albacete  2014          0.211
 7     3 Alicante  2012          0.163
 8     3 Alicante  2013          0.163
 9     3 Alicante  2014          0.227
10     4 Almeria   2012          0.297
# ℹ 146 more rows</code></pre>
</div>
</div>
</section>
<section id="computing-the-variance-covariance-matrix-for-the-sampling-error-of-the-direct-estimate" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="computing-the-variance-covariance-matrix-for-the-sampling-error-of-the-direct-estimate"><span class="header-section-number">4.3.2</span> Computing the Variance-Covariance Matrix for the Sampling Error of the Direct Estimate</h3>
<p>Next, we quickly estimate the sample variance and covariance for the direct estimator using the survey R package as below. We apply the <code>compute_vcov()</code> function which we have created as a wrapper on the <code>survey::svymean()</code> and <code>survey::svyvar()</code> functions to estimate the variance covariance matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pov_indicator =</span> <span class="fu">ifelse</span>(<span class="sc">!!</span><span class="fu">sym</span>(outcome_var) <span class="sc">&lt;</span> <span class="sc">!!</span><span class="fu">sym</span>(povline_var), <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="do">### we need to reconstruct the variables from long to wide for this</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="do">### this wide format will also be useful for estimating the MFH model as well </span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">### later on</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>widesurvey_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars), <span class="sc">!!</span><span class="fu">sym</span>(cluster_var), <span class="sc">!!</span><span class="fu">sym</span>(weight_var)),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> <span class="sc">!!</span><span class="fu">sym</span>(year_var),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(<span class="sc">!!</span><span class="fu">sym</span>(outcome_var), <span class="sc">!!</span><span class="fu">sym</span>(povline_var), <span class="st">"pov_indicator"</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"{.value}{year}"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> first</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### now we are ready to compute the variance covariance matrix</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="do">### notice that we have to specify the new column names for the pov_indicator variables as they recreated in widesurvey_dt</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compute_vcov</span>(<span class="at">dt =</span> widesurvey_dt,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">domain =</span> area_vars[[<span class="dv">1</span>]],</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">ids =</span> cluster_var,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> weight_var,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">yvars =</span> <span class="fu">paste0</span>(<span class="st">"pov_indicator"</span>, <span class="fu">unique</span>(survey_dt[[year_var]]))) </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  var_dt <span class="sc">|&gt;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="st">"domain"</span>) <span class="do">### quick rename the domain variable to match our area_vars</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="do">### lets merge in our sample sizes</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  var_dt <span class="sc">|&gt;</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(sampsize_dt <span class="sc">%&gt;%</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[<span class="dv">1</span>]), <span class="st">"N"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unique</span>(), </span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is noteworthy that the <code>var_dt</code> object is estimated at the level of the target area. Hence, for reasons that will be made self-evident later, the <code>var_dt</code> is not a matrix for each area rather the matrix is stored rowwise.</p>
<section id="handling-low-sample-sizes-variance-smoothing" class="level4" data-number="4.3.2.1">
<h4 data-number="4.3.2.1" class="anchored" data-anchor-id="handling-low-sample-sizes-variance-smoothing"><span class="header-section-number">4.3.2.1</span> Handling Low Sample Sizes: Variance Smoothing</h4>
<p>A quick inspection of the preceding results will show some provinces contain low sample sizes which sometimes result in extreme value poverty rates and hence 0 variance. To avoid this, we will show you how to apply the variance smoothing method suggested by <span class="citation" data-cites="you2023application">(<a href="#ref-you2023application" role="doc-biblioref">You and Hidiroglou 2023</a>)</span>. Please see the code and Roxygen comments below explaining the use of the <code>varsmoothie_king()</code> function which computes smoothed variances.</p>
<p>The goal now is to use the above <code>varsmoothie_king()</code> function to add additional columns of smoothed variances into our <code>var_dt</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>varcols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^v_"</span>, <span class="fu">names</span>(var_dt), <span class="at">value =</span> <span class="cn">TRUE</span>) <span class="do">## the column names for the variance covariance matrix</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="at">X =</span> varcols,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>           z <span class="ot">&lt;-</span> <span class="fu">varsmoothie_king</span>(<span class="at">domain =</span> var_dt[[area_vars[<span class="dv">1</span>]]],</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">direct_var =</span> var_dt[[x]],</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sampsize =</span> var_dt[[<span class="st">"N"</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as.data.table</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">setnames</span>(<span class="at">old =</span> <span class="st">"var_smooth"</span>, <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"vs"</span>, x)) <span class="sc">|&gt;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as_tibble</span>()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span>(z)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>         }) <span class="sc">%&gt;%</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="at">f =</span> <span class="st">"merge"</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">x =</span> var_dt,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> .,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.x =</span> area_vars[[<span class="dv">1</span>]],</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.y =</span> <span class="st">"Domain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, you can replace the zero/near zero sample size area MSEs with their smoothed variances.</p>
</section>
</section>
</section>
<section id="step-2-variable-preparation-and-model-selection" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="step-2-variable-preparation-and-model-selection"><span class="header-section-number">4.4</span> Step 2: Variable Preparation and Model Selection</h2>
<section id="data-preparation-for-model-selection-mfh-estimation" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="data-preparation-for-model-selection-mfh-estimation"><span class="header-section-number">4.4.1</span> Data Preparation for Model Selection &amp; MFH estimation</h3>
<p>Thus far, we have careful set up the types of data we require for the MFH model. One final step of variable preparation is necessary to use the <code>eblupUFH</code> and <code>eblupMFH</code> functions. This requires that we reshape the set of candidate variables dataset i.e.&nbsp;the <code>rhs_dt</code> object into wide format. We will also have to reshape our direct estimates and merge this into <code>rhs_dt</code> as well as <code>var_dt</code>. All the data we have created thus far needs to be placed together ultimately for the EBLUP estimation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## reshaping the rhs_dt from long to wide</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>widerhs_dt <span class="ot">&lt;-</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  rhs_dt <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(area_vars),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(year_var),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(candidate_vars),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"{.value}{year}"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> \(x) dplyr<span class="sc">::</span><span class="fu">first</span>(x)  <span class="co"># or `first`, or something more explicit if needed</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="do">## now let us reshape and merge in the poverty rates</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="ot">&lt;-</span> </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  direct_dt <span class="sc">|&gt;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(area_vars),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(year_var),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="st">"direct_povrate"</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"{.value}{year}"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> \(x) dplyr<span class="sc">::</span><span class="fu">first</span>(x)  <span class="co"># or `first`, or something more explicit if neede</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">y =</span> widerhs_dt,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">y =</span> var_dt,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the data looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 52
Columns: 127
$ prov                                   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, …
$ provlab.x                              &lt;fct&gt; Alava, Albacete, Alicante, Alme…
$ direct_povrate2012                     &lt;dbl&gt; 0.24394059, 0.15913215, 0.16294…
$ direct_povrate2013                     &lt;dbl&gt; 0.31179047, 0.17325814, 0.16268…
$ direct_povrate2014                     &lt;dbl&gt; 0.41422988, 0.21133345, 0.22727…
$ provlab.y                              &lt;fct&gt; Alava, Albacete, Alicante, Alme…
$ gen2012                                &lt;dbl&gt; 1.591661, 1.512574, 1.531217, 1…
$ gen2013                                &lt;dbl&gt; 1.591661, 1.512574, 1.531217, 1…
$ gen2014                                &lt;dbl&gt; 1.591661, 1.512574, 1.531217, 1…
$ age22012                               &lt;dbl&gt; 0.10662920, 0.15809756, 0.09547…
$ age22013                               &lt;dbl&gt; 0.10662920, 0.15809756, 0.09547…
$ age22014                               &lt;dbl&gt; 0.10662920, 0.15809756, 0.09547…
$ age32012                               &lt;dbl&gt; 0.3874807, 0.4944282, 0.3547117…
$ age32013                               &lt;dbl&gt; 0.3874807, 0.4944282, 0.3547117…
$ age32014                               &lt;dbl&gt; 0.3874807, 0.4944282, 0.3547117…
$ age42012                               &lt;dbl&gt; 0.245845529, 0.059850454, 0.174…
$ age42013                               &lt;dbl&gt; 0.245845529, 0.059850454, 0.174…
$ age42014                               &lt;dbl&gt; 0.245845529, 0.059850454, 0.174…
$ age52012                               &lt;dbl&gt; 0.19980439, 0.18429053, 0.23276…
$ age52013                               &lt;dbl&gt; 0.19980439, 0.18429053, 0.23276…
$ age52014                               &lt;dbl&gt; 0.19980439, 0.18429053, 0.23276…
$ educ12012                              &lt;dbl&gt; 0.21756579, 0.22430208, 0.38687…
$ educ12013                              &lt;dbl&gt; 0.21756579, 0.22430208, 0.38687…
$ educ12014                              &lt;dbl&gt; 0.21756579, 0.22430208, 0.38687…
$ educ22012                              &lt;dbl&gt; 0.2353839, 0.4386757, 0.3915053…
$ educ22013                              &lt;dbl&gt; 0.2353839, 0.4386757, 0.3915053…
$ educ22014                              &lt;dbl&gt; 0.2353839, 0.4386757, 0.3915053…
$ educ32012                              &lt;dbl&gt; 0.32395951, 0.10794670, 0.07260…
$ educ32013                              &lt;dbl&gt; 0.32395951, 0.10794670, 0.07260…
$ educ32014                              &lt;dbl&gt; 0.32395951, 0.10794670, 0.07260…
$ nat12012                               &lt;dbl&gt; 0.9653883, 0.9837955, 0.9436051…
$ nat12013                               &lt;dbl&gt; 0.9653883, 0.9837955, 0.9436051…
$ nat12014                               &lt;dbl&gt; 0.9653883, 0.9837955, 0.9436051…
$ labor12012                             &lt;dbl&gt; 0.3692168, 0.4513452, 0.4054253…
$ labor12013                             &lt;dbl&gt; 0.3692168, 0.4513452, 0.4054253…
$ labor12014                             &lt;dbl&gt; 0.3692168, 0.4513452, 0.4054253…
$ labor22012                             &lt;dbl&gt; 0.000000000, 0.036094381, 0.047…
$ labor22013                             &lt;dbl&gt; 0.000000000, 0.036094381, 0.047…
$ labor22014                             &lt;dbl&gt; 0.000000000, 0.036094381, 0.047…
$ labor32012                             &lt;dbl&gt; 0.4076923, 0.2834849, 0.3982771…
$ labor32013                             &lt;dbl&gt; 0.4076923, 0.2834849, 0.3982771…
$ labor32014                             &lt;dbl&gt; 0.4076923, 0.2834849, 0.3982771…
$ abs2012                                &lt;dbl&gt; 0.84933922, -0.97816135, 0.9886…
$ abs2013                                &lt;dbl&gt; 0.84933922, -0.97816135, 0.9886…
$ abs2014                                &lt;dbl&gt; 0.84933922, -0.97816135, 0.9886…
$ ntl2012                                &lt;dbl&gt; 0.2091905, 1.1589425, -0.421084…
$ ntl2013                                &lt;dbl&gt; 0.2091905, 1.1589425, -0.421084…
$ ntl2014                                &lt;dbl&gt; 0.2091905, 1.1589425, -0.421084…
$ aec2012                                &lt;dbl&gt; 1.16518757, -0.55990121, -0.664…
$ aec2013                                &lt;dbl&gt; 1.16518757, -0.55990121, -0.664…
$ aec2014                                &lt;dbl&gt; 1.16518757, -0.55990121, -0.664…
$ schyrs2012                             &lt;dbl&gt; 1.70993214, -0.96018920, -0.180…
$ schyrs2013                             &lt;dbl&gt; 1.70993214, -0.96018920, -0.180…
$ schyrs2014                             &lt;dbl&gt; 1.70993214, -0.96018920, -0.180…
$ mkt2012                                &lt;dbl&gt; 2.5782541, -1.0468569, -0.20444…
$ mkt2013                                &lt;dbl&gt; 2.5782541, -1.0468569, -0.20444…
$ mkt2014                                &lt;dbl&gt; 2.5782541, -1.0468569, -0.20444…
$ age2_X_gen2012                         &lt;dbl&gt; 0.15555592, 0.26628138, 0.15033…
$ age2_X_gen2013                         &lt;dbl&gt; 0.15555592, 0.26628138, 0.15033…
$ age2_X_gen2014                         &lt;dbl&gt; 0.15555592, 0.26628138, 0.15033…
$ age3_X_gen2012                         &lt;dbl&gt; 0.6647560, 0.7222008, 0.5516074…
$ age3_X_gen2013                         &lt;dbl&gt; 0.6647560, 0.7222008, 0.5516074…
$ age3_X_gen2014                         &lt;dbl&gt; 0.6647560, 0.7222008, 0.5516074…
$ age4_X_gen2012                         &lt;dbl&gt; 0.36008687, 0.10298379, 0.26866…
$ age4_X_gen2013                         &lt;dbl&gt; 0.36008687, 0.10298379, 0.26866…
$ age4_X_gen2014                         &lt;dbl&gt; 0.36008687, 0.10298379, 0.26866…
$ age5_X_gen2012                         &lt;dbl&gt; 0.35102165, 0.30664168, 0.35115…
$ age5_X_gen2013                         &lt;dbl&gt; 0.35102165, 0.30664168, 0.35115…
$ age5_X_gen2014                         &lt;dbl&gt; 0.35102165, 0.30664168, 0.35115…
$ educ1_X_gen2012                        &lt;dbl&gt; 0.3687830, 0.3682332, 0.5879137…
$ educ1_X_gen2013                        &lt;dbl&gt; 0.3687830, 0.3682332, 0.5879137…
$ educ1_X_gen2014                        &lt;dbl&gt; 0.3687830, 0.3682332, 0.5879137…
$ educ2_X_gen2012                        &lt;dbl&gt; 0.4130652, 0.7220561, 0.6010236…
$ educ2_X_gen2013                        &lt;dbl&gt; 0.4130652, 0.7220561, 0.6010236…
$ educ2_X_gen2014                        &lt;dbl&gt; 0.4130652, 0.7220561, 0.6010236…
$ educ3_X_gen2012                        &lt;dbl&gt; 0.53779476, 0.16167700, 0.12157…
$ educ3_X_gen2013                        &lt;dbl&gt; 0.53779476, 0.16167700, 0.12157…
$ educ3_X_gen2014                        &lt;dbl&gt; 0.53779476, 0.16167700, 0.12157…
$ nat1_X_gen2012                         &lt;dbl&gt; 1.557049, 1.480165, 1.453477, 1…
$ nat1_X_gen2013                         &lt;dbl&gt; 1.557049, 1.480165, 1.453477, 1…
$ nat1_X_gen2014                         &lt;dbl&gt; 1.557049, 1.480165, 1.453477, 1…
$ labor1_X_gen2012                       &lt;dbl&gt; 0.6529375, 0.6858805, 0.5812196…
$ labor1_X_gen2013                       &lt;dbl&gt; 0.6529375, 0.6858805, 0.5812196…
$ labor1_X_gen2014                       &lt;dbl&gt; 0.6529375, 0.6858805, 0.5812196…
$ labor2_X_gen2012                       &lt;dbl&gt; 0.000000000, 0.072188761, 0.086…
$ labor2_X_gen2013                       &lt;dbl&gt; 0.000000000, 0.072188761, 0.086…
$ labor2_X_gen2014                       &lt;dbl&gt; 0.000000000, 0.072188761, 0.086…
$ labor3_X_gen2012                       &lt;dbl&gt; 0.6667055, 0.4938971, 0.6423218…
$ labor3_X_gen2013                       &lt;dbl&gt; 0.6667055, 0.4938971, 0.6423218…
$ labor3_X_gen2014                       &lt;dbl&gt; 0.6667055, 0.4938971, 0.6423218…
$ age2_X_educ32012                       &lt;dbl&gt; 0.000000000, 0.000000000, 0.000…
$ age2_X_educ32013                       &lt;dbl&gt; 0.000000000, 0.000000000, 0.000…
$ age2_X_educ32014                       &lt;dbl&gt; 0.000000000, 0.000000000, 0.000…
$ age3_X_educ32012                       &lt;dbl&gt; 0.18883381, 0.05231836, 0.02345…
$ age3_X_educ32013                       &lt;dbl&gt; 0.18883381, 0.05231836, 0.02345…
$ age3_X_educ32014                       &lt;dbl&gt; 0.18883381, 0.05231836, 0.02345…
$ age4_X_educ32012                       &lt;dbl&gt; 0.110497526, 0.036933029, 0.025…
$ age4_X_educ32013                       &lt;dbl&gt; 0.110497526, 0.036933029, 0.025…
$ age4_X_educ32014                       &lt;dbl&gt; 0.110497526, 0.036933029, 0.025…
$ age5_X_educ32012                       &lt;dbl&gt; 0.024628173, 0.018695319, 0.024…
$ age5_X_educ32013                       &lt;dbl&gt; 0.024628173, 0.018695319, 0.024…
$ age5_X_educ32014                       &lt;dbl&gt; 0.024628173, 0.018695319, 0.024…
$ nat1_X_educ32012                       &lt;dbl&gt; 0.32395951, 0.10794670, 0.06702…
$ nat1_X_educ32013                       &lt;dbl&gt; 0.32395951, 0.10794670, 0.06702…
$ nat1_X_educ32014                       &lt;dbl&gt; 0.32395951, 0.10794670, 0.06702…
$ labor1_X_educ32012                     &lt;dbl&gt; 0.274032897, 0.052318355, 0.036…
$ labor1_X_educ32013                     &lt;dbl&gt; 0.274032897, 0.052318355, 0.036…
$ labor1_X_educ32014                     &lt;dbl&gt; 0.274032897, 0.052318355, 0.036…
$ labor2_X_educ32012                     &lt;dbl&gt; 0.000000000, 0.000000000, 0.006…
$ labor2_X_educ32013                     &lt;dbl&gt; 0.000000000, 0.000000000, 0.006…
$ labor2_X_educ32014                     &lt;dbl&gt; 0.000000000, 0.000000000, 0.006…
$ labor3_X_educ32012                     &lt;dbl&gt; 0.049926612, 0.055628348, 0.029…
$ labor3_X_educ32013                     &lt;dbl&gt; 0.049926612, 0.055628348, 0.029…
$ labor3_X_educ32014                     &lt;dbl&gt; 0.049926612, 0.055628348, 0.029…
$ v_pov_indicator2012pov_indicator2012   &lt;dbl&gt; 0.0098654852, 0.0072993525, 0.0…
$ v_pov_indicator2013pov_indicator2013   &lt;dbl&gt; 0.0053009986, 0.0067381016, 0.0…
$ v_pov_indicator2014pov_indicator2014   &lt;dbl&gt; 0.0093328620, 0.0023188905, 0.0…
$ v_pov_indicator2012pov_indicator2013   &lt;dbl&gt; 0.0058723217, 0.0069408865, 0.0…
$ v_pov_indicator2012pov_indicator2014   &lt;dbl&gt; 0.0070770971, 0.0030800647, 0.0…
$ v_pov_indicator2013pov_indicator2014   &lt;dbl&gt; 0.0048793230, 0.0030653366, 0.0…
$ N                                      &lt;int&gt; 24, 43, 135, 50, 14, 124, 158, …
$ vsv_pov_indicator2012pov_indicator2012 &lt;dbl&gt; 0.0097321234, 0.0053156454, 0.0…
$ vsv_pov_indicator2013pov_indicator2013 &lt;dbl&gt; 0.009595262, 0.005426157, 0.001…
$ vsv_pov_indicator2014pov_indicator2014 &lt;dbl&gt; 0.0090107365, 0.0055231048, 0.0…
$ vsv_pov_indicator2012pov_indicator2013 &lt;dbl&gt; 0.0089483129, 0.0050001825, 0.0…
$ vsv_pov_indicator2012pov_indicator2014 &lt;dbl&gt; 0.0073280234, 0.0040019268, 0.0…
$ vsv_pov_indicator2013pov_indicator2014 &lt;dbl&gt; 0.0068160750, 0.0036177536, 0.0…</code></pre>
</div>
</div>
</section>
<section id="variable-selection-process" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="variable-selection-process"><span class="header-section-number">4.4.2</span> Variable Selection Process</h3>
<p>Next, we apply a simple variable selection process which employs the stepwise regression algorithm using the AIC selection criteria as in described by <span class="citation" data-cites="yamashita2007stepwise">(<a href="#ref-yamashita2007stepwise" role="doc-biblioref">Yamashita, Yamashita, and Kamimura 2007</a>)</span>. The function <code>step_wrapper()</code> implemented below is a wrapper to the <code>stepAIC()</code> function carries all the perfunctory cleaning necessary use the <code>stepAIC()</code> function. This includes dropping columns that are entirely missing (<code>NA</code>) and keep only complete cases/observations and remove perfectly or near collinear variables and combinations using the variance inflation method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand.grid</span>(<span class="at">var =</span> candidate_vars,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">year =</span> <span class="fu">unique</span>(survey_dt[[year_var]])) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">name =</span> <span class="fu">paste0</span>(var, year)) <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="do">## extract the year identifiers in each variance covariance name</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>varyear_list <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_extract_all</span>(varcols, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Keep only those where both years are the same i.e. the variances</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>variance_cols <span class="ot">&lt;-</span> varcols[<span class="fu">lengths</span>(varyear_list) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sapply</span>(varyear_list, <span class="cf">function</span>(x) x[<span class="dv">1</span>] <span class="sc">==</span> x[<span class="dv">2</span>])]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="do">## replace the variances-covariances that are zero or near zero with their smoothed counterparts</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="ot">&lt;-</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  mfh_dt <span class="sc">|&gt;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"v_"</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">abs</span>(.x) <span class="sc">&lt;=</span> <span class="fl">1e-4</span>, <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"vsv"</span>, <span class="fu">str_remove</span>(<span class="fu">cur_column</span>(), <span class="st">"^v"</span>))), .x),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">.names =</span> <span class="st">"{.col}"</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>fh_step <span class="ot">&lt;-</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="at">X =</span> <span class="fu">paste0</span>(<span class="st">"direct_povrate"</span>, <span class="fu">unique</span>(survey_dt[[year_var]])),</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>           model_obj <span class="ot">&lt;-</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>           <span class="fu">step_wrapper</span>(<span class="at">dt =</span> mfh_dt,</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>                        <span class="at">xvars =</span> candidate_vars,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> x,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cor_thresh =</span> <span class="fl">0.7</span>,</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">k =</span> <span class="fu">log</span>(<span class="fu">nrow</span>(mfh_dt))) <span class="do">### using log(n) to force BIC selection</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>           xx <span class="ot">&lt;-</span> <span class="fu">names</span>(model_obj<span class="sc">$</span>coefficients)[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"(Intercept)"</span>,</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>                                                      <span class="fu">names</span>(model_obj<span class="sc">$</span>coefficients))]</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span>(xx)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>         })</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="co"># mfh_formula &lt;- </span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   mapply(x = paste0("direct_povrate", unique(survey_dt[[year_var]])),</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co">#          y = variance_cols,</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">#          FUN = function(x, y){</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="co">#            </span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="co">#            fh_step &lt;- step_wrapper_fh(dt = mfh_dt,</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       xvars = candidate_vars,</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       y = x,</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       cor_thresh = 0.8,</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       criteria = "BIC",</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       vardir = y,</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       transformation = "no")</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a><span class="co">#            </span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co">#            return(fh_step$fixed)</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="co">#          },</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="co">#          SIMPLIFY = FALSE)</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>mfh_formula <span class="ot">&lt;-</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapply</span>(<span class="at">FUN =</span> <span class="cf">function</span>(x, rhs){</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(x, <span class="st">" ~ "</span>, <span class="fu">paste</span>(rhs, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"direct_povrate"</span>, <span class="fu">unique</span>(survey_dt[[year_var]])),</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">rhs =</span> fh_step <span class="sc">|&gt;</span> <span class="fu">map</span>(<span class="sc">~</span>.x[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]),</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="do">### here is what the 3 equations look like</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>mfh_formula</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$direct_povrate2012
direct_povrate2012 ~ age52012 + labor12012 + labor22012
&lt;environment: 0x0000022891eb0af8&gt;

$direct_povrate2013
direct_povrate2013 ~ mkt2012 + age3_X_gen2012 + age3_X_educ32012
&lt;environment: 0x0000022891e8ca88&gt;

$direct_povrate2014
direct_povrate2014 ~ age42012 + nat12012 + labor12012
&lt;environment: 0x0000022892214120&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="step-3-fitting-the-multivariate-fay-herriot-model" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="step-3-fitting-the-multivariate-fay-herriot-model"><span class="header-section-number">4.5</span> Step 3: Fitting the Multivariate Fay Herriot Model</h2>
<p>Next, we show how to use the <code>msae</code> R package to estimate the Empirical Best Linear Unbiased Predictor (EBLUP) for the poverty map using the <code>eblupMFH2()</code> which allow for time series fay herriot estimation under homoskedastic assumptions. For completeness, we also briefly perform the previous described direct estimation in step 1, using the <code>eblupUFH()</code> function as well as the <code>eblupMFH1()</code> for the fay herriot model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mfh_dt1 <span class="ot">&lt;-</span> mfh_dt <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"v_pov_"</span>), <span class="sc">~</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># univariate FH</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>model0_obj <span class="ot">&lt;-</span> <span class="fu">eblupUFH</span>(mfh_formula, <span class="at">vardir =</span> varcols, <span class="at">data =</span> mfh_dt)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(model0_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># multivariate FH 1</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="at">msg =</span> <span class="st">"eblupMFH1"</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>model1_obj <span class="ot">&lt;-</span> <span class="fu">eblupMFH1</span>(mfh_formula, <span class="at">vardir =</span> varcols, <span class="at">data =</span> mfh_dt, <span class="at">MAXITER =</span> <span class="dv">10000</span>, <span class="at">PRECISION =</span> <span class="fl">0.01</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(model1_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># multivariate FH 2</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="at">msg =</span> <span class="st">"eblupMFH2"</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>model2_obj <span class="ot">&lt;-</span> <span class="fu">eblupMFH2</span>(mfh_formula, <span class="at">vardir =</span> varcols, <span class="at">data =</span> mfh_dt, <span class="at">MAXITER =</span> <span class="fl">1e10</span>, <span class="at">PRECISION =</span> <span class="fl">0.01</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(model2_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4-post-estimation-diagnostics-model-assumption-checks-for-linearity-normality-and-outliers" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="step-4-post-estimation-diagnostics-model-assumption-checks-for-linearity-normality-and-outliers"><span class="header-section-number">4.6</span> Step 4: Post Estimation Diagnostics: Model Assumption Checks for Linearity, Normality and Outliers</h2>
<p>We now verify the assumptions of the MFH3 model. This includes assessing linearity, the normality of the predicted area effects and standardized residuals, as well as checking for the presence of outlying areas.</p>
<section id="linearity-test" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="linearity-test"><span class="header-section-number">4.6.1</span> Linearity Test</h3>
<p>To assess whether a linear regression model may be incorrectly specified — for instance, due to omitted variables or incorrect functional form — we can use Ramsey’s Regression Equation Specification Error Test (RESET). This test examines whether adding nonlinear combinations (typically powers) of the model’s fitted values significantly improves the model. However, the outcome of interest now is the model MSEs. A significant test result (low p-value) suggests the model is mis-specified and may benefit from additional or transformed predictors.</p>
<p>We implement Ramsey’s RESET test in R using the resettest() function from the lmtest package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">### lets create a dataframe with the errors and estimated poverty rates</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>eblup_dt <span class="ot">&lt;-</span> model2_obj<span class="sc">$</span>eblup</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>mse_dt <span class="ot">&lt;-</span> model2_obj<span class="sc">$</span>MSE</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eblup_dt) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"eblup_"</span>, <span class="fu">colnames</span>(eblup_dt))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mse_dt) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mse_"</span>, <span class="fu">colnames</span>(mse_dt))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>reset_dt <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(eblup_dt, mse_dt) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="do">### lets perform the reset test on the pairs of variables as appropriate i.e. poverty = B0 + B1*MSE</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>test_list <span class="ot">&lt;-</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="fu">unique</span>(survey_dt[[year_var]]), <span class="cf">function</span>(x) {</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset only the columns for year x</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> reset_dt <span class="sc">|&gt;</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="fu">paste0</span>(x, <span class="st">"$"</span>)))  <span class="co"># Select columns ending with current year</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    yvar <span class="ot">&lt;-</span> <span class="fu">colnames</span>(dt)[<span class="fu">grepl</span>(<span class="st">"^eblup_"</span>, <span class="fu">colnames</span>(dt))]</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    xvar <span class="ot">&lt;-</span> <span class="fu">colnames</span>(dt)[<span class="fu">grepl</span>(<span class="st">"^mse_"</span>, <span class="fu">colnames</span>(dt))]</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create formula with squared and cubed terms using I()</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>      xvar, <span class="st">" ~ "</span>, </span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>      yvar, <span class="st">" + I("</span>, yvar, <span class="st">"^2)"</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    model_obj <span class="ot">&lt;-</span> <span class="fu">lm</span>(form, <span class="at">data =</span> dt)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(model_obj)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>reset_dt2 <span class="ot">&lt;-</span> </span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  reset_dt <span class="sc">|&gt;</span> </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="fu">contains</span>(<span class="st">"eblup"</span>), <span class="fu">contains</span>(<span class="st">"mse"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">str_extract</span>(name, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(),</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span>  <span class="fu">str_extract</span>(name, <span class="st">"eblup|mse"</span>)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">|&gt;</span> </span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var, <span class="at">values_from =</span> value )</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>reset_dt2 <span class="sc">|&gt;</span> </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> eblup, <span class="at">y =</span> mse) <span class="sc">+</span> </span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> year) <span class="sc">+</span> </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span> </span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/lin-test-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here is what the results look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>test_list <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="at">X =</span> ., <span class="at">FUN =</span> summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

Call:
lm(formula = form, data = dt)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.056927 -0.000966  0.000134  0.001378  0.015740 

Coefficients:
                              Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)                   -0.04001    0.01351  -2.961  0.00471 **
eblup_direct_povrate2012       0.39620    0.14987   2.644  0.01098 * 
I(eblup_direct_povrate2012^2) -0.91295    0.40010  -2.282  0.02688 * 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.009032 on 49 degrees of freedom
Multiple R-squared:  0.1827,    Adjusted R-squared:  0.1494 
F-statistic: 5.477 on 2 and 49 DF,  p-value: 0.007131


[[2]]

Call:
lm(formula = form, data = dt)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.112311 -0.002595 -0.000842  0.002170  0.037487 

Coefficients:
                              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                   -0.09305    0.02497  -3.726 0.000503 ***
eblup_direct_povrate2013       0.90590    0.27363   3.311 0.001752 ** 
I(eblup_direct_povrate2013^2) -2.08745    0.72264  -2.889 0.005746 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.01846 on 49 degrees of freedom
Multiple R-squared:  0.2396,    Adjusted R-squared:  0.2085 
F-statistic: 7.718 on 2 and 49 DF,  p-value: 0.001219


[[3]]

Call:
lm(formula = form, data = dt)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.145920 -0.003367 -0.001102  0.004768  0.051751 

Coefficients:
                              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                   -0.16560    0.04583  -3.613 0.000712 ***
eblup_direct_povrate2014       1.14465    0.34956   3.275 0.001946 ** 
I(eblup_direct_povrate2014^2) -1.89832    0.64619  -2.938 0.005027 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.02402 on 49 degrees of freedom
Multiple R-squared:  0.2342,    Adjusted R-squared:  0.2029 
F-statistic: 7.492 on 2 and 49 DF,  p-value: 0.001449</code></pre>
</div>
</div>
<p>The results particularly for the final 2 years indicate that we might need to retransform the variables in the model as there are potentially non linear relationships which our model is not capturing. Perhaps creating higher order polynomials and other variable transformations of our right hand side variables reduce the error rates within the model.</p>
</section>
<section id="evaluating-the-normality-assumption" class="level3" data-number="4.6.2">
<h3 data-number="4.6.2" class="anchored" data-anchor-id="evaluating-the-normality-assumption"><span class="header-section-number">4.6.2</span> Evaluating the Normality Assumption</h3>
<section id="the-shapiro-wilks-test" class="level4" data-number="4.6.2.1">
<h4 data-number="4.6.2.1" class="anchored" data-anchor-id="the-shapiro-wilks-test"><span class="header-section-number">4.6.2.1</span> The Shapiro Wilks Test</h4>
<p>We use the shapiro wilks test of normality using the <code>shapiro.test()</code> function in base R. The Shapiro-Wilk test assesses whether a sample of data is drawn from a normally distributed population. It does so by comparing the order statistics (i.e., sorted values) of the sample to the expected values under a normal distribution. Specifically, the test statistic <span class="math inline">\(W\)</span> is a ratio of the squared correlation between the observed sample quantiles and the corresponding normal quantiles.</p>
<p>First, we perform the shapiro wilks normality test on the model errors, <span class="math inline">\(\varepsilon\)</span>. We show both the normality distribution histogram as well as the qqplots as below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">### first lets replace the negative values with 0</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>eblup_dt[eblup_dt <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="do">### evaluating the normality assumption</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### first lets create a residual table by looking at the difference between actual and predicted poverty rates</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>resid_dt <span class="ot">&lt;-</span> mfh_dt[,<span class="fu">paste0</span>(<span class="st">"direct_povrate"</span>, <span class="fu">unique</span>(survey_dt[[year_var]]))] <span class="sc">-</span> eblup_dt</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">### perform the shapiro test</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>shapiro_obj <span class="ot">&lt;-</span> <span class="fu">apply</span>(resid_dt, <span class="dv">2</span>, shapiro.test)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">names</span>(shapiro_obj),</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">W =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span>(x<span class="sc">$</span>statistic[[<span class="dv">1</span>]])</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                        }) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>(),</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">p_value =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>                              <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>(x<span class="sc">$</span>p.value)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                              }) <span class="sc">%&gt;%</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>())</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="do">### plot the results</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  summary_dt <span class="sc">%&gt;%</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"W = "</span>, <span class="fu">round</span>(W, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"p = "</span>, <span class="fu">signif</span>(p_value, <span class="dv">3</span>)))</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>resid_dt <span class="sc">%&gt;%</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Time"</span>, </span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Residual"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Residual)) <span class="sc">+</span> </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> label),</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="fl">1.2</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Time, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Histograms by Time Period"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/sw-test-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">### here's how to create qqplots</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>resid_dt <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Time"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Residual"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> Residual)) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Time, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"QQ Plots of Residuals by Time Period"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/sw-test-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Likewise, we test the normality of the random effect variable</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### For the random effects</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>raneff_dt <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(model2_obj<span class="sc">$</span>randomEffect)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="do">### lets run the shapiro wilks tests again</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>shapiro_obj <span class="ot">&lt;-</span> <span class="fu">apply</span>(raneff_dt, <span class="dv">2</span>, shapiro.test)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">names</span>(shapiro_obj),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">W =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span>(x<span class="sc">$</span>statistic[[<span class="dv">1</span>]])</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                        }) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>(),</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">p_value =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>                              <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>(x<span class="sc">$</span>p.value)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                              }) <span class="sc">%&gt;%</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>())</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="do">### plot the results</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  summary_dt <span class="sc">%&gt;%</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"W = "</span>, <span class="fu">round</span>(W, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"p = "</span>, <span class="fu">signif</span>(p_value, <span class="dv">3</span>)))</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>raneff_dt <span class="sc">%&gt;%</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Time"</span>, </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"RandEff"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> RandEff)) <span class="sc">+</span> </span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>, <span class="at">fill =</span> <span class="st">"darkorange"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> label),</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="fl">1.2</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Time, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Random Effects Histograms by Time Period"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In both cases, we compare the p-value to the 0.05 level of significance. The results suggest that in most cases we have to reject the null hypothesis of normally distributed model errors and random effects. This doesn’t affect the validity of our poverty estimates for the Multivariate Fay Herriot model. However, subsequent analysis that will assume a normal distribution of the model errors cannot be performed. One good example of this is the statistical significance test for changes in poverty rates over time. For the purposes of this tutorial, we will carry on to show how to perform this under the assumption of normally distributed model errors. However, if the test for normality fails, this test cannot be carried out.</p>
<p>Next, we will show the benefits of small area estimation over direct estimation</p>
</section>
</section>
<section id="comparing-direct-estimation-to-multivariate-model-outputs" class="level3" data-number="4.6.3">
<h3 data-number="4.6.3" class="anchored" data-anchor-id="comparing-direct-estimation-to-multivariate-model-outputs"><span class="header-section-number">4.6.3</span> Comparing Direct Estimation to Multivariate Model Outputs</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>model2mse_dt <span class="ot">&lt;-</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  model2_obj<span class="sc">$</span>MSE <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"modelMSE"</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  model2_obj<span class="sc">$</span>eblup <span class="sc">|&gt;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"modelpov"</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(model2mse_dt, model2pov_dt)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  model2pov_dt <span class="sc">|&gt;</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">modelCV =</span> <span class="fu">sqrt</span>(modelMSE) <span class="sc">/</span> modelpov)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(model2pov_dt, </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>                      direct_dt, </span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by =</span> <span class="fu">c</span>(area_vars[[<span class="dv">1</span>]], </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>                             year_var))</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="do">### compute direct CVs and include in `model2pov_dt`</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="do">## we have to reshape the direct estimates data in mfh_dt from wide to long</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="do">## and then merge with model2pov_dt </span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="sc">|&gt;</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(variance_cols),  <span class="co"># add this!</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>                <span class="fu">all_of</span>(area_vars[[<span class="dv">1</span>]])) <span class="sc">|&gt;</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">all_of</span>(area_vars[[<span class="dv">1</span>]]),</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"indicator_year"</span>,</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_starts</span>(indicator_year, <span class="st">"v_pov_indicator"</span>) <span class="sc">~</span> <span class="st">"variance"</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">str_extract</span>(indicator_year, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>)</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>indicator_year) <span class="sc">|&gt;</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> type,</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year)) <span class="sc">|&gt;</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(model2pov_dt,</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(area_vars[[<span class="dv">1</span>]], year_var),</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">all =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">direct_CV =</span> <span class="fu">sqrt</span>(variance) <span class="sc">/</span> direct_povrate) <span class="sc">|&gt;</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(sampsize_dt <span class="sc">%&gt;%</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[<span class="dv">1</span>]), <span class="st">"N"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unique</span>(), </span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now lets plot the direct against the model CVs to get a sense for the gains made as a result of applying the MFH modelling approach over direct estimation. We will also show the sample sizes for each year to show that large sample size reduce the gains from small area estimation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">sapply</span>(model2pov_dt, is.numeric)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>model2pov_dt_clean <span class="ot">&lt;-</span> model2pov_dt[<span class="fu">complete.cases</span>(model2pov_dt[, numeric_cols]) <span class="sc">&amp;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">apply</span>(model2pov_dt[, numeric_cols], <span class="dv">1</span>, <span class="cf">function</span>(row)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">all</span>(<span class="fu">is.finite</span>(row))), ]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make year a factor using year_var</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>model2pov_dt_clean[[year_var]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(model2pov_dt_clean[[year_var]])</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute max values for scaling</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>max_n <span class="ot">&lt;-</span> <span class="fu">max</span>(model2pov_dt_clean<span class="sc">$</span>N, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>max_cv <span class="ot">&lt;-</span> <span class="fu">max</span>(model2pov_dt_clean<span class="sc">$</span>direct_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model2pov_dt_clean, <span class="fu">aes</span>(<span class="at">x =</span> .data[[year_var]])) <span class="sc">+</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> direct_CV, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"Direct CV"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> modelCV, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"Model CV"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> N <span class="sc">/</span> max_n <span class="sc">*</span> max_cv, <span class="at">color =</span> <span class="st">"Sample Size (N)"</span>),</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(.data[[area_vars[[<span class="dv">1</span>]]]]), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Coefficient of Variation (CV)"</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">*</span> max_n <span class="sc">/</span> max_cv, <span class="at">name =</span> <span class="st">"Sample Size (N)"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Direct CV"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>,</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Model CV"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Sample Size (N)"</span> <span class="ot">=</span> <span class="st">"grey40"</span>)) <span class="sc">+</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"grey40"</span>),</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.left =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<p>The other advantage of MFH estimation is the smoothing of the model estimates over the unit variate model. We can show this below as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model2pov_dt[[year_var]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(model2pov_dt[[year_var]])</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="do">## first lets merge in the results of the eblupUFH model</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>ufh_dt <span class="ot">&lt;-</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  model0_obj<span class="sc">$</span>eblup <span class="sc">|&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"ufh_povrate"</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(model2pov_dt,</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                      ufh_dt,</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by =</span> <span class="fu">c</span>(area_vars[[<span class="dv">1</span>]], year_var))</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="do">## now we make a similar plot but comparing the UFH vs MFH model estimates to check for the smoothness of the estimation </span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute max values for scaling</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>max_n <span class="ot">&lt;-</span> <span class="fu">max</span>(model2pov_dt<span class="sc">$</span>N, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model2pov_dt, <span class="fu">aes</span>(<span class="at">x =</span> .data[[year_var]])) <span class="sc">+</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ufh_povrate, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"UFH Poverty"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> modelpov, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"MFH Poverty"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> N <span class="sc">/</span> max_n, <span class="at">color =</span> <span class="st">"Sample Size (N)"</span>),</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(.data[[area_vars[[<span class="dv">1</span>]]]]), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Poverty Rates"</span>,</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">*</span> max_n, <span class="at">name =</span> <span class="st">"Sample Size (N)"</span>)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"UFH Poverty"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>,</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"MFH Poverty"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>,</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Sample Size (N)"</span> <span class="ot">=</span> <span class="st">"grey40"</span>)) <span class="sc">+</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"grey40"</span>),</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.left =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<p>It can be seen from the plots that the provinces in with the highest variance in UFH poverty estimates tend to provide smoother MFH estimates particularly in the provinces with smaller samples. This shows the power of the MFH approach in taking advantage of the across year correlation of poverty.</p>
<p>Next we will assume our model errors were normally distributed in order to show how to statistically test to see if poverty has changed between given years.</p>
</section>
<section id="did-the-poverty-rates-change-over-time" class="level3" data-number="4.6.4">
<h3 data-number="4.6.4" class="anchored" data-anchor-id="did-the-poverty-rates-change-over-time"><span class="header-section-number">4.6.4</span> Did the poverty rates change over time?</h3>
<p>Next we can call the <code>pbmcpeMFH2()</code> function, which returns the EBLUP, as well as, the MSEs of the EBLUPs for each time point, and the MCPEs for each pair of time points based on the MFH model 2 as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(pbmcpeMFH2)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>mcpemfh2_obj <span class="ot">&lt;-</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pbmcpeMFH2</span>(<span class="at">formula =</span> mfh_formula,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">vardir =</span> varcols,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">nB =</span> <span class="dv">50</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> mfh_dt, </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">MAXITER =</span> <span class="fl">1e10</span>, </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">PRECISION =</span> <span class="fl">1e-2</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(mcpemfh2_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above function takes the difference between any two time periods and prepares a table of differences for each area include the MCPE estimated error rates as well as lower and upper bounds given a specified confidence level. See the function implemented to compare periods 1 and 2 (years 2012 and 2013)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>comp12_obj <span class="ot">&lt;-</span> <span class="fu">compare_mfh2</span>()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>comp23_obj <span class="ot">&lt;-</span> <span class="fu">compare_mfh2</span>(<span class="at">period_list =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>comp13_obj <span class="ot">&lt;-</span> <span class="fu">compare_mfh2</span>(<span class="at">period_list =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See the plots below</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-15-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>See the data created</p>
<ul>
<li>Comparing the years 2012 and 2013</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>comp12_obj<span class="sc">$</span>df <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 20%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">diff</th>
<th style="text-align: right;">mse</th>
<th style="text-align: right;">alpha</th>
<th style="text-align: right;">zq</th>
<th style="text-align: right;">lb</th>
<th style="text-align: right;">ub</th>
<th style="text-align: left;">significant</th>
<th style="text-align: right;">index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.02009</td>
<td style="text-align: right;">0.0092704</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.1686207</td>
<td style="text-align: right;">0.2088007</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.00417</td>
<td style="text-align: right;">0.0019928</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.0833244</td>
<td style="text-align: right;">0.0916644</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.00105</td>
<td style="text-align: right;">0.0114769</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.2089219</td>
<td style="text-align: right;">0.2110219</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.00676</td>
<td style="text-align: right;">0.0505814</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.4475619</td>
<td style="text-align: right;">0.4340419</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.0000241</td>
<td style="text-align: right;">0.0000241</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.00102</td>
<td style="text-align: right;">0.0141145</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.2318327</td>
<td style="text-align: right;">0.2338727</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>Comparing the years 2013 and 2014</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>comp23_obj<span class="sc">$</span>df <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 20%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">diff</th>
<th style="text-align: right;">mse</th>
<th style="text-align: right;">alpha</th>
<th style="text-align: right;">zq</th>
<th style="text-align: right;">lb</th>
<th style="text-align: right;">ub</th>
<th style="text-align: left;">significant</th>
<th style="text-align: right;">index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.094150</td>
<td style="text-align: right;">0.1543261</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.6758094</td>
<td style="text-align: right;">0.8641094</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.052870</td>
<td style="text-align: right;">0.1868019</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.7942380</td>
<td style="text-align: right;">0.8999780</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.088530</td>
<td style="text-align: right;">1.3239427</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-2.1666577</td>
<td style="text-align: right;">2.3437177</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.052230</td>
<td style="text-align: right;">6.9538819</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-5.1162370</td>
<td style="text-align: right;">5.2206970</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.048865</td>
<td style="text-align: right;">0.1154835</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.6171870</td>
<td style="text-align: right;">0.7149170</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.102160</td>
<td style="text-align: right;">0.0055322</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.0436195</td>
<td style="text-align: right;">0.2479395</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>Comparing the years 2012 and 2014</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>comp13_obj<span class="sc">$</span>df <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 20%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">diff</th>
<th style="text-align: right;">mse</th>
<th style="text-align: right;">alpha</th>
<th style="text-align: right;">zq</th>
<th style="text-align: right;">lb</th>
<th style="text-align: right;">ub</th>
<th style="text-align: left;">significant</th>
<th style="text-align: right;">index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.114240</td>
<td style="text-align: right;">0.2379474</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.8418275</td>
<td style="text-align: right;">1.0703075</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.057040</td>
<td style="text-align: right;">0.2267551</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.8762715</td>
<td style="text-align: right;">0.9903515</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.089580</td>
<td style="text-align: right;">1.5809691</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-2.3748120</td>
<td style="text-align: right;">2.5539720</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.045470</td>
<td style="text-align: right;">8.1882867</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-5.5630027</td>
<td style="text-align: right;">5.6539427</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.048865</td>
<td style="text-align: right;">0.1154821</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.6171828</td>
<td style="text-align: right;">0.7149128</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.103180</td>
<td style="text-align: right;">0.0369259</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.959964</td>
<td style="text-align: right;">-0.2734487</td>
<td style="text-align: right;">0.4798087</td>
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="presenting-results" class="level3" data-number="4.6.5">
<h3 data-number="4.6.5" class="anchored" data-anchor-id="presenting-results"><span class="header-section-number">4.6.5</span> Presenting Results</h3>
<p>Now that we have estimated the MFH models and run some diagnostics, we might be interested in the following:</p>
<ul>
<li>presenting some poverty maps</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="at">X =</span> <span class="fu">unique</span>(survey_dt[[year_var]]),</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>         shp_dt <span class="sc">|&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">merge</span>(model2pov_dt <span class="sc">%&gt;%</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(year_var) <span class="sc">==</span> x) <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                   dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]), <span class="st">"modelpov"</span>),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> area_vars[[<span class="dv">1</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>           <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> modelpov), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">name =</span> <span class="st">"Poverty Map"</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Spatial Distribution of Poverty "</span>, x),</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">caption =</span> <span class="st">"Data source: Author Calculation"</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">+</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>       }) <span class="sc">|&gt;</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="at">f =</span> <span class="st">"+"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>quantifying poverty change by mapping the growth rates of poverty rates for all the time periods</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">### lets work with our shapefile</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>longpov_dt <span class="ot">&lt;-</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  model2_obj<span class="sc">$</span>eblup <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"modelpov"</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="do">### lets perform a regression for each area of poverty rates against year </span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="do">### and then we divide the slope variable by the average poverty rate</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>shp_dt<span class="sc">$</span>growth_rate <span class="ot">&lt;-</span> </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>longpov_dt <span class="sc">|&gt;</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(year_var) <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(<span class="sc">!!</span><span class="fu">sym</span>(year_var))) <span class="sc">|&gt;</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_split</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]])) <span class="sc">%&gt;%</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="at">X =</span> .,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>           y <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">paste0</span>(<span class="st">"modelpov ~ "</span>, year_var[[<span class="dv">1</span>]]), <span class="at">data =</span> x)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>           y <span class="ot">&lt;-</span> <span class="fu">coef</span>(y)[<span class="dv">2</span>]</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>           delta <span class="ot">&lt;-</span> y <span class="sc">/</span> (<span class="fu">mean</span>(x<span class="sc">$</span>modelpov, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span>(delta)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>         }) <span class="sc">|&gt;</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets plot this like with a heatmap on a shapefile:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cap growth rates at 1 just to get rid of the outlier</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>shp_dt<span class="sc">$</span>growth_rate_capped <span class="ot">&lt;-</span> <span class="fu">pmin</span>(shp_dt<span class="sc">$</span>growth_rate, <span class="dv">1</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(shp_dt) <span class="sc">+</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> growth_rate_capped), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Growth Rate (capped at 1)"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(shp_dt<span class="sc">$</span>growth_rate_capped), <span class="fl">0.5</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> squish,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spatial Distribution of Poverty Growth Rates"</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Growth rates capped at 1 to reduce outlier effect"</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Data source: Author Calculation"</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="50-mfh_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-permatasari2022package" class="csl-entry" role="listitem">
Permatasari, Novia, Azka Ubaidillah, and Maintainer Novia Permatasari. 2022. <span>“Package <span>‘Msae’</span>.”</span>
</div>
<div id="ref-yamashita2007stepwise" class="csl-entry" role="listitem">
Yamashita, Toshie, Keizo Yamashita, and Ryotaro Kamimura. 2007. <span>“A Stepwise AIC Method for Variable Selection in Linear Regression.”</span> <em>Communications in Statistics—Theory and Methods</em> 36 (13): 2395–2403.
</div>
<div id="ref-you2023application" class="csl-entry" role="listitem">
You, Yong, and Mike Hidiroglou. 2023. <span>“Application of Sampling Variance Smoothing Methods for Small Area Proportion Estimation.”</span> <em>Journal of Official Statistics</em> 39 (4): 571–90.
</div>
</div>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./40-fh.html" class="pagination-link" aria-label="The Univariate Fay-Herriot (UFH) model">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot (UFH) model</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb33" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Stable FH Estimates over T Time Periods: The Multivariate Fay Herriot Modelling Approach"</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Ifeanyi Edochie"</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: false</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Chunk setup</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">echo =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cn">FALSE</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  sf, </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  data.table, </span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  tidyverse, </span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  car, </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  msae,</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  sae, </span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  survey, </span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  spdep,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  knitr, </span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>  MASS, </span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>  caret,</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  purrr,</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>  pins,</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>  gt,</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>  lmtest, </span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>  scales,</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>  viridis, </span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>  patchwork,</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>  dplyr, </span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>  tictoc,</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>  gt,</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>  matrixcalc</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading locally-developed</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"R"</span>, <span class="at">pattern =</span> <span class="st">"*.R$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">walk</span>(<span class="sc">~</span> <span class="fu">suppressMessages</span>(<span class="fu">source</span>(.x)))</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Raw data root</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>root_raw <span class="ot">&lt;-</span> <span class="st">"./data/raw"</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>root_temp <span class="ot">&lt;-</span> <span class="st">"./data/temp"</span></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>root_clean <span class="ot">&lt;-</span> <span class="st">"./data/clean-example"</span></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Data-storage boards</span></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>bd_raw <span class="ot">&lt;-</span> root_raw <span class="sc">|&gt;</span> <span class="fu">file.path</span>(<span class="st">"api"</span>) <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>bd_aux <span class="ot">&lt;-</span> root_temp <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>bd_clean <span class="ot">&lt;-</span> root_clean <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>bd_out <span class="ot">&lt;-</span> <span class="st">"output/res-50-mfh"</span> <span class="sc">|&gt;</span> <span class="fu">board_folder</span>(<span class="at">versioned =</span> T)</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a><span class="fu"># Stable FH Estimators over T time periods: The Multivariate Fay Herriot Modelling Approach</span></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>This section describes procedures that yield stable small area estimators for each of $D$ areas over $T$ subsequent time instants. Area populations, the samples and the data might change between time periods. Accordingly, we denote $U_t$ the overall population at time $t$, which is partitioned into $D$ areas $U_{1t}, ... ,U_{Dt}$, of respective population sizes $N_{1t}$</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>An overview of the MFH model estimation process is as follows:</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 0: The data preparation phase in which we prepare the 3 data objects needed for the small area estimation under the Multivariate Fay Herriot Model</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 1: Compute the selected direct area estimators for each target area $d = 1, ..., D$ for each time $t = 1, ..., T$ and estimators of their corresponding sampling variances and covariances.</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 2: Prepare variables (from administrative data or other sources of data representative at the target area level) at the level of the target area for each time instant in the MFH model. We present a simple approach which performs model selection in a pooled linear regression model without time effects.</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 3: Fit the MFH models to test for homoskedastic area-time effects $({\mu_d}_1, ... , {\mu_d}_T)$ are homoskedastic or not. If we reject the homoskedasticity of variances, implement the MFH3 model. Otherwise, we proceed with the MFH2 model. For the purposes of this training, we assume a homoskedastic model for simplicity.</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 4: Check the selected model assumptions, including linearity, normality of predicted area effects and standardized model residuals, and the presence of the outlying areas.</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 5: In case of systematic model departures such as isolated departures because of outlying areas, some adjustments might need to be implemented before returning to Step 2 to recompute the MFH model.</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Step 6: If model assumptions hold, using the above direct estimates and estimated sampling variances and covariances, and the selected auxiliary variables, compute MFH estimators $\hat{\delta}_{dt}^{MFH},\quad d = 1,...,D$ and $t = 1, ..., T$ and their corresponding estimated MSEs.</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>We will show below the use of the <span class="in">`eblupMFH2()`</span> and <span class="in">`eblupMFH3()`</span> from the R package msae <span class="co">[</span><span class="ot">@permatasari2022package</span><span class="co">]</span> compute the EBLUPs and their MSE estimates under the MFH models 2 and 3, respectively. The calls to these functions are:</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a><span class="in">`eblupMFH2(formula, vardir, MAXITER = 100, PRECISION = 1e-04, data)`</span></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a><span class="in">`eblupMFH3(formula, vardir, MAXITER = 100, PRECISION = 1e-04, data)`</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## MFH Estimation of Poverty Rates for T time periods</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>In this example, we use a synthetic data set adapted from R package <span class="in">`sae`</span> called <span class="in">`incomedata`</span>. The original data contains information for $n = 17,119$ fictitious individuals residing across $D = 52$ Spanish provinces. The variables include the name of the province of residence (<span class="in">`provlab`</span>), province code (<span class="in">`prov`</span>), as well as several correlates of income. We have added two additional income vectors corresponding to two additional years of data.</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>We will show how to estimate a poverty map for each year by using the Multivariate Fay Herriot modelling approach. This approach allows us to take advantage of the temporal correlation between poverty rates i.e. an individuals income in year $t$ is likely correlated with their income in year $t+1$.</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>The rest of this tutorial shows how to prepare MFH models using a random 10% sample of the <span class="in">`incomedata`</span> to estimate the poverty rates.</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 0: The Data Preparation Phase</span></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>The MFH estimation process relies on 3 types of data:</span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>(1) The data containing the outcome variable from which direct estimates will be computed. This is a usually a survey dataset for each year of data including outcome variable (such as income or welfare aggregates), weights, cluster identifiers (i.e. if available, psu or enumeration areas) at the unit level i.e. individual or household. In this example, we call this: <span class="in">`survey_dt`</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>(2) A dataset containing for the right hand side (RHS) variables i.e. indicator estimates representative at the level of the target area for each year. This is often obtained from administrative data sources or geospatial data such as remotely sensed high resolution data. The final RHS dataset ought to include an area id, year and variables of interest. In this example, we call this <span class="in">`rhs_dt`</span></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>(3) Finally, a shapefile which spatially links each target area to their boundaries on a map. This will contain the area id as well as the geometry object which when visualized will show the shape of the areas in which poverty rates will be estimated. In this example, we call this <span class="in">`shp_dt`</span></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dta-load}</span></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"pov_direct"</span>)</span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"sae_data"</span>)</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"geometries"</span>)</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>Below is what our datasets look like. These are generally the variables</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a><span class="in">`survey_dt`</span> contains our target area identifiers (<span class="in">`provlab`</span>, <span class="in">`prov`</span>), the weight variable <span class="in">`weight`</span>, the cluster id i.e. enumeration area or psu, <span class="in">`ea_id`</span>, the year, <span class="in">`year`</span>, the income variable <span class="in">`income`</span> and the poverty line <span class="in">`poverty`</span>. In this example, <span class="in">`survey_dt`</span> of class <span class="in">`data.frame`</span> is at the level of the individual. It could also be at the level of the household if poverty lines are evaluated at that level.</span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>rhs_dt <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a><span class="sc">\`</span><span class="in">`rhs_dt`</span> is an object of class <span class="in">`data.frame`</span> created at the level of the target area. It should contain the same target area identifiers as in <span class="in">`survey_dt`</span> and the year variable <span class="in">`year`</span>.</span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>shp_dt <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a><span class="in">`shp_dt`</span> is an object of class <span class="in">`sf`</span>, <span class="in">`data.frame`</span> created at the level of the target area. This is the shapefile for the area of interest for which the poverty map will be estimated. It should contain the same target area ID found in <span class="in">`survey_dt`</span> as well as <span class="in">`rhs_dt`</span>.</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>A quick summary table on the data needs for the MFH model:</span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table content</span></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a>mfh_table <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"`survey_dt`"</span>, <span class="st">"`rhs_dt`"</span>, <span class="st">"`shp_dt`"</span>),</span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Unit of Observation</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Individual (or Household)"</span>,</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Target Area (e.g. Province)"</span>,</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Target Area (Spatial)"</span></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Required Variables</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>    <span class="st">"`target area identifiers`, `weights`, `cluster identifier`, year, `income/welfare variable`, `poverty line`"</span>,</span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">"`target area identifiers`, `year`, `covariates` (e.g. `gen`, `educ1`, `schyrs`, etc.)"</span>,</span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">"`target area identifiers`, `geometries` (e.g. `geometry` column from `sf`)"</span></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the gt table</span></span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>mfh_table <span class="sc">%&gt;%</span></span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Data Input Checklist for the Multivariate Fay-Herriot Model**"</span>),</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"*Datasets, levels, and Required variables*"</span>)</span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">Dataset =</span> <span class="st">"Dataset Name"</span>,</span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Unit of Observation</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Unit of Observation"</span>,</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Required Variables</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Required Variables"</span></span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.names =</span> <span class="st">"Arial"</span>,</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="dv">16</span>,</span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">column_labels.font.weight =</span> <span class="st">"bold"</span>,</span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_row.padding =</span> <span class="fu">px</span>(<span class="dv">4</span>),</span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.border.top.width =</span> <span class="fu">px</span>(<span class="dv">2</span>),</span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.border.bottom.width =</span> <span class="fu">px</span>(<span class="dv">2</span>),</span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.align =</span> <span class="st">"left"</span></span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_markdown</span>(<span class="at">columns =</span> <span class="fu">everything</span>())</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a>For ease of use of this tutorial, make sure the variable names match as described across the datasets i.e. use the same target area variables and year variable name across all 3 datasets.</span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Direct Estimation of Poverty &amp; Variance-Covarance Matrix</span></span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a>We will use the direct HT estimators that use the survey weights in <span class="in">`weight`</span> variable. First, we calculate the total sample size, the number of provinces, the sample sizes for each province and extract the population sizes for each province/target area from the <span class="in">`sizeprov`</span> file. For those using the household/individual level survey data, this may be obtained from the sum of the household or individual weights as appropriate.</span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple Direct Estimation</span></span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a>The goal is simply to apply the poverty line to the</span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dir-est-setup}</span></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a><span class="do">### a little bit of housekeeping to ensure ease of access </span></span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a>area_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"prov"</span>, <span class="st">"provlab"</span>) <span class="do">### both variables are at the same level. if the levels vary, you would need to combine both variables for effect use</span></span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-206"><a href="#cb33-206" aria-hidden="true" tabindex="-1"></a>cluster_var <span class="ot">&lt;-</span> <span class="st">"ea_id"</span></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a>weight_var <span class="ot">&lt;-</span> <span class="st">"weight"</span></span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a>year_var <span class="ot">&lt;-</span> <span class="st">"year"</span></span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a>outcome_var <span class="ot">&lt;-</span> <span class="st">"income"</span></span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a>povline_var <span class="ot">&lt;-</span> <span class="st">"povline"</span></span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(rhs_dt)[<span class="sc">!</span><span class="fu">colnames</span>(rhs_dt) <span class="sc">%in%</span> <span class="fu">c</span>(area_vars, year_var)]</span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a><span class="do">### quickly compute the sample size for each province</span></span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a>sampsize_dt <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span></span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars), <span class="sc">!!</span><span class="fu">sym</span>(year_var)) <span class="sc">|&gt;</span></span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">N =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a><span class="do">## the poverty line for each is already included within the data. </span></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a><span class="do">## Lets compute the direct estimates for each year of data and create a list of data.frames (equal in length to the number of years) </span></span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a><span class="do">## containing the direct estimate, the standard errors and the coefficient of variation. </span></span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pov_indicator =</span> <span class="fu">ifelse</span>(income <span class="sc">&lt;</span> povline, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars), <span class="sc">!!</span><span class="fu">sym</span>(year_var)) <span class="sc">|&gt;</span></span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">direct_povrate =</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> pov_indicator, </span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> <span class="sc">!!</span><span class="fu">sym</span>(weight_var),</span>
<span id="cb33-229"><a href="#cb33-229" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb33-230"><a href="#cb33-230" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>Here is what the results look like:</span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = TRUE}</span></span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a>direct_dt</span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing the Variance-Covariance Matrix for the Sampling Error of the Direct Estimate</span></span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a>Next, we quickly estimate the sample variance and covariance for the direct estimator using the survey R package as below. We apply the <span class="in">`compute_vcov()`</span> function which we have created as a wrapper on the <span class="in">`survey::svymean()`</span> and <span class="in">`survey::svyvar()`</span> functions to estimate the variance covariance matrix.</span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dir-est-pov}</span></span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-247"><a href="#cb33-247" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb33-248"><a href="#cb33-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pov_indicator =</span> <span class="fu">ifelse</span>(<span class="sc">!!</span><span class="fu">sym</span>(outcome_var) <span class="sc">&lt;</span> <span class="sc">!!</span><span class="fu">sym</span>(povline_var), <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb33-249"><a href="#cb33-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a><span class="do">### we need to reconstruct the variables from long to wide for this</span></span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a><span class="do">### this wide format will also be useful for estimating the MFH model as well </span></span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a><span class="do">### later on</span></span>
<span id="cb33-253"><a href="#cb33-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-254"><a href="#cb33-254" aria-hidden="true" tabindex="-1"></a>widesurvey_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="sc">!!!</span><span class="fu">syms</span>(area_vars), <span class="sc">!!</span><span class="fu">sym</span>(cluster_var), <span class="sc">!!</span><span class="fu">sym</span>(weight_var)),</span>
<span id="cb33-258"><a href="#cb33-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> <span class="sc">!!</span><span class="fu">sym</span>(year_var),</span>
<span id="cb33-259"><a href="#cb33-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(<span class="sc">!!</span><span class="fu">sym</span>(outcome_var), <span class="sc">!!</span><span class="fu">sym</span>(povline_var), <span class="st">"pov_indicator"</span>),</span>
<span id="cb33-260"><a href="#cb33-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"{.value}{year}"</span>,</span>
<span id="cb33-261"><a href="#cb33-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> first</span>
<span id="cb33-262"><a href="#cb33-262" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-263"><a href="#cb33-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-264"><a href="#cb33-264" aria-hidden="true" tabindex="-1"></a><span class="do">#### now we are ready to compute the variance covariance matrix</span></span>
<span id="cb33-265"><a href="#cb33-265" aria-hidden="true" tabindex="-1"></a><span class="do">### notice that we have to specify the new column names for the pov_indicator variables as they recreated in widesurvey_dt</span></span>
<span id="cb33-266"><a href="#cb33-266" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-267"><a href="#cb33-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compute_vcov</span>(<span class="at">dt =</span> widesurvey_dt,</span>
<span id="cb33-268"><a href="#cb33-268" aria-hidden="true" tabindex="-1"></a>               <span class="at">domain =</span> area_vars[[<span class="dv">1</span>]],</span>
<span id="cb33-269"><a href="#cb33-269" aria-hidden="true" tabindex="-1"></a>               <span class="at">ids =</span> cluster_var,</span>
<span id="cb33-270"><a href="#cb33-270" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> weight_var,</span>
<span id="cb33-271"><a href="#cb33-271" aria-hidden="true" tabindex="-1"></a>               <span class="at">yvars =</span> <span class="fu">paste0</span>(<span class="st">"pov_indicator"</span>, <span class="fu">unique</span>(survey_dt[[year_var]]))) </span>
<span id="cb33-272"><a href="#cb33-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-273"><a href="#cb33-273" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-274"><a href="#cb33-274" aria-hidden="true" tabindex="-1"></a>  var_dt <span class="sc">|&gt;</span></span>
<span id="cb33-275"><a href="#cb33-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="st">"domain"</span>) <span class="do">### quick rename the domain variable to match our area_vars</span></span>
<span id="cb33-276"><a href="#cb33-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-277"><a href="#cb33-277" aria-hidden="true" tabindex="-1"></a><span class="do">### lets merge in our sample sizes</span></span>
<span id="cb33-278"><a href="#cb33-278" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span></span>
<span id="cb33-279"><a href="#cb33-279" aria-hidden="true" tabindex="-1"></a>  var_dt <span class="sc">|&gt;</span></span>
<span id="cb33-280"><a href="#cb33-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(sampsize_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-281"><a href="#cb33-281" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[<span class="dv">1</span>]), <span class="st">"N"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-282"><a href="#cb33-282" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unique</span>(), </span>
<span id="cb33-283"><a href="#cb33-283" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]])</span>
<span id="cb33-284"><a href="#cb33-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-285"><a href="#cb33-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-286"><a href="#cb33-286" aria-hidden="true" tabindex="-1"></a>It is noteworthy that the <span class="in">`var_dt`</span> object is estimated at the level of the target area. Hence, for reasons that will be made self-evident later, the <span class="in">`var_dt`</span> is not a matrix for each area rather the matrix is stored rowwise.</span>
<span id="cb33-287"><a href="#cb33-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-288"><a href="#cb33-288" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Handling Low Sample Sizes: Variance Smoothing</span></span>
<span id="cb33-289"><a href="#cb33-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-290"><a href="#cb33-290" aria-hidden="true" tabindex="-1"></a>A quick inspection of the preceding results will show some provinces contain low sample sizes which sometimes result in extreme value poverty rates and hence 0 variance. To avoid this, we will show you how to apply the variance smoothing method suggested by <span class="co">[</span><span class="ot">@you2023application</span><span class="co">]</span>. Please see the code and Roxygen comments below explaining the use of the <span class="in">`varsmoothie_king()`</span> function which computes smoothed variances.</span>
<span id="cb33-291"><a href="#cb33-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-292"><a href="#cb33-292" aria-hidden="true" tabindex="-1"></a>The goal now is to use the above <span class="in">`varsmoothie_king()`</span> function to add additional columns of smoothed variances into our <span class="in">`var_dt`</span> object.</span>
<span id="cb33-293"><a href="#cb33-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-294"><a href="#cb33-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dir-est-var-smooth}</span></span>
<span id="cb33-295"><a href="#cb33-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-296"><a href="#cb33-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-297"><a href="#cb33-297" aria-hidden="true" tabindex="-1"></a>varcols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^v_"</span>, <span class="fu">names</span>(var_dt), <span class="at">value =</span> <span class="cn">TRUE</span>) <span class="do">## the column names for the variance covariance matrix</span></span>
<span id="cb33-298"><a href="#cb33-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-299"><a href="#cb33-299" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span></span>
<span id="cb33-300"><a href="#cb33-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="at">X =</span> varcols,</span>
<span id="cb33-301"><a href="#cb33-301" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-302"><a href="#cb33-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-303"><a href="#cb33-303" aria-hidden="true" tabindex="-1"></a>           z <span class="ot">&lt;-</span> <span class="fu">varsmoothie_king</span>(<span class="at">domain =</span> var_dt[[area_vars[<span class="dv">1</span>]]],</span>
<span id="cb33-304"><a href="#cb33-304" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">direct_var =</span> var_dt[[x]],</span>
<span id="cb33-305"><a href="#cb33-305" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sampsize =</span> var_dt[[<span class="st">"N"</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb33-306"><a href="#cb33-306" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as.data.table</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-307"><a href="#cb33-307" aria-hidden="true" tabindex="-1"></a>             <span class="fu">setnames</span>(<span class="at">old =</span> <span class="st">"var_smooth"</span>, <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"vs"</span>, x)) <span class="sc">|&gt;</span></span>
<span id="cb33-308"><a href="#cb33-308" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as_tibble</span>()</span>
<span id="cb33-309"><a href="#cb33-309" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb33-310"><a href="#cb33-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-311"><a href="#cb33-311" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span>(z)</span>
<span id="cb33-312"><a href="#cb33-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-313"><a href="#cb33-313" aria-hidden="true" tabindex="-1"></a>         }) <span class="sc">%&gt;%</span></span>
<span id="cb33-314"><a href="#cb33-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="at">f =</span> <span class="st">"merge"</span>,</span>
<span id="cb33-315"><a href="#cb33-315" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb33-316"><a href="#cb33-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">x =</span> var_dt,</span>
<span id="cb33-317"><a href="#cb33-317" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> .,</span>
<span id="cb33-318"><a href="#cb33-318" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.x =</span> area_vars[[<span class="dv">1</span>]],</span>
<span id="cb33-319"><a href="#cb33-319" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.y =</span> <span class="st">"Domain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-320"><a href="#cb33-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb33-321"><a href="#cb33-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-322"><a href="#cb33-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-323"><a href="#cb33-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-324"><a href="#cb33-324" aria-hidden="true" tabindex="-1"></a>Now, you can replace the zero/near zero sample size area MSEs with their smoothed variances.</span>
<span id="cb33-325"><a href="#cb33-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-326"><a href="#cb33-326" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Variable Preparation and Model Selection</span></span>
<span id="cb33-327"><a href="#cb33-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-328"><a href="#cb33-328" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Preparation for Model Selection &amp; MFH estimation</span></span>
<span id="cb33-329"><a href="#cb33-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-330"><a href="#cb33-330" aria-hidden="true" tabindex="-1"></a>Thus far, we have careful set up the types of data we require for the MFH model. One final step of variable preparation is necessary to use the <span class="in">`eblupUFH`</span> and <span class="in">`eblupMFH`</span> functions. This requires that we reshape the set of candidate variables dataset i.e. the <span class="in">`rhs_dt`</span> object into wide format. We will also have to reshape our direct estimates and merge this into <span class="in">`rhs_dt`</span> as well as <span class="in">`var_dt`</span>. All the data we have created thus far needs to be placed together ultimately for the EBLUP estimation.</span>
<span id="cb33-331"><a href="#cb33-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-334"><a href="#cb33-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-335"><a href="#cb33-335" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-336"><a href="#cb33-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-337"><a href="#cb33-337" aria-hidden="true" tabindex="-1"></a><span class="do">## reshaping the rhs_dt from long to wide</span></span>
<span id="cb33-338"><a href="#cb33-338" aria-hidden="true" tabindex="-1"></a>widerhs_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-339"><a href="#cb33-339" aria-hidden="true" tabindex="-1"></a>  rhs_dt <span class="sc">|&gt;</span></span>
<span id="cb33-340"><a href="#cb33-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb33-341"><a href="#cb33-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(area_vars),</span>
<span id="cb33-342"><a href="#cb33-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(year_var),</span>
<span id="cb33-343"><a href="#cb33-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(candidate_vars),</span>
<span id="cb33-344"><a href="#cb33-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"{.value}{year}"</span>,</span>
<span id="cb33-345"><a href="#cb33-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> \(x) dplyr<span class="sc">::</span><span class="fu">first</span>(x)  <span class="co"># or `first`, or something more explicit if needed</span></span>
<span id="cb33-346"><a href="#cb33-346" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-347"><a href="#cb33-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-348"><a href="#cb33-348" aria-hidden="true" tabindex="-1"></a><span class="do">## now let us reshape and merge in the poverty rates</span></span>
<span id="cb33-349"><a href="#cb33-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-350"><a href="#cb33-350" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-351"><a href="#cb33-351" aria-hidden="true" tabindex="-1"></a>  direct_dt <span class="sc">|&gt;</span></span>
<span id="cb33-352"><a href="#cb33-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb33-353"><a href="#cb33-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(area_vars),</span>
<span id="cb33-354"><a href="#cb33-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(year_var),</span>
<span id="cb33-355"><a href="#cb33-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="st">"direct_povrate"</span>,</span>
<span id="cb33-356"><a href="#cb33-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"{.value}{year}"</span>,</span>
<span id="cb33-357"><a href="#cb33-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> \(x) dplyr<span class="sc">::</span><span class="fu">first</span>(x)  <span class="co"># or `first`, or something more explicit if neede</span></span>
<span id="cb33-358"><a href="#cb33-358" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-359"><a href="#cb33-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">y =</span> widerhs_dt,</span>
<span id="cb33-360"><a href="#cb33-360" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb33-361"><a href="#cb33-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">y =</span> var_dt,</span>
<span id="cb33-362"><a href="#cb33-362" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]])</span>
<span id="cb33-363"><a href="#cb33-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-364"><a href="#cb33-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-365"><a href="#cb33-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-366"><a href="#cb33-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-367"><a href="#cb33-367" aria-hidden="true" tabindex="-1"></a>Here is what the data looks like:</span>
<span id="cb33-368"><a href="#cb33-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-371"><a href="#cb33-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-372"><a href="#cb33-372" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-373"><a href="#cb33-373" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span>
<span id="cb33-374"><a href="#cb33-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-375"><a href="#cb33-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-376"><a href="#cb33-376" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variable Selection Process</span></span>
<span id="cb33-377"><a href="#cb33-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-378"><a href="#cb33-378" aria-hidden="true" tabindex="-1"></a>Next, we apply a simple variable selection process which employs the stepwise regression algorithm using the AIC selection criteria as in described by <span class="co">[</span><span class="ot">@yamashita2007stepwise</span><span class="co">]</span>. The function <span class="in">`step_wrapper()`</span> implemented below is a wrapper to the <span class="in">`stepAIC()`</span> function carries all the perfunctory cleaning necessary use the <span class="in">`stepAIC()`</span> function. This includes dropping columns that are entirely missing (<span class="in">`NA`</span>) and keep only complete cases/observations and remove perfectly or near collinear variables and combinations using the variance inflation method.</span>
<span id="cb33-379"><a href="#cb33-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-380"><a href="#cb33-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r var-selection}</span></span>
<span id="cb33-381"><a href="#cb33-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-382"><a href="#cb33-382" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> </span>
<span id="cb33-383"><a href="#cb33-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand.grid</span>(<span class="at">var =</span> candidate_vars,</span>
<span id="cb33-384"><a href="#cb33-384" aria-hidden="true" tabindex="-1"></a>              <span class="at">year =</span> <span class="fu">unique</span>(survey_dt[[year_var]])) <span class="sc">|&gt;</span></span>
<span id="cb33-385"><a href="#cb33-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">name =</span> <span class="fu">paste0</span>(var, year)) <span class="sc">|&gt;</span></span>
<span id="cb33-386"><a href="#cb33-386" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb33-387"><a href="#cb33-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-388"><a href="#cb33-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>()</span>
<span id="cb33-389"><a href="#cb33-389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-390"><a href="#cb33-390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-391"><a href="#cb33-391" aria-hidden="true" tabindex="-1"></a><span class="do">## extract the year identifiers in each variance covariance name</span></span>
<span id="cb33-392"><a href="#cb33-392" aria-hidden="true" tabindex="-1"></a>varyear_list <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_extract_all</span>(varcols, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>)</span>
<span id="cb33-393"><a href="#cb33-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-394"><a href="#cb33-394" aria-hidden="true" tabindex="-1"></a><span class="do">## Keep only those where both years are the same i.e. the variances</span></span>
<span id="cb33-395"><a href="#cb33-395" aria-hidden="true" tabindex="-1"></a>variance_cols <span class="ot">&lt;-</span> varcols[<span class="fu">lengths</span>(varyear_list) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> </span>
<span id="cb33-396"><a href="#cb33-396" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sapply</span>(varyear_list, <span class="cf">function</span>(x) x[<span class="dv">1</span>] <span class="sc">==</span> x[<span class="dv">2</span>])]</span>
<span id="cb33-397"><a href="#cb33-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-398"><a href="#cb33-398" aria-hidden="true" tabindex="-1"></a><span class="do">## replace the variances-covariances that are zero or near zero with their smoothed counterparts</span></span>
<span id="cb33-399"><a href="#cb33-399" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-400"><a href="#cb33-400" aria-hidden="true" tabindex="-1"></a>  mfh_dt <span class="sc">|&gt;</span></span>
<span id="cb33-401"><a href="#cb33-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb33-402"><a href="#cb33-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"v_"</span>),</span>
<span id="cb33-403"><a href="#cb33-403" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">abs</span>(.x) <span class="sc">&lt;=</span> <span class="fl">1e-4</span>, <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"vsv"</span>, <span class="fu">str_remove</span>(<span class="fu">cur_column</span>(), <span class="st">"^v"</span>))), .x),</span>
<span id="cb33-404"><a href="#cb33-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">.names =</span> <span class="st">"{.col}"</span></span>
<span id="cb33-405"><a href="#cb33-405" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb33-406"><a href="#cb33-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-407"><a href="#cb33-407" aria-hidden="true" tabindex="-1"></a>fh_step <span class="ot">&lt;-</span></span>
<span id="cb33-408"><a href="#cb33-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="at">X =</span> <span class="fu">paste0</span>(<span class="st">"direct_povrate"</span>, <span class="fu">unique</span>(survey_dt[[year_var]])),</span>
<span id="cb33-409"><a href="#cb33-409" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-410"><a href="#cb33-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-411"><a href="#cb33-411" aria-hidden="true" tabindex="-1"></a>           model_obj <span class="ot">&lt;-</span></span>
<span id="cb33-412"><a href="#cb33-412" aria-hidden="true" tabindex="-1"></a>           <span class="fu">step_wrapper</span>(<span class="at">dt =</span> mfh_dt,</span>
<span id="cb33-413"><a href="#cb33-413" aria-hidden="true" tabindex="-1"></a>                        <span class="at">xvars =</span> candidate_vars,</span>
<span id="cb33-414"><a href="#cb33-414" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> x,</span>
<span id="cb33-415"><a href="#cb33-415" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cor_thresh =</span> <span class="fl">0.7</span>,</span>
<span id="cb33-416"><a href="#cb33-416" aria-hidden="true" tabindex="-1"></a>                        <span class="at">k =</span> <span class="fu">log</span>(<span class="fu">nrow</span>(mfh_dt))) <span class="do">### using log(n) to force BIC selection</span></span>
<span id="cb33-417"><a href="#cb33-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-418"><a href="#cb33-418" aria-hidden="true" tabindex="-1"></a>           xx <span class="ot">&lt;-</span> <span class="fu">names</span>(model_obj<span class="sc">$</span>coefficients)[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"(Intercept)"</span>,</span>
<span id="cb33-419"><a href="#cb33-419" aria-hidden="true" tabindex="-1"></a>                                                      <span class="fu">names</span>(model_obj<span class="sc">$</span>coefficients))]</span>
<span id="cb33-420"><a href="#cb33-420" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span>(xx)</span>
<span id="cb33-421"><a href="#cb33-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-422"><a href="#cb33-422" aria-hidden="true" tabindex="-1"></a>         })</span>
<span id="cb33-423"><a href="#cb33-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-424"><a href="#cb33-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-425"><a href="#cb33-425" aria-hidden="true" tabindex="-1"></a><span class="co"># mfh_formula &lt;- </span></span>
<span id="cb33-426"><a href="#cb33-426" aria-hidden="true" tabindex="-1"></a><span class="co">#   mapply(x = paste0("direct_povrate", unique(survey_dt[[year_var]])),</span></span>
<span id="cb33-427"><a href="#cb33-427" aria-hidden="true" tabindex="-1"></a><span class="co">#          y = variance_cols,</span></span>
<span id="cb33-428"><a href="#cb33-428" aria-hidden="true" tabindex="-1"></a><span class="co">#          FUN = function(x, y){</span></span>
<span id="cb33-429"><a href="#cb33-429" aria-hidden="true" tabindex="-1"></a><span class="co">#            </span></span>
<span id="cb33-430"><a href="#cb33-430" aria-hidden="true" tabindex="-1"></a><span class="co">#            fh_step &lt;- step_wrapper_fh(dt = mfh_dt,</span></span>
<span id="cb33-431"><a href="#cb33-431" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       xvars = candidate_vars,</span></span>
<span id="cb33-432"><a href="#cb33-432" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       y = x,</span></span>
<span id="cb33-433"><a href="#cb33-433" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       cor_thresh = 0.8,</span></span>
<span id="cb33-434"><a href="#cb33-434" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       criteria = "BIC",</span></span>
<span id="cb33-435"><a href="#cb33-435" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       vardir = y,</span></span>
<span id="cb33-436"><a href="#cb33-436" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       transformation = "no")</span></span>
<span id="cb33-437"><a href="#cb33-437" aria-hidden="true" tabindex="-1"></a><span class="co">#            </span></span>
<span id="cb33-438"><a href="#cb33-438" aria-hidden="true" tabindex="-1"></a><span class="co">#            return(fh_step$fixed)</span></span>
<span id="cb33-439"><a href="#cb33-439" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb33-440"><a href="#cb33-440" aria-hidden="true" tabindex="-1"></a><span class="co">#          },</span></span>
<span id="cb33-441"><a href="#cb33-441" aria-hidden="true" tabindex="-1"></a><span class="co">#          SIMPLIFY = FALSE)</span></span>
<span id="cb33-442"><a href="#cb33-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-443"><a href="#cb33-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-444"><a href="#cb33-444" aria-hidden="true" tabindex="-1"></a>mfh_formula <span class="ot">&lt;-</span></span>
<span id="cb33-445"><a href="#cb33-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapply</span>(<span class="at">FUN =</span> <span class="cf">function</span>(x, rhs){</span>
<span id="cb33-446"><a href="#cb33-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-447"><a href="#cb33-447" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(x, <span class="st">" ~ "</span>, <span class="fu">paste</span>(rhs, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb33-448"><a href="#cb33-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-449"><a href="#cb33-449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb33-450"><a href="#cb33-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-451"><a href="#cb33-451" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb33-452"><a href="#cb33-452" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"direct_povrate"</span>, <span class="fu">unique</span>(survey_dt[[year_var]])),</span>
<span id="cb33-453"><a href="#cb33-453" aria-hidden="true" tabindex="-1"></a>  <span class="at">rhs =</span> fh_step <span class="sc">|&gt;</span> <span class="fu">map</span>(<span class="sc">~</span>.x[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]),</span>
<span id="cb33-454"><a href="#cb33-454" aria-hidden="true" tabindex="-1"></a>  <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-455"><a href="#cb33-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-456"><a href="#cb33-456" aria-hidden="true" tabindex="-1"></a><span class="do">### here is what the 3 equations look like</span></span>
<span id="cb33-457"><a href="#cb33-457" aria-hidden="true" tabindex="-1"></a>mfh_formula</span>
<span id="cb33-458"><a href="#cb33-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-459"><a href="#cb33-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-460"><a href="#cb33-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-461"><a href="#cb33-461" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Fitting the Multivariate Fay Herriot Model</span></span>
<span id="cb33-462"><a href="#cb33-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-463"><a href="#cb33-463" aria-hidden="true" tabindex="-1"></a>Next, we show how to use the <span class="in">`msae`</span> R package to estimate the Empirical Best Linear Unbiased Predictor (EBLUP) for the poverty map using the <span class="in">`eblupMFH2()`</span> which allow for time series fay herriot estimation under homoskedastic assumptions. For completeness, we also briefly perform the previous described direct estimation in step 1, using the <span class="in">`eblupUFH()`</span> function as well as the <span class="in">`eblupMFH1()`</span> for the fay herriot model.</span>
<span id="cb33-464"><a href="#cb33-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-465"><a href="#cb33-465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mvfh-est}</span></span>
<span id="cb33-466"><a href="#cb33-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-467"><a href="#cb33-467" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-468"><a href="#cb33-468" aria-hidden="true" tabindex="-1"></a>mfh_dt1 <span class="ot">&lt;-</span> mfh_dt <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"v_pov_"</span>), <span class="sc">~</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb33-469"><a href="#cb33-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-470"><a href="#cb33-470" aria-hidden="true" tabindex="-1"></a><span class="co"># univariate FH</span></span>
<span id="cb33-471"><a href="#cb33-471" aria-hidden="true" tabindex="-1"></a>model0_obj <span class="ot">&lt;-</span> <span class="fu">eblupUFH</span>(mfh_formula, <span class="at">vardir =</span> varcols, <span class="at">data =</span> mfh_dt)</span>
<span id="cb33-472"><a href="#cb33-472" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(model0_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb33-473"><a href="#cb33-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-474"><a href="#cb33-474" aria-hidden="true" tabindex="-1"></a><span class="co"># multivariate FH 1</span></span>
<span id="cb33-475"><a href="#cb33-475" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="at">msg =</span> <span class="st">"eblupMFH1"</span>)</span>
<span id="cb33-476"><a href="#cb33-476" aria-hidden="true" tabindex="-1"></a>model1_obj <span class="ot">&lt;-</span> <span class="fu">eblupMFH1</span>(mfh_formula, <span class="at">vardir =</span> varcols, <span class="at">data =</span> mfh_dt, <span class="at">MAXITER =</span> <span class="dv">10000</span>, <span class="at">PRECISION =</span> <span class="fl">0.01</span>)</span>
<span id="cb33-477"><a href="#cb33-477" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(model1_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb33-478"><a href="#cb33-478" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb33-479"><a href="#cb33-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-480"><a href="#cb33-480" aria-hidden="true" tabindex="-1"></a><span class="co"># multivariate FH 2</span></span>
<span id="cb33-481"><a href="#cb33-481" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="at">msg =</span> <span class="st">"eblupMFH2"</span>)</span>
<span id="cb33-482"><a href="#cb33-482" aria-hidden="true" tabindex="-1"></a>model2_obj <span class="ot">&lt;-</span> <span class="fu">eblupMFH2</span>(mfh_formula, <span class="at">vardir =</span> varcols, <span class="at">data =</span> mfh_dt, <span class="at">MAXITER =</span> <span class="fl">1e10</span>, <span class="at">PRECISION =</span> <span class="fl">0.01</span>)</span>
<span id="cb33-483"><a href="#cb33-483" aria-hidden="true" tabindex="-1"></a>bd_out <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(model2_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb33-484"><a href="#cb33-484" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb33-485"><a href="#cb33-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-486"><a href="#cb33-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-487"><a href="#cb33-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mvfh-load}</span></span>
<span id="cb33-488"><a href="#cb33-488" aria-hidden="true" tabindex="-1"></a>model0_obj <span class="ot">&lt;-</span> bd_out <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"model0_obj"</span>)</span>
<span id="cb33-489"><a href="#cb33-489" aria-hidden="true" tabindex="-1"></a>model1_obj <span class="ot">&lt;-</span> bd_out <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"model1_obj"</span>)</span>
<span id="cb33-490"><a href="#cb33-490" aria-hidden="true" tabindex="-1"></a>model2_obj <span class="ot">&lt;-</span> bd_out <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"model2_obj"</span>)</span>
<span id="cb33-491"><a href="#cb33-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-492"><a href="#cb33-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-493"><a href="#cb33-493" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Post Estimation Diagnostics: Model Assumption Checks for Linearity, Normality and Outliers</span></span>
<span id="cb33-494"><a href="#cb33-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-495"><a href="#cb33-495" aria-hidden="true" tabindex="-1"></a>We now verify the assumptions of the MFH3 model. This includes assessing linearity, the normality of the predicted area effects and standardized residuals, as well as checking for the presence of outlying areas.</span>
<span id="cb33-496"><a href="#cb33-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-497"><a href="#cb33-497" aria-hidden="true" tabindex="-1"></a><span class="fu">### Linearity Test</span></span>
<span id="cb33-498"><a href="#cb33-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-499"><a href="#cb33-499" aria-hidden="true" tabindex="-1"></a>To assess whether a linear regression model may be incorrectly specified — for instance, due to omitted variables or incorrect functional form — we can use Ramsey’s Regression Equation Specification Error Test (RESET). This test examines whether adding nonlinear combinations (typically powers) of the model’s fitted values significantly improves the model. However, the outcome of interest now is the model MSEs. A significant test result (low p-value) suggests the model is mis-specified and may benefit from additional or transformed predictors.</span>
<span id="cb33-500"><a href="#cb33-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-501"><a href="#cb33-501" aria-hidden="true" tabindex="-1"></a>We implement Ramsey’s RESET test in R using the resettest() function from the lmtest package:</span>
<span id="cb33-502"><a href="#cb33-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-503"><a href="#cb33-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lin-test}</span></span>
<span id="cb33-504"><a href="#cb33-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-505"><a href="#cb33-505" aria-hidden="true" tabindex="-1"></a><span class="do">### lets create a dataframe with the errors and estimated poverty rates</span></span>
<span id="cb33-506"><a href="#cb33-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-507"><a href="#cb33-507" aria-hidden="true" tabindex="-1"></a>eblup_dt <span class="ot">&lt;-</span> model2_obj<span class="sc">$</span>eblup</span>
<span id="cb33-508"><a href="#cb33-508" aria-hidden="true" tabindex="-1"></a>mse_dt <span class="ot">&lt;-</span> model2_obj<span class="sc">$</span>MSE</span>
<span id="cb33-509"><a href="#cb33-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-510"><a href="#cb33-510" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eblup_dt) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"eblup_"</span>, <span class="fu">colnames</span>(eblup_dt))</span>
<span id="cb33-511"><a href="#cb33-511" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mse_dt) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mse_"</span>, <span class="fu">colnames</span>(mse_dt))</span>
<span id="cb33-512"><a href="#cb33-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-513"><a href="#cb33-513" aria-hidden="true" tabindex="-1"></a>reset_dt <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(eblup_dt, mse_dt) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb33-514"><a href="#cb33-514" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-515"><a href="#cb33-515" aria-hidden="true" tabindex="-1"></a><span class="do">### lets perform the reset test on the pairs of variables as appropriate i.e. poverty = B0 + B1*MSE</span></span>
<span id="cb33-516"><a href="#cb33-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-517"><a href="#cb33-517" aria-hidden="true" tabindex="-1"></a>test_list <span class="ot">&lt;-</span> </span>
<span id="cb33-518"><a href="#cb33-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="fu">unique</span>(survey_dt[[year_var]]), <span class="cf">function</span>(x) {</span>
<span id="cb33-519"><a href="#cb33-519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-520"><a href="#cb33-520" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset only the columns for year x</span></span>
<span id="cb33-521"><a href="#cb33-521" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> reset_dt <span class="sc">|&gt;</span></span>
<span id="cb33-522"><a href="#cb33-522" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="fu">paste0</span>(x, <span class="st">"$"</span>)))  <span class="co"># Select columns ending with current year</span></span>
<span id="cb33-523"><a href="#cb33-523" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-524"><a href="#cb33-524" aria-hidden="true" tabindex="-1"></a>    yvar <span class="ot">&lt;-</span> <span class="fu">colnames</span>(dt)[<span class="fu">grepl</span>(<span class="st">"^eblup_"</span>, <span class="fu">colnames</span>(dt))]</span>
<span id="cb33-525"><a href="#cb33-525" aria-hidden="true" tabindex="-1"></a>    xvar <span class="ot">&lt;-</span> <span class="fu">colnames</span>(dt)[<span class="fu">grepl</span>(<span class="st">"^mse_"</span>, <span class="fu">colnames</span>(dt))]</span>
<span id="cb33-526"><a href="#cb33-526" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-527"><a href="#cb33-527" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create formula with squared and cubed terms using I()</span></span>
<span id="cb33-528"><a href="#cb33-528" aria-hidden="true" tabindex="-1"></a>    form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(</span>
<span id="cb33-529"><a href="#cb33-529" aria-hidden="true" tabindex="-1"></a>      xvar, <span class="st">" ~ "</span>, </span>
<span id="cb33-530"><a href="#cb33-530" aria-hidden="true" tabindex="-1"></a>      yvar, <span class="st">" + I("</span>, yvar, <span class="st">"^2)"</span></span>
<span id="cb33-531"><a href="#cb33-531" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb33-532"><a href="#cb33-532" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-533"><a href="#cb33-533" aria-hidden="true" tabindex="-1"></a>    model_obj <span class="ot">&lt;-</span> <span class="fu">lm</span>(form, <span class="at">data =</span> dt)</span>
<span id="cb33-534"><a href="#cb33-534" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-535"><a href="#cb33-535" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(model_obj)</span>
<span id="cb33-536"><a href="#cb33-536" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-537"><a href="#cb33-537" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb33-538"><a href="#cb33-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-539"><a href="#cb33-539" aria-hidden="true" tabindex="-1"></a>reset_dt2 <span class="ot">&lt;-</span> </span>
<span id="cb33-540"><a href="#cb33-540" aria-hidden="true" tabindex="-1"></a>  reset_dt <span class="sc">|&gt;</span> </span>
<span id="cb33-541"><a href="#cb33-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb33-542"><a href="#cb33-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="fu">contains</span>(<span class="st">"eblup"</span>), <span class="fu">contains</span>(<span class="st">"mse"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb33-543"><a href="#cb33-543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-544"><a href="#cb33-544" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">str_extract</span>(name, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(),</span>
<span id="cb33-545"><a href="#cb33-545" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span>  <span class="fu">str_extract</span>(name, <span class="st">"eblup|mse"</span>)</span>
<span id="cb33-546"><a href="#cb33-546" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb33-547"><a href="#cb33-547" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">|&gt;</span> </span>
<span id="cb33-548"><a href="#cb33-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var, <span class="at">values_from =</span> value )</span>
<span id="cb33-549"><a href="#cb33-549" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-550"><a href="#cb33-550" aria-hidden="true" tabindex="-1"></a>reset_dt2 <span class="sc">|&gt;</span> </span>
<span id="cb33-551"><a href="#cb33-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb33-552"><a href="#cb33-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> eblup, <span class="at">y =</span> mse) <span class="sc">+</span> </span>
<span id="cb33-553"><a href="#cb33-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb33-554"><a href="#cb33-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> year) <span class="sc">+</span> </span>
<span id="cb33-555"><a href="#cb33-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span> </span>
<span id="cb33-556"><a href="#cb33-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb33-557"><a href="#cb33-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-558"><a href="#cb33-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-559"><a href="#cb33-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-560"><a href="#cb33-560" aria-hidden="true" tabindex="-1"></a>Here is what the results look like:</span>
<span id="cb33-561"><a href="#cb33-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-564"><a href="#cb33-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-565"><a href="#cb33-565" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-566"><a href="#cb33-566" aria-hidden="true" tabindex="-1"></a>test_list <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="at">X =</span> ., <span class="at">FUN =</span> summary)</span>
<span id="cb33-567"><a href="#cb33-567" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-568"><a href="#cb33-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-569"><a href="#cb33-569" aria-hidden="true" tabindex="-1"></a>The results particularly for the final 2 years indicate that we might need to retransform the variables in the model as there are potentially non linear relationships which our model is not capturing. Perhaps creating higher order polynomials and other variable transformations of our right hand side variables reduce the error rates within the model.</span>
<span id="cb33-570"><a href="#cb33-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-571"><a href="#cb33-571" aria-hidden="true" tabindex="-1"></a><span class="fu">### Evaluating the Normality Assumption</span></span>
<span id="cb33-572"><a href="#cb33-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-573"><a href="#cb33-573" aria-hidden="true" tabindex="-1"></a><span class="fu">#### The Shapiro Wilks Test</span></span>
<span id="cb33-574"><a href="#cb33-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-575"><a href="#cb33-575" aria-hidden="true" tabindex="-1"></a>We use the shapiro wilks test of normality using the <span class="in">`shapiro.test()`</span> function in base R. The Shapiro-Wilk test assesses whether a sample of data is drawn from a normally distributed population. It does so by comparing the order statistics (i.e., sorted values) of the sample to the expected values under a normal distribution. Specifically, the test statistic $W$ is a ratio of the squared correlation between the observed sample quantiles and the corresponding normal quantiles.</span>
<span id="cb33-576"><a href="#cb33-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-577"><a href="#cb33-577" aria-hidden="true" tabindex="-1"></a>First, we perform the shapiro wilks normality test on the model errors, $\varepsilon$. We show both the normality distribution histogram as well as the qqplots as below:</span>
<span id="cb33-578"><a href="#cb33-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-579"><a href="#cb33-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sw-test}</span></span>
<span id="cb33-580"><a href="#cb33-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-581"><a href="#cb33-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-582"><a href="#cb33-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-583"><a href="#cb33-583" aria-hidden="true" tabindex="-1"></a><span class="do">### first lets replace the negative values with 0</span></span>
<span id="cb33-584"><a href="#cb33-584" aria-hidden="true" tabindex="-1"></a>eblup_dt[eblup_dt <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb33-585"><a href="#cb33-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-586"><a href="#cb33-586" aria-hidden="true" tabindex="-1"></a><span class="do">### evaluating the normality assumption</span></span>
<span id="cb33-587"><a href="#cb33-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-588"><a href="#cb33-588" aria-hidden="true" tabindex="-1"></a><span class="do">#### first lets create a residual table by looking at the difference between actual and predicted poverty rates</span></span>
<span id="cb33-589"><a href="#cb33-589" aria-hidden="true" tabindex="-1"></a>resid_dt <span class="ot">&lt;-</span> mfh_dt[,<span class="fu">paste0</span>(<span class="st">"direct_povrate"</span>, <span class="fu">unique</span>(survey_dt[[year_var]]))] <span class="sc">-</span> eblup_dt</span>
<span id="cb33-590"><a href="#cb33-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-591"><a href="#cb33-591" aria-hidden="true" tabindex="-1"></a><span class="do">### perform the shapiro test</span></span>
<span id="cb33-592"><a href="#cb33-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-593"><a href="#cb33-593" aria-hidden="true" tabindex="-1"></a>shapiro_obj <span class="ot">&lt;-</span> <span class="fu">apply</span>(resid_dt, <span class="dv">2</span>, shapiro.test)</span>
<span id="cb33-594"><a href="#cb33-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-595"><a href="#cb33-595" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-596"><a href="#cb33-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">names</span>(shapiro_obj),</span>
<span id="cb33-597"><a href="#cb33-597" aria-hidden="true" tabindex="-1"></a>             <span class="at">W =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb33-598"><a href="#cb33-598" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-599"><a href="#cb33-599" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb33-600"><a href="#cb33-600" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span>(x<span class="sc">$</span>statistic[[<span class="dv">1</span>]])</span>
<span id="cb33-601"><a href="#cb33-601" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb33-602"><a href="#cb33-602" aria-hidden="true" tabindex="-1"></a>                        }) <span class="sc">%&gt;%</span></span>
<span id="cb33-603"><a href="#cb33-603" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>(),</span>
<span id="cb33-604"><a href="#cb33-604" aria-hidden="true" tabindex="-1"></a>             <span class="at">p_value =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb33-605"><a href="#cb33-605" aria-hidden="true" tabindex="-1"></a>                              <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-606"><a href="#cb33-606" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb33-607"><a href="#cb33-607" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>(x<span class="sc">$</span>p.value)</span>
<span id="cb33-608"><a href="#cb33-608" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb33-609"><a href="#cb33-609" aria-hidden="true" tabindex="-1"></a>                              }) <span class="sc">%&gt;%</span></span>
<span id="cb33-610"><a href="#cb33-610" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>())</span>
<span id="cb33-611"><a href="#cb33-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-612"><a href="#cb33-612" aria-hidden="true" tabindex="-1"></a><span class="do">### plot the results</span></span>
<span id="cb33-613"><a href="#cb33-613" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-614"><a href="#cb33-614" aria-hidden="true" tabindex="-1"></a>  summary_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-615"><a href="#cb33-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"W = "</span>, <span class="fu">round</span>(W, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"p = "</span>, <span class="fu">signif</span>(p_value, <span class="dv">3</span>)))</span>
<span id="cb33-616"><a href="#cb33-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-617"><a href="#cb33-617" aria-hidden="true" tabindex="-1"></a>resid_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-618"><a href="#cb33-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb33-619"><a href="#cb33-619" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Time"</span>, </span>
<span id="cb33-620"><a href="#cb33-620" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Residual"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-621"><a href="#cb33-621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Residual)) <span class="sc">+</span> </span>
<span id="cb33-622"><a href="#cb33-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb33-623"><a href="#cb33-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> label),</span>
<span id="cb33-624"><a href="#cb33-624" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="fl">1.2</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb33-625"><a href="#cb33-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Time, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb33-626"><a href="#cb33-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb33-627"><a href="#cb33-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Histograms by Time Period"</span>)</span>
<span id="cb33-628"><a href="#cb33-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-629"><a href="#cb33-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-630"><a href="#cb33-630" aria-hidden="true" tabindex="-1"></a><span class="do">### here's how to create qqplots</span></span>
<span id="cb33-631"><a href="#cb33-631" aria-hidden="true" tabindex="-1"></a>resid_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-632"><a href="#cb33-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb33-633"><a href="#cb33-633" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Time"</span>,</span>
<span id="cb33-634"><a href="#cb33-634" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Residual"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-635"><a href="#cb33-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> Residual)) <span class="sc">+</span></span>
<span id="cb33-636"><a href="#cb33-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb33-637"><a href="#cb33-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb33-638"><a href="#cb33-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Time, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb33-639"><a href="#cb33-639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-640"><a href="#cb33-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"QQ Plots of Residuals by Time Period"</span>)</span>
<span id="cb33-641"><a href="#cb33-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-642"><a href="#cb33-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-643"><a href="#cb33-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-644"><a href="#cb33-644" aria-hidden="true" tabindex="-1"></a>Likewise, we test the normality of the random effect variable</span>
<span id="cb33-645"><a href="#cb33-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-648"><a href="#cb33-648" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-649"><a href="#cb33-649" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-650"><a href="#cb33-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-651"><a href="#cb33-651" aria-hidden="true" tabindex="-1"></a><span class="do">#### For the random effects</span></span>
<span id="cb33-652"><a href="#cb33-652" aria-hidden="true" tabindex="-1"></a>raneff_dt <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(model2_obj<span class="sc">$</span>randomEffect)</span>
<span id="cb33-653"><a href="#cb33-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-654"><a href="#cb33-654" aria-hidden="true" tabindex="-1"></a><span class="do">### lets run the shapiro wilks tests again</span></span>
<span id="cb33-655"><a href="#cb33-655" aria-hidden="true" tabindex="-1"></a>shapiro_obj <span class="ot">&lt;-</span> <span class="fu">apply</span>(raneff_dt, <span class="dv">2</span>, shapiro.test)</span>
<span id="cb33-656"><a href="#cb33-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-657"><a href="#cb33-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-658"><a href="#cb33-658" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-659"><a href="#cb33-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">names</span>(shapiro_obj),</span>
<span id="cb33-660"><a href="#cb33-660" aria-hidden="true" tabindex="-1"></a>             <span class="at">W =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb33-661"><a href="#cb33-661" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-662"><a href="#cb33-662" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb33-663"><a href="#cb33-663" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span>(x<span class="sc">$</span>statistic[[<span class="dv">1</span>]])</span>
<span id="cb33-664"><a href="#cb33-664" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb33-665"><a href="#cb33-665" aria-hidden="true" tabindex="-1"></a>                        }) <span class="sc">%&gt;%</span></span>
<span id="cb33-666"><a href="#cb33-666" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>(),</span>
<span id="cb33-667"><a href="#cb33-667" aria-hidden="true" tabindex="-1"></a>             <span class="at">p_value =</span> <span class="fu">lapply</span>(<span class="at">X =</span> shapiro_obj,</span>
<span id="cb33-668"><a href="#cb33-668" aria-hidden="true" tabindex="-1"></a>                              <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-669"><a href="#cb33-669" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb33-670"><a href="#cb33-670" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>(x<span class="sc">$</span>p.value)</span>
<span id="cb33-671"><a href="#cb33-671" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb33-672"><a href="#cb33-672" aria-hidden="true" tabindex="-1"></a>                              }) <span class="sc">%&gt;%</span></span>
<span id="cb33-673"><a href="#cb33-673" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.numeric</span>())</span>
<span id="cb33-674"><a href="#cb33-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-675"><a href="#cb33-675" aria-hidden="true" tabindex="-1"></a><span class="do">### plot the results</span></span>
<span id="cb33-676"><a href="#cb33-676" aria-hidden="true" tabindex="-1"></a>summary_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-677"><a href="#cb33-677" aria-hidden="true" tabindex="-1"></a>  summary_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-678"><a href="#cb33-678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"W = "</span>, <span class="fu">round</span>(W, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"p = "</span>, <span class="fu">signif</span>(p_value, <span class="dv">3</span>)))</span>
<span id="cb33-679"><a href="#cb33-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-680"><a href="#cb33-680" aria-hidden="true" tabindex="-1"></a>raneff_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-681"><a href="#cb33-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb33-682"><a href="#cb33-682" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Time"</span>, </span>
<span id="cb33-683"><a href="#cb33-683" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"RandEff"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-684"><a href="#cb33-684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> RandEff)) <span class="sc">+</span> </span>
<span id="cb33-685"><a href="#cb33-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>, <span class="at">fill =</span> <span class="st">"darkorange"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb33-686"><a href="#cb33-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> label),</span>
<span id="cb33-687"><a href="#cb33-687" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="fl">1.2</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb33-688"><a href="#cb33-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Time, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb33-689"><a href="#cb33-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb33-690"><a href="#cb33-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Random Effects Histograms by Time Period"</span>)</span>
<span id="cb33-691"><a href="#cb33-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-692"><a href="#cb33-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-693"><a href="#cb33-693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-694"><a href="#cb33-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-695"><a href="#cb33-695" aria-hidden="true" tabindex="-1"></a>In both cases, we compare the p-value to the 0.05 level of significance. The results suggest that in most cases we have to reject the null hypothesis of normally distributed model errors and random effects. This doesn't affect the validity of our poverty estimates for the Multivariate Fay Herriot model. However, subsequent analysis that will assume a normal distribution of the model errors cannot be performed. One good example of this is the statistical significance test for changes in poverty rates over time. For the purposes of this tutorial, we will carry on to show how to perform this under the assumption of normally distributed model errors. However, if the test for normality fails, this test cannot be carried out.</span>
<span id="cb33-696"><a href="#cb33-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-697"><a href="#cb33-697" aria-hidden="true" tabindex="-1"></a>Next, we will show the benefits of small area estimation over direct estimation</span>
<span id="cb33-698"><a href="#cb33-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-699"><a href="#cb33-699" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing Direct Estimation to Multivariate Model Outputs</span></span>
<span id="cb33-700"><a href="#cb33-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-701"><a href="#cb33-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message = FALSE, error = FALSE}</span></span>
<span id="cb33-702"><a href="#cb33-702" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-703"><a href="#cb33-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-704"><a href="#cb33-704" aria-hidden="true" tabindex="-1"></a>model2mse_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-705"><a href="#cb33-705" aria-hidden="true" tabindex="-1"></a>  model2_obj<span class="sc">$</span>MSE <span class="sc">|&gt;</span></span>
<span id="cb33-706"><a href="#cb33-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb33-707"><a href="#cb33-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb33-708"><a href="#cb33-708" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb33-709"><a href="#cb33-709" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb33-710"><a href="#cb33-710" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb33-711"><a href="#cb33-711" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"modelMSE"</span></span>
<span id="cb33-712"><a href="#cb33-712" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-713"><a href="#cb33-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb33-714"><a href="#cb33-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-715"><a href="#cb33-715" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-716"><a href="#cb33-716" aria-hidden="true" tabindex="-1"></a>  model2_obj<span class="sc">$</span>eblup <span class="sc">|&gt;</span></span>
<span id="cb33-717"><a href="#cb33-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb33-718"><a href="#cb33-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb33-719"><a href="#cb33-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb33-720"><a href="#cb33-720" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb33-721"><a href="#cb33-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb33-722"><a href="#cb33-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"modelpov"</span></span>
<span id="cb33-723"><a href="#cb33-723" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-724"><a href="#cb33-724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb33-725"><a href="#cb33-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-726"><a href="#cb33-726" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(model2mse_dt, model2pov_dt)</span>
<span id="cb33-727"><a href="#cb33-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-728"><a href="#cb33-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-729"><a href="#cb33-729" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-730"><a href="#cb33-730" aria-hidden="true" tabindex="-1"></a>  model2pov_dt <span class="sc">|&gt;</span></span>
<span id="cb33-731"><a href="#cb33-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">modelCV =</span> <span class="fu">sqrt</span>(modelMSE) <span class="sc">/</span> modelpov)</span>
<span id="cb33-732"><a href="#cb33-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-733"><a href="#cb33-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-734"><a href="#cb33-734" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(model2pov_dt, </span>
<span id="cb33-735"><a href="#cb33-735" aria-hidden="true" tabindex="-1"></a>                      direct_dt, </span>
<span id="cb33-736"><a href="#cb33-736" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by =</span> <span class="fu">c</span>(area_vars[[<span class="dv">1</span>]], </span>
<span id="cb33-737"><a href="#cb33-737" aria-hidden="true" tabindex="-1"></a>                             year_var))</span>
<span id="cb33-738"><a href="#cb33-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-739"><a href="#cb33-739" aria-hidden="true" tabindex="-1"></a><span class="do">### compute direct CVs and include in `model2pov_dt`</span></span>
<span id="cb33-740"><a href="#cb33-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-741"><a href="#cb33-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-742"><a href="#cb33-742" aria-hidden="true" tabindex="-1"></a><span class="do">## we have to reshape the direct estimates data in mfh_dt from wide to long</span></span>
<span id="cb33-743"><a href="#cb33-743" aria-hidden="true" tabindex="-1"></a><span class="do">## and then merge with model2pov_dt </span></span>
<span id="cb33-744"><a href="#cb33-744" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-745"><a href="#cb33-745" aria-hidden="true" tabindex="-1"></a>mfh_dt <span class="sc">|&gt;</span></span>
<span id="cb33-746"><a href="#cb33-746" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(variance_cols),  <span class="co"># add this!</span></span>
<span id="cb33-747"><a href="#cb33-747" aria-hidden="true" tabindex="-1"></a>                <span class="fu">all_of</span>(area_vars[[<span class="dv">1</span>]])) <span class="sc">|&gt;</span></span>
<span id="cb33-748"><a href="#cb33-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb33-749"><a href="#cb33-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">all_of</span>(area_vars[[<span class="dv">1</span>]]),</span>
<span id="cb33-750"><a href="#cb33-750" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"indicator_year"</span>,</span>
<span id="cb33-751"><a href="#cb33-751" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb33-752"><a href="#cb33-752" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-753"><a href="#cb33-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-754"><a href="#cb33-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb33-755"><a href="#cb33-755" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_starts</span>(indicator_year, <span class="st">"v_pov_indicator"</span>) <span class="sc">~</span> <span class="st">"variance"</span></span>
<span id="cb33-756"><a href="#cb33-756" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb33-757"><a href="#cb33-757" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">str_extract</span>(indicator_year, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>)</span>
<span id="cb33-758"><a href="#cb33-758" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-759"><a href="#cb33-759" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>indicator_year) <span class="sc">|&gt;</span></span>
<span id="cb33-760"><a href="#cb33-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb33-761"><a href="#cb33-761" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> type,</span>
<span id="cb33-762"><a href="#cb33-762" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value</span>
<span id="cb33-763"><a href="#cb33-763" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-764"><a href="#cb33-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year)) <span class="sc">|&gt;</span></span>
<span id="cb33-765"><a href="#cb33-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(model2pov_dt,</span>
<span id="cb33-766"><a href="#cb33-766" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(area_vars[[<span class="dv">1</span>]], year_var),</span>
<span id="cb33-767"><a href="#cb33-767" aria-hidden="true" tabindex="-1"></a>        <span class="at">all =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-768"><a href="#cb33-768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">direct_CV =</span> <span class="fu">sqrt</span>(variance) <span class="sc">/</span> direct_povrate) <span class="sc">|&gt;</span></span>
<span id="cb33-769"><a href="#cb33-769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(sampsize_dt <span class="sc">%&gt;%</span></span>
<span id="cb33-770"><a href="#cb33-770" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[<span class="dv">1</span>]), <span class="st">"N"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-771"><a href="#cb33-771" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unique</span>(), </span>
<span id="cb33-772"><a href="#cb33-772" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> area_vars[[<span class="dv">1</span>]])</span>
<span id="cb33-773"><a href="#cb33-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-774"><a href="#cb33-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-775"><a href="#cb33-775" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-776"><a href="#cb33-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-777"><a href="#cb33-777" aria-hidden="true" tabindex="-1"></a>Now lets plot the direct against the model CVs to get a sense for the gains made as a result of applying the MFH modelling approach over direct estimation. We will also show the sample sizes for each year to show that large sample size reduce the gains from small area estimation.</span>
<span id="cb33-778"><a href="#cb33-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-781"><a href="#cb33-781" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-782"><a href="#cb33-782" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-783"><a href="#cb33-783" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb33-784"><a href="#cb33-784" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 20</span></span>
<span id="cb33-785"><a href="#cb33-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-786"><a href="#cb33-786" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">sapply</span>(model2pov_dt, is.numeric)</span>
<span id="cb33-787"><a href="#cb33-787" aria-hidden="true" tabindex="-1"></a>model2pov_dt_clean <span class="ot">&lt;-</span> model2pov_dt[<span class="fu">complete.cases</span>(model2pov_dt[, numeric_cols]) <span class="sc">&amp;</span></span>
<span id="cb33-788"><a href="#cb33-788" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">apply</span>(model2pov_dt[, numeric_cols], <span class="dv">1</span>, <span class="cf">function</span>(row)</span>
<span id="cb33-789"><a href="#cb33-789" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">all</span>(<span class="fu">is.finite</span>(row))), ]</span>
<span id="cb33-790"><a href="#cb33-790" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-791"><a href="#cb33-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-792"><a href="#cb33-792" aria-hidden="true" tabindex="-1"></a><span class="co"># Make year a factor using year_var</span></span>
<span id="cb33-793"><a href="#cb33-793" aria-hidden="true" tabindex="-1"></a>model2pov_dt_clean[[year_var]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(model2pov_dt_clean[[year_var]])</span>
<span id="cb33-794"><a href="#cb33-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-795"><a href="#cb33-795" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute max values for scaling</span></span>
<span id="cb33-796"><a href="#cb33-796" aria-hidden="true" tabindex="-1"></a>max_n <span class="ot">&lt;-</span> <span class="fu">max</span>(model2pov_dt_clean<span class="sc">$</span>N, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-797"><a href="#cb33-797" aria-hidden="true" tabindex="-1"></a>max_cv <span class="ot">&lt;-</span> <span class="fu">max</span>(model2pov_dt_clean<span class="sc">$</span>direct_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-798"><a href="#cb33-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-799"><a href="#cb33-799" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb33-800"><a href="#cb33-800" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model2pov_dt_clean, <span class="fu">aes</span>(<span class="at">x =</span> .data[[year_var]])) <span class="sc">+</span></span>
<span id="cb33-801"><a href="#cb33-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> direct_CV, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"Direct CV"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb33-802"><a href="#cb33-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> modelCV, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"Model CV"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb33-803"><a href="#cb33-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> N <span class="sc">/</span> max_n <span class="sc">*</span> max_cv, <span class="at">color =</span> <span class="st">"Sample Size (N)"</span>),</span>
<span id="cb33-804"><a href="#cb33-804" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb33-805"><a href="#cb33-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(.data[[area_vars[[<span class="dv">1</span>]]]]), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb33-806"><a href="#cb33-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb33-807"><a href="#cb33-807" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Coefficient of Variation (CV)"</span>,</span>
<span id="cb33-808"><a href="#cb33-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">*</span> max_n <span class="sc">/</span> max_cv, <span class="at">name =</span> <span class="st">"Sample Size (N)"</span>)</span>
<span id="cb33-809"><a href="#cb33-809" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-810"><a href="#cb33-810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Direct CV"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>,</span>
<span id="cb33-811"><a href="#cb33-811" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Model CV"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>,</span>
<span id="cb33-812"><a href="#cb33-812" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Sample Size (N)"</span> <span class="ot">=</span> <span class="st">"grey40"</span>)) <span class="sc">+</span></span>
<span id="cb33-813"><a href="#cb33-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb33-814"><a href="#cb33-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-815"><a href="#cb33-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb33-816"><a href="#cb33-816" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb33-817"><a href="#cb33-817" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"grey40"</span>),</span>
<span id="cb33-818"><a href="#cb33-818" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.left =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb33-819"><a href="#cb33-819" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb33-820"><a href="#cb33-820" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-821"><a href="#cb33-821" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-822"><a href="#cb33-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-823"><a href="#cb33-823" aria-hidden="true" tabindex="-1"></a>The other advantage of MFH estimation is the smoothing of the model estimates over the unit variate model. We can show this below as well:</span>
<span id="cb33-824"><a href="#cb33-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-827"><a href="#cb33-827" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-828"><a href="#cb33-828" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-829"><a href="#cb33-829" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb33-830"><a href="#cb33-830" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 20</span></span>
<span id="cb33-831"><a href="#cb33-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-832"><a href="#cb33-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-833"><a href="#cb33-833" aria-hidden="true" tabindex="-1"></a>model2pov_dt[[year_var]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(model2pov_dt[[year_var]])</span>
<span id="cb33-834"><a href="#cb33-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-835"><a href="#cb33-835" aria-hidden="true" tabindex="-1"></a><span class="do">## first lets merge in the results of the eblupUFH model</span></span>
<span id="cb33-836"><a href="#cb33-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-837"><a href="#cb33-837" aria-hidden="true" tabindex="-1"></a>ufh_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-838"><a href="#cb33-838" aria-hidden="true" tabindex="-1"></a>  model0_obj<span class="sc">$</span>eblup <span class="sc">|&gt;</span></span>
<span id="cb33-839"><a href="#cb33-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb33-840"><a href="#cb33-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb33-841"><a href="#cb33-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb33-842"><a href="#cb33-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb33-843"><a href="#cb33-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb33-844"><a href="#cb33-844" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"ufh_povrate"</span></span>
<span id="cb33-845"><a href="#cb33-845" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-846"><a href="#cb33-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-847"><a href="#cb33-847" aria-hidden="true" tabindex="-1"></a>model2pov_dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(model2pov_dt,</span>
<span id="cb33-848"><a href="#cb33-848" aria-hidden="true" tabindex="-1"></a>                      ufh_dt,</span>
<span id="cb33-849"><a href="#cb33-849" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by =</span> <span class="fu">c</span>(area_vars[[<span class="dv">1</span>]], year_var))</span>
<span id="cb33-850"><a href="#cb33-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-851"><a href="#cb33-851" aria-hidden="true" tabindex="-1"></a><span class="do">## now we make a similar plot but comparing the UFH vs MFH model estimates to check for the smoothness of the estimation </span></span>
<span id="cb33-852"><a href="#cb33-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-853"><a href="#cb33-853" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute max values for scaling</span></span>
<span id="cb33-854"><a href="#cb33-854" aria-hidden="true" tabindex="-1"></a>max_n <span class="ot">&lt;-</span> <span class="fu">max</span>(model2pov_dt<span class="sc">$</span>N, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-855"><a href="#cb33-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-856"><a href="#cb33-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-857"><a href="#cb33-857" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model2pov_dt, <span class="fu">aes</span>(<span class="at">x =</span> .data[[year_var]])) <span class="sc">+</span></span>
<span id="cb33-858"><a href="#cb33-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ufh_povrate, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"UFH Poverty"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb33-859"><a href="#cb33-859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> modelpov, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"MFH Poverty"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb33-860"><a href="#cb33-860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> N <span class="sc">/</span> max_n, <span class="at">color =</span> <span class="st">"Sample Size (N)"</span>),</span>
<span id="cb33-861"><a href="#cb33-861" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb33-862"><a href="#cb33-862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(.data[[area_vars[[<span class="dv">1</span>]]]]), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb33-863"><a href="#cb33-863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb33-864"><a href="#cb33-864" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Poverty Rates"</span>,</span>
<span id="cb33-865"><a href="#cb33-865" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">*</span> max_n, <span class="at">name =</span> <span class="st">"Sample Size (N)"</span>)</span>
<span id="cb33-866"><a href="#cb33-866" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-867"><a href="#cb33-867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"UFH Poverty"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>,</span>
<span id="cb33-868"><a href="#cb33-868" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"MFH Poverty"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>,</span>
<span id="cb33-869"><a href="#cb33-869" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Sample Size (N)"</span> <span class="ot">=</span> <span class="st">"grey40"</span>)) <span class="sc">+</span></span>
<span id="cb33-870"><a href="#cb33-870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb33-871"><a href="#cb33-871" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-872"><a href="#cb33-872" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb33-873"><a href="#cb33-873" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb33-874"><a href="#cb33-874" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"grey40"</span>),</span>
<span id="cb33-875"><a href="#cb33-875" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y.left =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb33-876"><a href="#cb33-876" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb33-877"><a href="#cb33-877" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-878"><a href="#cb33-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-879"><a href="#cb33-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-880"><a href="#cb33-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-881"><a href="#cb33-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-882"><a href="#cb33-882" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-883"><a href="#cb33-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-884"><a href="#cb33-884" aria-hidden="true" tabindex="-1"></a>It can be seen from the plots that the provinces in with the highest variance in UFH poverty estimates tend to provide smoother MFH estimates particularly in the provinces with smaller samples. This shows the power of the MFH approach in taking advantage of the across year correlation of poverty.</span>
<span id="cb33-885"><a href="#cb33-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-886"><a href="#cb33-886" aria-hidden="true" tabindex="-1"></a>Next we will assume our model errors were normally distributed in order to show how to statistically test to see if poverty has changed between given years.</span>
<span id="cb33-887"><a href="#cb33-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-888"><a href="#cb33-888" aria-hidden="true" tabindex="-1"></a><span class="fu">### Did the poverty rates change over time?</span></span>
<span id="cb33-889"><a href="#cb33-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-890"><a href="#cb33-890" aria-hidden="true" tabindex="-1"></a>Next we can call the <span class="in">`pbmcpeMFH2()`</span> function, which returns the EBLUP, as well as, the MSEs of the EBLUPs for each time point, and the MCPEs for each pair of time points based on the MFH model 2 as follows:</span>
<span id="cb33-891"><a href="#cb33-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-892"><a href="#cb33-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pbmcpeMFH2-est}</span></span>
<span id="cb33-893"><a href="#cb33-893" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-894"><a href="#cb33-894" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-895"><a href="#cb33-895" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb33-896"><a href="#cb33-896" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(pbmcpeMFH2)</span>
<span id="cb33-897"><a href="#cb33-897" aria-hidden="true" tabindex="-1"></a>mcpemfh2_obj <span class="ot">&lt;-</span> </span>
<span id="cb33-898"><a href="#cb33-898" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pbmcpeMFH2</span>(<span class="at">formula =</span> mfh_formula,</span>
<span id="cb33-899"><a href="#cb33-899" aria-hidden="true" tabindex="-1"></a>           <span class="at">vardir =</span> varcols,</span>
<span id="cb33-900"><a href="#cb33-900" aria-hidden="true" tabindex="-1"></a>           <span class="at">nB =</span> <span class="dv">50</span>,</span>
<span id="cb33-901"><a href="#cb33-901" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> mfh_dt, </span>
<span id="cb33-902"><a href="#cb33-902" aria-hidden="true" tabindex="-1"></a>           <span class="at">MAXITER =</span> <span class="fl">1e10</span>, </span>
<span id="cb33-903"><a href="#cb33-903" aria-hidden="true" tabindex="-1"></a>           <span class="at">PRECISION =</span> <span class="fl">1e-2</span>)</span>
<span id="cb33-904"><a href="#cb33-904" aria-hidden="true" tabindex="-1"></a>bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(mcpemfh2_obj, <span class="at">type =</span> <span class="st">"rds"</span>)</span>
<span id="cb33-905"><a href="#cb33-905" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb33-906"><a href="#cb33-906" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-907"><a href="#cb33-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-908"><a href="#cb33-908" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pbmcpeMFH2-load}</span></span>
<span id="cb33-909"><a href="#cb33-909" aria-hidden="true" tabindex="-1"></a>mcpemfh2_obj <span class="ot">&lt;-</span> bd_clean <span class="sc">|&gt;</span> <span class="fu">pin_read</span>(<span class="st">"mcpemfh2_obj"</span>)</span>
<span id="cb33-910"><a href="#cb33-910" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-911"><a href="#cb33-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-914"><a href="#cb33-914" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-915"><a href="#cb33-915" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function to compare and plot differences from the mcpe object</span></span>
<span id="cb33-916"><a href="#cb33-916" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb33-917"><a href="#cb33-917" aria-hidden="true" tabindex="-1"></a>compare_mfh2 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">period_list =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb33-918"><a href="#cb33-918" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mcpe_obj =</span> mcpemfh2_obj,</span>
<span id="cb33-919"><a href="#cb33-919" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb33-920"><a href="#cb33-920" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-921"><a href="#cb33-921" aria-hidden="true" tabindex="-1"></a>  col_chr <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"("</span>, period_list[<span class="dv">1</span>], <span class="st">","</span>, period_list[<span class="dv">2</span>], <span class="st">")"</span>)</span>
<span id="cb33-922"><a href="#cb33-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-923"><a href="#cb33-923" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> </span>
<span id="cb33-924"><a href="#cb33-924" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">diff =</span> mcpe_obj<span class="sc">$</span>eblup[,period_list[<span class="dv">2</span>]] <span class="sc">-</span> mcpe_obj<span class="sc">$</span>eblup[,period_list[<span class="dv">1</span>]],</span>
<span id="cb33-925"><a href="#cb33-925" aria-hidden="true" tabindex="-1"></a>           <span class="at">mse =</span> mcpe_obj<span class="sc">$</span>mse[,period_list[<span class="dv">1</span>]] <span class="sc">+</span> mcpe_obj<span class="sc">$</span>mse[,period_list[<span class="dv">2</span>]] <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>mcpe_obj<span class="sc">$</span>mcpe[,col_chr],</span>
<span id="cb33-926"><a href="#cb33-926" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fu">rep</span>(alpha, <span class="fu">nrow</span>(mcpe_obj<span class="sc">$</span>eblup)),</span>
<span id="cb33-927"><a href="#cb33-927" aria-hidden="true" tabindex="-1"></a>           <span class="at">zq =</span> <span class="fu">qnorm</span>(alpha <span class="sc">/</span> <span class="dv">2</span>, <span class="at">lower.tail =</span> F)) <span class="sc">|&gt;</span></span>
<span id="cb33-928"><a href="#cb33-928" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lb =</span> diff <span class="sc">-</span> zq <span class="sc">*</span> <span class="fu">sqrt</span>(mse),</span>
<span id="cb33-929"><a href="#cb33-929" aria-hidden="true" tabindex="-1"></a>           <span class="at">ub =</span> diff <span class="sc">+</span> zq <span class="sc">*</span> <span class="fu">sqrt</span>(mse)) <span class="sc">|&gt;</span></span>
<span id="cb33-930"><a href="#cb33-930" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">significant =</span> <span class="fu">ifelse</span>(lb <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span> ub <span class="sc">&lt;</span> <span class="dv">0</span>, </span>
<span id="cb33-931"><a href="#cb33-931" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Significant"</span>, </span>
<span id="cb33-932"><a href="#cb33-932" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Not Significant"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-933"><a href="#cb33-933" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">index =</span> <span class="fu">row_number</span>())</span>
<span id="cb33-934"><a href="#cb33-934" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-935"><a href="#cb33-935" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> </span>
<span id="cb33-936"><a href="#cb33-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb33-937"><a href="#cb33-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb33-938"><a href="#cb33-938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lb, <span class="at">ymax =</span> ub, <span class="at">color =</span> significant), <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb33-939"><a href="#cb33-939" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb33-940"><a href="#cb33-940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Significant"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Not Significant"</span> <span class="ot">=</span> <span class="st">"gray40"</span>)) <span class="sc">+</span></span>
<span id="cb33-941"><a href="#cb33-941" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb33-942"><a href="#cb33-942" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Area (Index)"</span>,</span>
<span id="cb33-943"><a href="#cb33-943" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Difference between time periods"</span>,</span>
<span id="cb33-944"><a href="#cb33-944" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Significance"</span>,</span>
<span id="cb33-945"><a href="#cb33-945" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Change in Poverty Rates based on MCPE between period "</span>, </span>
<span id="cb33-946"><a href="#cb33-946" aria-hidden="true" tabindex="-1"></a>                   period_list[<span class="dv">1</span>], </span>
<span id="cb33-947"><a href="#cb33-947" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" and "</span>, </span>
<span id="cb33-948"><a href="#cb33-948" aria-hidden="true" tabindex="-1"></a>                   period_list[<span class="dv">2</span>])</span>
<span id="cb33-949"><a href="#cb33-949" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-950"><a href="#cb33-950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb33-951"><a href="#cb33-951" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-952"><a href="#cb33-952" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-953"><a href="#cb33-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">df =</span> df,</span>
<span id="cb33-954"><a href="#cb33-954" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot =</span> p1))</span>
<span id="cb33-955"><a href="#cb33-955" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-956"><a href="#cb33-956" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-957"><a href="#cb33-957" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-958"><a href="#cb33-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-959"><a href="#cb33-959" aria-hidden="true" tabindex="-1"></a>The above function takes the difference between any two time periods and prepares a table of differences for each area include the MCPE estimated error rates as well as lower and upper bounds given a specified confidence level. See the function implemented to compare periods 1 and 2 (years 2012 and 2013)</span>
<span id="cb33-960"><a href="#cb33-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-963"><a href="#cb33-963" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-964"><a href="#cb33-964" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-965"><a href="#cb33-965" aria-hidden="true" tabindex="-1"></a>comp12_obj <span class="ot">&lt;-</span> <span class="fu">compare_mfh2</span>()</span>
<span id="cb33-966"><a href="#cb33-966" aria-hidden="true" tabindex="-1"></a>comp23_obj <span class="ot">&lt;-</span> <span class="fu">compare_mfh2</span>(<span class="at">period_list =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb33-967"><a href="#cb33-967" aria-hidden="true" tabindex="-1"></a>comp13_obj <span class="ot">&lt;-</span> <span class="fu">compare_mfh2</span>(<span class="at">period_list =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb33-968"><a href="#cb33-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-969"><a href="#cb33-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-970"><a href="#cb33-970" aria-hidden="true" tabindex="-1"></a>See the plots below</span>
<span id="cb33-971"><a href="#cb33-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-974"><a href="#cb33-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-975"><a href="#cb33-975" aria-hidden="true" tabindex="-1"></a>comp12_obj<span class="sc">$</span>plot</span>
<span id="cb33-976"><a href="#cb33-976" aria-hidden="true" tabindex="-1"></a>comp23_obj<span class="sc">$</span>plot</span>
<span id="cb33-977"><a href="#cb33-977" aria-hidden="true" tabindex="-1"></a>comp13_obj<span class="sc">$</span>plot</span>
<span id="cb33-978"><a href="#cb33-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-979"><a href="#cb33-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-980"><a href="#cb33-980" aria-hidden="true" tabindex="-1"></a>See the data created</span>
<span id="cb33-981"><a href="#cb33-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-982"><a href="#cb33-982" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Comparing the years 2012 and 2013</span>
<span id="cb33-983"><a href="#cb33-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-986"><a href="#cb33-986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-987"><a href="#cb33-987" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-988"><a href="#cb33-988" aria-hidden="true" tabindex="-1"></a>comp12_obj<span class="sc">$</span>df <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span>
<span id="cb33-989"><a href="#cb33-989" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-990"><a href="#cb33-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-991"><a href="#cb33-991" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Comparing the years 2013 and 2014</span>
<span id="cb33-992"><a href="#cb33-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-995"><a href="#cb33-995" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-996"><a href="#cb33-996" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-997"><a href="#cb33-997" aria-hidden="true" tabindex="-1"></a>comp23_obj<span class="sc">$</span>df <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span>
<span id="cb33-998"><a href="#cb33-998" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-999"><a href="#cb33-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1000"><a href="#cb33-1000" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Comparing the years 2012 and 2014</span>
<span id="cb33-1001"><a href="#cb33-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1004"><a href="#cb33-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-1005"><a href="#cb33-1005" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-1006"><a href="#cb33-1006" aria-hidden="true" tabindex="-1"></a>comp13_obj<span class="sc">$</span>df <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span>
<span id="cb33-1007"><a href="#cb33-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1008"><a href="#cb33-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1009"><a href="#cb33-1009" aria-hidden="true" tabindex="-1"></a><span class="fu">### Presenting Results</span></span>
<span id="cb33-1010"><a href="#cb33-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1011"><a href="#cb33-1011" aria-hidden="true" tabindex="-1"></a>Now that we have estimated the MFH models and run some diagnostics, we might be interested in the following:</span>
<span id="cb33-1012"><a href="#cb33-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1013"><a href="#cb33-1013" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>presenting some poverty maps</span>
<span id="cb33-1014"><a href="#cb33-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1017"><a href="#cb33-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-1018"><a href="#cb33-1018" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-1019"><a href="#cb33-1019" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb33-1020"><a href="#cb33-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb33-1021"><a href="#cb33-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1022"><a href="#cb33-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="at">X =</span> <span class="fu">unique</span>(survey_dt[[year_var]]),</span>
<span id="cb33-1023"><a href="#cb33-1023" aria-hidden="true" tabindex="-1"></a>       <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-1024"><a href="#cb33-1024" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb33-1025"><a href="#cb33-1025" aria-hidden="true" tabindex="-1"></a>         shp_dt <span class="sc">|&gt;</span></span>
<span id="cb33-1026"><a href="#cb33-1026" aria-hidden="true" tabindex="-1"></a>           <span class="fu">merge</span>(model2pov_dt <span class="sc">%&gt;%</span> </span>
<span id="cb33-1027"><a href="#cb33-1027" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(year_var) <span class="sc">==</span> x) <span class="sc">|&gt;</span></span>
<span id="cb33-1028"><a href="#cb33-1028" aria-hidden="true" tabindex="-1"></a>                   dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]), <span class="st">"modelpov"</span>),</span>
<span id="cb33-1029"><a href="#cb33-1029" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> area_vars[[<span class="dv">1</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb33-1030"><a href="#cb33-1030" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb33-1031"><a href="#cb33-1031" aria-hidden="true" tabindex="-1"></a>           <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> modelpov), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb33-1032"><a href="#cb33-1032" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb33-1033"><a href="#cb33-1033" aria-hidden="true" tabindex="-1"></a>              <span class="at">name =</span> <span class="st">"Poverty Map"</span>,</span>
<span id="cb33-1034"><a href="#cb33-1034" aria-hidden="true" tabindex="-1"></a>              <span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb33-1035"><a href="#cb33-1035" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">+</span></span>
<span id="cb33-1036"><a href="#cb33-1036" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-1037"><a href="#cb33-1037" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(</span>
<span id="cb33-1038"><a href="#cb33-1038" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Spatial Distribution of Poverty "</span>, x),</span>
<span id="cb33-1039"><a href="#cb33-1039" aria-hidden="true" tabindex="-1"></a>              <span class="at">caption =</span> <span class="st">"Data source: Author Calculation"</span></span>
<span id="cb33-1040"><a href="#cb33-1040" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">+</span></span>
<span id="cb33-1041"><a href="#cb33-1041" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(</span>
<span id="cb33-1042"><a href="#cb33-1042" aria-hidden="true" tabindex="-1"></a>              <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb33-1043"><a href="#cb33-1043" aria-hidden="true" tabindex="-1"></a>              <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-1044"><a href="#cb33-1044" aria-hidden="true" tabindex="-1"></a>              <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-1045"><a href="#cb33-1045" aria-hidden="true" tabindex="-1"></a>              <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb33-1046"><a href="#cb33-1046" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-1047"><a href="#cb33-1047" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb33-1048"><a href="#cb33-1048" aria-hidden="true" tabindex="-1"></a>       }) <span class="sc">|&gt;</span></span>
<span id="cb33-1049"><a href="#cb33-1049" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="at">f =</span> <span class="st">"+"</span>)</span>
<span id="cb33-1050"><a href="#cb33-1050" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-1051"><a href="#cb33-1051" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-1052"><a href="#cb33-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1053"><a href="#cb33-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1054"><a href="#cb33-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1055"><a href="#cb33-1055" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>quantifying poverty change by mapping the growth rates of poverty rates for all the time periods</span>
<span id="cb33-1056"><a href="#cb33-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1059"><a href="#cb33-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-1060"><a href="#cb33-1060" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-1061"><a href="#cb33-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1062"><a href="#cb33-1062" aria-hidden="true" tabindex="-1"></a><span class="do">### lets work with our shapefile</span></span>
<span id="cb33-1063"><a href="#cb33-1063" aria-hidden="true" tabindex="-1"></a>longpov_dt <span class="ot">&lt;-</span> </span>
<span id="cb33-1064"><a href="#cb33-1064" aria-hidden="true" tabindex="-1"></a>  model2_obj<span class="sc">$</span>eblup <span class="sc">|&gt;</span></span>
<span id="cb33-1065"><a href="#cb33-1065" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]]) <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb33-1066"><a href="#cb33-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb33-1067"><a href="#cb33-1067" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"direct_povrate"</span>),</span>
<span id="cb33-1068"><a href="#cb33-1068" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb33-1069"><a href="#cb33-1069" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"direct_povrate(</span><span class="sc">\\</span><span class="st">d+)"</span>,  <span class="co"># Extract just the digits</span></span>
<span id="cb33-1070"><a href="#cb33-1070" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"modelpov"</span></span>
<span id="cb33-1071"><a href="#cb33-1071" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-1072"><a href="#cb33-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1073"><a href="#cb33-1073" aria-hidden="true" tabindex="-1"></a><span class="do">### lets perform a regression for each area of poverty rates against year </span></span>
<span id="cb33-1074"><a href="#cb33-1074" aria-hidden="true" tabindex="-1"></a><span class="do">### and then we divide the slope variable by the average poverty rate</span></span>
<span id="cb33-1075"><a href="#cb33-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1076"><a href="#cb33-1076" aria-hidden="true" tabindex="-1"></a>shp_dt<span class="sc">$</span>growth_rate <span class="ot">&lt;-</span> </span>
<span id="cb33-1077"><a href="#cb33-1077" aria-hidden="true" tabindex="-1"></a>longpov_dt <span class="sc">|&gt;</span></span>
<span id="cb33-1078"><a href="#cb33-1078" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(year_var) <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(<span class="sc">!!</span><span class="fu">sym</span>(year_var))) <span class="sc">|&gt;</span></span>
<span id="cb33-1079"><a href="#cb33-1079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_split</span>(<span class="sc">!!</span><span class="fu">sym</span>(area_vars[[<span class="dv">1</span>]])) <span class="sc">%&gt;%</span></span>
<span id="cb33-1080"><a href="#cb33-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="at">X =</span> .,</span>
<span id="cb33-1081"><a href="#cb33-1081" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb33-1082"><a href="#cb33-1082" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb33-1083"><a href="#cb33-1083" aria-hidden="true" tabindex="-1"></a>           y <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">paste0</span>(<span class="st">"modelpov ~ "</span>, year_var[[<span class="dv">1</span>]]), <span class="at">data =</span> x)</span>
<span id="cb33-1084"><a href="#cb33-1084" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb33-1085"><a href="#cb33-1085" aria-hidden="true" tabindex="-1"></a>           y <span class="ot">&lt;-</span> <span class="fu">coef</span>(y)[<span class="dv">2</span>]</span>
<span id="cb33-1086"><a href="#cb33-1086" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb33-1087"><a href="#cb33-1087" aria-hidden="true" tabindex="-1"></a>           delta <span class="ot">&lt;-</span> y <span class="sc">/</span> (<span class="fu">mean</span>(x<span class="sc">$</span>modelpov, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb33-1088"><a href="#cb33-1088" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb33-1089"><a href="#cb33-1089" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span>(delta)</span>
<span id="cb33-1090"><a href="#cb33-1090" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb33-1091"><a href="#cb33-1091" aria-hidden="true" tabindex="-1"></a>         }) <span class="sc">|&gt;</span></span>
<span id="cb33-1092"><a href="#cb33-1092" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-1093"><a href="#cb33-1093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>()</span>
<span id="cb33-1094"><a href="#cb33-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1095"><a href="#cb33-1095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1096"><a href="#cb33-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1097"><a href="#cb33-1097" aria-hidden="true" tabindex="-1"></a>Lets plot this like with a heatmap on a shapefile:</span>
<span id="cb33-1098"><a href="#cb33-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1101"><a href="#cb33-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-1102"><a href="#cb33-1102" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb33-1103"><a href="#cb33-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1104"><a href="#cb33-1104" aria-hidden="true" tabindex="-1"></a><span class="co"># Cap growth rates at 1 just to get rid of the outlier</span></span>
<span id="cb33-1105"><a href="#cb33-1105" aria-hidden="true" tabindex="-1"></a>shp_dt<span class="sc">$</span>growth_rate_capped <span class="ot">&lt;-</span> <span class="fu">pmin</span>(shp_dt<span class="sc">$</span>growth_rate, <span class="dv">1</span>)</span>
<span id="cb33-1106"><a href="#cb33-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1107"><a href="#cb33-1107" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(shp_dt) <span class="sc">+</span></span>
<span id="cb33-1108"><a href="#cb33-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> growth_rate_capped), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb33-1109"><a href="#cb33-1109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb33-1110"><a href="#cb33-1110" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Growth Rate (capped at 1)"</span>,</span>
<span id="cb33-1111"><a href="#cb33-1111" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(shp_dt<span class="sc">$</span>growth_rate_capped), <span class="fl">0.5</span>),</span>
<span id="cb33-1112"><a href="#cb33-1112" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> squish,</span>
<span id="cb33-1113"><a href="#cb33-1113" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb33-1114"><a href="#cb33-1114" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-1115"><a href="#cb33-1115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-1116"><a href="#cb33-1116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb33-1117"><a href="#cb33-1117" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spatial Distribution of Poverty Growth Rates"</span>,</span>
<span id="cb33-1118"><a href="#cb33-1118" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Growth rates capped at 1 to reduce outlier effect"</span>,</span>
<span id="cb33-1119"><a href="#cb33-1119" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Data source: Author Calculation"</span></span>
<span id="cb33-1120"><a href="#cb33-1120" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-1121"><a href="#cb33-1121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb33-1122"><a href="#cb33-1122" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb33-1123"><a href="#cb33-1123" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-1124"><a href="#cb33-1124" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-1125"><a href="#cb33-1125" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb33-1126"><a href="#cb33-1126" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-1127"><a href="#cb33-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1128"><a href="#cb33-1128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>